<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <title>è¯èªè²ªé£Ÿè›‡</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=Gaegu:wght@400;700&display=swap'); /* Handwriting font */

        :root {
            /* æŸ”å’Œè‰²èª¿ Palette */
            --primary-color: #F4A261;   /* Soft Orange/Coral */
            --secondary-color: #2A9D8F; /* Sage Green */
            --accent-color: #E76F51;    /* Terra Cotta */
            --bg-color: #FDF6E3;        /* Warm Cream */
            --text-color: #264653;      /* Dark Slate Blue */
            --card-bg: #FFFFFF;         
            --locked-color: #999;       /* Locked score color */
        }

        body {
            font-family: 'Noto Sans TC', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh; 
            overflow: hidden;
            touch-action: none;
            user-select: none;
            background-image: radial-gradient(#E0E0E0 1px, transparent 1px);
            background-size: 20px 20px;
        }

        h1 {
            color: var(--secondary-color);
            margin: 5px 0 10px 0;
            font-size: 2.2rem; 
            text-align: center;
            font-family: 'Gaegu', cursive, 'Noto Sans TC', sans-serif;
        }

        #game-container {
            position: relative;
            background: var(--card-bg);
            padding: 12px;
            border-radius: 20px;
            box-shadow: 0 10px 20px rgba(38, 70, 83, 0.15);
            border: 6px solid #FFF;
            width: 95%;
            max-width: 600px; 
            box-sizing: border-box;
        }

        canvas {
            background-color: #FFFFFF;
            border: 3px solid var(--secondary-color);
            border-radius: 12px;
            display: block;
            touch-action: none;
            box-shadow: inset 0 0 20px rgba(0,0,0,0.02);
            width: 100%; 
            height: auto; 
            aspect-ratio: 1 / 1; 
        }

        #ui-layer {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 20;
        }

        .screen {
            background: rgba(255, 255, 255, 0.98);
            padding: 20px; 
            border-radius: 20px;
            text-align: center;
            pointer-events: auto;
            width: 90%; 
            max-width: 450px; 
            max-height: 96%; 
            overflow-y: auto; 
            box-shadow: 0 15px 30px rgba(38, 70, 83, 0.2);
            border: 4px solid var(--primary-color);
            display: flex;
            flex-direction: column;
            gap: 10px; 
            animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            align-items: center; 
        }
        
        #leaderboard-modal {
            position: fixed; 
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 90%;
            max-width: 600px; 
            max-height: 90vh;
            z-index: 1000;
            background: #FFF;
            border: 5px solid var(--secondary-color);
            padding: 25px;
            border-radius: 25px;
            box-shadow: 0 20px 50px rgba(0,0,0,0.25);
        }
        
        .modal-backdrop {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(38, 70, 83, 0.4);
            backdrop-filter: blur(4px);
            z-index: 999;
        }

        @keyframes popIn {
            from { transform: scale(0.8); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }

        @keyframes popInFixed {
            from { transform: translate(-50%, -50%) scale(0.8); opacity: 0; }
            to { transform: translate(-50%, -50%) scale(1); opacity: 1; }
        }

        .hidden {
            display: none !important;
        }

        button {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 12px 24px; 
            font-size: 1.1rem; 
            border-radius: 30px;
            cursor: pointer;
            font-family: 'Noto Sans TC', sans-serif;
            font-weight: bold;
            margin: 5px; 
            transition: all 0.1s;
            box-shadow: 0 4px 0 rgba(0,0,0,0.1);
            white-space: nowrap;
        }

        button:active {
            transform: translateY(2px);
            box-shadow: 0 2px 0 rgba(0,0,0,0.1);
        }

        button.secondary {
            background-color: var(--secondary-color);
        }
        
        button.danger {
            background-color: var(--accent-color);
        }

        button.control-btn {
            background: #fff;
            color: var(--text-color);
            border: 2px solid var(--text-color);
            padding: 8px 14px;
            font-size: 1.4rem; 
            min-width: 50px;
            box-shadow: none;
        }
        
        #top-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
            max-width: 600px; 
            margin-bottom: 8px;
            padding: 0 5px;
            box-sizing: border-box;
        }

        #score-info {
            font-weight: bold;
            color: var(--text-color);
            display: flex;
            flex-direction: column;
            font-size: 1.1rem; 
            line-height: 1.4;
        }
        
        #lives {
            color: var(--accent-color); 
            font-size: 1.4rem; 
            letter-spacing: 3px;
        }

        #level-info {
            color: var(--accent-color);
            font-weight: bold;
            transition: transform 0.2s;
            display: inline-block;
        }

        #progress-container {
            font-size: 0.95rem;
            color: #7D8597;
            margin-top: 2px;
        }
        
        #progress-current {
            color: var(--secondary-color);
            font-weight: bold;
            font-size: 1.1rem;
        }

        #current-sentence-display {
            margin-top: 15px; 
            margin-bottom: 5px;
            min-height: 70px; 
            padding: 12px 20px;
            background: #fff;
            border-radius: 15px;
            border: 3px dashed var(--secondary-color);
            width: 95%; 
            max-width: 600px; 
            text-align: center;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.6rem; 
            color: #ccc; 
            font-weight: bold;
            line-height: 1.5;
            flex-wrap: wrap;
            position: relative;
            box-shadow: 0 5px 10px rgba(0,0,0,0.08);
            box-sizing: border-box;
        }
        
        #replay-btn {
            position: absolute;
            right: -12px;
            top: -12px;
            background: var(--secondary-color);
            border-radius: 50%;
            width: 40px; 
            height: 40px;
            padding: 0;
            font-size: 1.2rem;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 3px 6px rgba(0,0,0,0.15);
            border: 2px solid #fff;
        }

        .char-eaten { color: var(--secondary-color); transition: color 0.3s; }
        .char-current { color: var(--accent-color); text-decoration: underline; font-size: 2.0rem; font-weight: 900; } 
        .char-pending { color: #BBB; }

        select, input[type="text"] {
            padding: 12px 16px; 
            font-size: 1.1rem; 
            border-radius: 12px;
            border: 2px solid var(--secondary-color);
            margin-bottom: 5px; 
            font-family: 'Noto Sans TC', sans-serif;
            width: 100%;
            box-sizing: border-box;
            background: #F4F1DE; 
            outline: none;
            color: var(--text-color);
        }
        
        select:focus, input:focus {
            border-color: var(--primary-color);
        }
        
        #online-status-bar {
            width: 100%;
            max-width: 600px; 
            margin-bottom: 10px;
            font-size: 1rem;
            color: #555;
            background: rgba(255,255,255,0.8);
            padding: 8px 15px;
            border-radius: 20px;
            box-sizing: border-box;
            white-space: nowrap;
            overflow-x: auto; 
            overflow-y: hidden;
            text-overflow: unset; 
            text-align: left;
            border: 2px solid #FFF;
            box-shadow: 0 3px 8px rgba(0,0,0,0.05);
            -webkit-overflow-scrolling: touch; 
            scrollbar-width: none; 
        }
        #online-status-bar::-webkit-scrollbar {
            display: none; 
        }
        
        .leaderboard-container {
            width: 100%;
            max-height: 400px; 
            overflow-y: auto;
            margin: 15px 0;
            border: 1px solid #eee;
            border-radius: 10px;
            box-shadow: inset 0 2px 5px rgba(0,0,0,0.05);
        }
        
        table.leaderboard-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 1.05rem; 
        }
        
        table.leaderboard-table th {
            background-color: var(--secondary-color);
            color: white;
            padding: 12px;
            position: sticky;
            top: 0;
            font-weight: bold;
        }
        
        table.leaderboard-table td {
            padding: 12px 10px;
            border-bottom: 1px solid #eee;
            text-align: center;
            color: var(--text-color);
        }

        table.leaderboard-table tr:nth-child(even) { background-color: #f9f9f9; }
        
        /* New CSS for centering pause overlay */
        #pause-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 15;
            background-color: rgba(255, 255, 255, 0.3);
            backdrop-filter: blur(2px);
        }

        .pause-text {
            font-size: 3.5rem; 
            font-weight: bold;
            color: var(--text-color);
            text-shadow: 2px 2px white;
            background: rgba(255, 255, 255, 0.9);
            padding: 15px 40px;
            border-radius: 25px;
            border: 4px solid var(--primary-color);
        }

        .footer {
            margin-top: 25px;
            color: #888;
            font-size: 0.9rem;
            font-weight: bold;
            letter-spacing: 1px;
            opacity: 0.7;
        }

        #toast {
            visibility: hidden;
            min-width: 250px;
            background-color: var(--text-color);
            color: #fff;
            text-align: center;
            border-radius: 25px;
            padding: 15px 25px;
            position: fixed;
            z-index: 100;
            left: 50%;
            transform: translateX(-50%);
            bottom: 30px;
            font-size: 1.1rem;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
            opacity: 0;
            transition: opacity 0.3s, bottom 0.3s;
        }

        #toast.show { visibility: visible; opacity: 1; bottom: 50px; }
        
        /* Revived score animation */
        .locked-score {
            color: var(--locked-color) !important;
            text-decoration: line-through;
            opacity: 0.7;
        }

        @media (max-width: 600px) {
            h1 { font-size: 1.5rem; }
            #current-sentence-display { font-size: 1.3rem; }
            table.leaderboard-table { font-size: 0.85rem; }
        }
    </style>
</head>
<body>

    <div id="backdrop" class="modal-backdrop hidden"></div>

    <h1>ğŸ è¯èªè²ªé£Ÿè›‡ ğŸ</h1>

    <div id="top-controls">
        <div id="score-info">
            <div>å¾—åˆ†: <span id="score-display"><span id="score">0</span></span> &nbsp;|&nbsp; <span id="level-info">é—œå¡: 1</span></div>
            <div id="progress-container">ç¸½é€²åº¦: <span id="progress-current">0</span> / <span id="progress-total">0</span></div>
            <div id="lives">â¤ï¸â¤ï¸â¤ï¸</div>
        </div>
        <div style="display: flex; gap: 5px;">
            <button class="control-btn" id="sound-btn" onclick="toggleSound()" title="è²éŸ³é–‹é—œ">ğŸ”Š</button>
            <button class="control-btn" id="pause-btn" onclick="togglePause()" title="æš«åœéŠæˆ²">â¸ï¸</button>
            <button class="control-btn" id="exit-btn" onclick="triggerQuit()" title="å›åˆ°é¦–é ">ğŸ </button>
        </div>
    </div>

    <div id="online-status-bar">ğŸŸ¢ é€£ç·šä¸­...</div>

    <div id="game-container">
        <canvas id="gameCanvas" width="600" height="600"></canvas>
        
        <div id="pause-overlay" class="hidden">
            <div class="pause-text">æš«åœ</div>
        </div>

        <div id="ui-layer">
            <div id="start-screen" class="screen">
                <h2 id="start-title" style="margin: 0 0 10px 0; color: var(--primary-color); font-size: 1.8rem;">æº–å‚™å¥½äº†å—ï¼Ÿ</h2>
                <label for="player-name" style="font-size: 1rem; font-weight: bold; color:#555; align-self: start; margin-left: 5px;">ä½ çš„åå­—ï¼š</label>
                <input type="text" id="player-name" placeholder="è«‹è¼¸å…¥åå­— (ä¾‹å¦‚: å°ç¾)" maxlength="8">
                
                <label for="speed-select" style="font-size: 1rem; font-weight: bold; color:#555; align-self: start; margin-left: 5px; margin-top: 5px;">éŠæˆ²é€Ÿåº¦ï¼š</label>
                <select id="speed-select">
                    <option value="2.5" selected>ğŸ¢ æ…¢æ…¢çš„ (é©åˆåˆå­¸)</option>
                    <option value="4">ğŸ‡ æ™®é€šé€Ÿåº¦ (æœ‰é»åˆºæ¿€)</option>
                    <option value="6">ğŸ† å¿«å¿«çš„ (è¶…ç´šæŒ‘æˆ°)</option>
                </select>

                <label for="lesson-select" style="font-size: 1rem; font-weight: bold; color:#555; align-self: start; margin-left: 5px; margin-top: 5px;">é¸æ“‡èª²ç¨‹ï¼šå­¸è¯èªå‘å‰èµ° ç¬¬äºŒå†Š</label>
                <div style="display: flex; gap: 5px; width: 100%; margin-bottom: 10px;">
                    <select id="lesson-select" style="margin-bottom: 0;">
                        <option value="1">ç¬¬ 1 èª²ï¼šæ–°åŒå­¸</option>
                        <option value="2">ç¬¬ 2 èª²ï¼šæˆ‘çˆ¸çˆ¸åšç”Ÿæ„</option>
                        <option value="3">ç¬¬ 3 èª²ï¼šå»è¶…ç´šå¸‚å ´</option>
                        <option value="4">ç¬¬ 4 èª²ï¼šæˆ‘æƒ³åƒæ¼¢å ¡</option>
                        <option value="5">ç¬¬ 5 èª²ï¼šæ˜¥å¤©å¿«åˆ°äº†</option>
                        <option value="6">ç¬¬ 6 èª²ï¼šè¾²æ›†æ–°å¹´</option>
                        <option value="7">ç¬¬ 7 èª²ï¼šæ—©ä¸€é»ç¡è¦º</option>
                        <option value="8">ç¬¬ 8 èª²ï¼šæˆ‘çš„å¯µç‰©</option>
                        <option value="9">ç¬¬ 9 èª²ï¼šéŸ³æ¨‚æ•™å®¤åœ¨åŒ—æ–¹</option>
                        <option value="10">ç¬¬ 10 èª²ï¼šå¤–å…¬å¤–å©†ä½è‡ºç£</option>
                        <option value="11">ç¬¬ 11 èª²ï¼šå»å‹•ç‰©åœ’</option>
                        <option value="12">ç¬¬ 12 èª²ï¼šæ‰“ç¶²è·¯é›»è©±</option>
                        <option value="all">ğŸ“š å…¨éƒ¨è¤‡ç¿’ (1-12èª²)</option>
                    </select>
                    <button class="secondary" onclick="shareLesson()" style="margin: 0; padding: 0 20px;" title="è¤‡è£½èª²ç¨‹é€£çµ">ğŸ”—</button>
                </div>
                
                <div style="display: flex; gap: 10px; width: 100%;">
                    <button onclick="startGame()" style="flex:2;">é–‹å§‹éŠæˆ² â–¶ï¸</button>
                    <button class="secondary" onclick="showLeaderboardModal()" style="flex:1;">ğŸ† æ’è¡Œæ¦œ</button>
                </div>
                <p style="font-size: 0.9rem; color: #7D8597; margin: 15px 0 0 0;">é›»è…¦ï¼šWASD æˆ– â¬†ï¸â¬‡ï¸â¬…ï¸â¡ï¸ &nbsp;|&nbsp; å¹³æ¿ï¼šğŸ‘† æ»‘å‹•è¢å¹•</p>
            </div>

            <div id="quit-modal" class="screen hidden" style="z-index: 50;">
                <h2 style="color: var(--accent-color); margin: 0 0 10px 0;">ç¢ºå®šè¦é›¢é–‹å—ï¼Ÿ</h2>
                <p style="margin: 10px 0; font-size: 1.1rem;">ç›®å‰çš„éŠæˆ²é€²åº¦æœƒæ¶ˆå¤±å–”ï¼</p>
                <div style="display: flex; gap: 10px; justify-content: center; width: 100%;">
                    <button class="danger" onclick="confirmQuit()" style="flex: 1;">ç¢ºå®šé›¢é–‹</button>
                    <button class="secondary" onclick="cancelQuit()" style="flex: 1;">å–æ¶ˆ</button>
                </div>
            </div>

            <!-- Revive Modal -->
            <div id="revive-modal" class="screen hidden" style="z-index: 55;">
                <h2 style="color: var(--accent-color); margin: 0 0 10px 0; font-size: 1.6rem;">ğŸ’” æ„›å¿ƒç”¨å…‰äº†ï¼</h2>
                <p style="margin: 5px 0; font-size: 1.1rem;">åˆ¥æ°£é¤’ï¼Œæˆ‘å€‘æŠŠå‰©ä¸‹çš„ç·´ç¿’åšå®Œå§ï¼</p>
                <p style="color: var(--locked-color); font-size: 0.9rem; margin-bottom: 10px;">âš ï¸ æ³¨æ„ï¼šå¾©æ´»å¾Œåˆ†æ•¸å°‡åœæ­¢ç´¯ç©</p>
                <div style="margin-bottom: 15px; color: #555;">(é‚„æœ‰ <span id="revive-remaining">0</span> å€‹å¥å­)</div>
                <button onclick="reviveGame()" style="font-size: 1.2rem; padding: 12px 30px; width: 100%;">ğŸ’ª å¾©æ´»ç·´ç¿’</button>
                <button class="secondary" onclick="gameOver()" style="margin-top: 10px; font-size: 0.9rem;">çµæŸç·´ç¿’ä¸¦å­˜æª”</button>
            </div>

            <div id="lesson-complete-screen" class="screen hidden">
                <h2 style="margin: 0; color: var(--primary-color);">ğŸ‰ æ­å–œå®Œæˆï¼</h2>
                <div style="background: #f0f0f0; padding: 15px; border-radius: 15px; width: 100%; box-sizing: border-box;">
                    <p id="complete-lesson-name" style="font-size: 1.3rem; color: var(--secondary-color); font-weight: bold; margin: 5px 0;">ç¬¬ X èª²</p>
                    <p style="margin: 10px 0; font-size: 1.4rem;">ç¸½å¾—åˆ†ï¼š<span id="complete-score" style="color: var(--accent-color); font-weight: 900;">0</span></p>
                    <p id="revive-note" class="hidden" style="color: #888; font-size: 0.85rem;">(æ›¾ä½¿ç”¨å¾©æ´»æ©Ÿåˆ¶ï¼Œå¾—åˆ†å·²é–å®š)</p>
                </div>
                <div style="width:100%; margin-top:10px;">
                    <div style="font-size: 1rem; color: #555; font-weight: bold; margin-bottom: 5px;">ğŸ† æ­·å²æ’è¡Œæ¦œ</div>
                    <div class="leaderboard-container" style="max-height: 120px;">
                        <table class="leaderboard-table">
                            <tbody id="leaderboard-body-complete"></tbody>
                        </table>
                    </div>
                </div>
                <div id="lesson-nav-buttons" style="display: flex; gap: 10px; justify-content: center; width: 100%; margin-top: 10px;">
                     <button id="btn-prev-lesson" class="secondary" style="flex: 1; font-size: 1rem;">â¬…ï¸ ä¸Šä¸€èª²</button>
                     <button id="btn-next-lesson" class="secondary" style="flex: 1; font-size: 1rem;">ä¸‹ä¸€èª² â¡ï¸</button>
                </div>
                <div style="display: flex; gap: 10px; justify-content: center; width: 100%; margin-top: 5px;">
                    <button onclick="resetGame()" style="flex: 1;">å†è¤‡ç¿’ä¸€æ¬¡ ğŸ”„</button>
                    <button class="secondary" onclick="showStartScreen()" style="flex: 1;">å›é¦–é  ğŸ </button>
                </div>
            </div>

            <div id="game-over-screen" class="screen hidden">
                <h2 id="game-over-title" style="margin: 0; color: var(--text-color);">ğŸ˜² éŠæˆ²çµæŸï¼</h2>
                <div style="background: #f0f0f0; padding: 15px; border-radius: 15px; width: 100%; box-sizing: border-box;">
                    <p id="game-over-lesson" style="font-size: 1.1rem; color: #555; margin: 5px 0;"></p>
                    <p style="margin: 5px 0; font-size: 1.3rem;"><span id="game-over-name">ä½ </span>çš„æœ€çµ‚å¾—åˆ†</p>
                    <p style="margin: 0; font-size: 3rem; color: var(--accent-color); font-weight: 900; line-height: 1;"><span id="final-score">0</span></p>
                </div>
                <div style="width:100%; margin-top:10px;">
                    <div style="font-size: 1rem; color: #555; font-weight: bold; margin-bottom: 5px;">ğŸ† æ­·å²æ’è¡Œæ¦œ</div>
                    <div class="leaderboard-container" style="max-height: 120px;">
                        <table class="leaderboard-table">
                            <tbody id="leaderboard-body-gameover"></tbody>
                        </table>
                    </div>
                </div>
                <div style="display: flex; gap: 10px; justify-content: center; width: 100%; margin-top: 10px;">
                    <button onclick="resetGame()" style="flex: 1;">å†ç©ä¸€æ¬¡ ğŸ”„</button>
                    <button class="secondary" onclick="showStartScreen()" style="flex: 1;">æ›èª²æ–‡ ğŸ“–</button>
                </div>
            </div>
        </div>
    </div>

    <div id="leaderboard-modal" class="screen hidden">
        <h2 style="color: var(--secondary-color); margin: 0 0 10px 0; font-size: 1.8rem;">ğŸ† æ­·å²æ¦®è­½æ¦œ</h2>
        <div class="leaderboard-container" style="max-height: 50vh;">
            <table class="leaderboard-table">
                <thead>
                    <tr>
                        <th>åæ¬¡</th><th>åå­—</th><th>åˆ†æ•¸</th><th>èª²ç¨‹</th>
                    </tr>
                </thead>
                <tbody id="leaderboard-body-modal"></tbody>
            </table>
        </div>
        <button class="secondary" onclick="hideLeaderboardModal()" style="margin-top: 15px; min-width: 150px;">é—œé–‰</button>
    </div>

    <div id="current-sentence-display">æº–å‚™é–‹å§‹...<button id="replay-btn" onclick="replayCurrentAudio()" title="é‡è½ä¸€æ¬¡">ğŸ”Š</button></div>
    <div id="mobile-hint">ğŸ’¡ æç¤ºï¼šé †åºåƒå­—çµ„æˆå¥å­ï¼Œæ’ç‰†æœƒå¾å¦ä¸€é‚Šå‡ºä¾†</div>
    <div class="footer">Design by Sophia Wong</div>
    <div id="toast"></div>

<!-- Firebase Integration -->
<script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js';
    import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js';
    import { getFirestore, collection, doc, setDoc, addDoc, getDocs, deleteDoc, onSnapshot } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js';

   const firebaseConfig = {
  apiKey: "AIzaSyBQI17CXEhD5mJhDCid-mt0cAL6qvdcAiA",
  authDomain: "chinses-snake-game.firebaseapp.com",
  projectId: "chinses-snake-game",
  storageBucket: "chinses-snake-game.firebasestorage.app",
  messagingSenderId: "239140560404",
  appId: "1:239140560404:web:dd5ead9018a0f0e5ad5101"
};
    const rawAppId = typeof __app_id !== 'undefined' ? __app_id : 'default-app';
    const appId = rawAppId.split('/')[0].replace(/[^a-zA-Z0-9_-]/g, '_');
    
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    let currentUser = null;
    let isOffline = false;

    const initAuth = async () => {
        try {
            if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                await signInWithCustomToken(auth, __initial_auth_token);
            } else {
                await signInAnonymously(auth);
            }
        } catch (error) { activateOfflineMode(); }
    };
    initAuth();

    function activateOfflineMode() {
        isOffline = true;
        const listEl = document.getElementById('online-status-bar');
        if(listEl) listEl.innerText = "ğŸ”´ å–®æ©Ÿæ¨¡å¼ (é›²ç«¯åŠŸèƒ½æš«åœ)";
    }

    onAuthStateChanged(auth, (user) => {
        if (user) {
            currentUser = user;
            if (!isOffline) {
                startPresenceSystem(); 
                loadLeaderboard();     
            }
        }
    });

    function startPresenceSystem() {
        if (!currentUser || isOffline) return;
        const presenceCol = collection(db, 'artifacts', appId, 'public', 'data', 'presence');
        onSnapshot(presenceCol, (snapshot) => {
            const now = Date.now();
            const activeThreshold = 60 * 1000 * 5; 
            const onlineData = [];
            snapshot.forEach(doc => {
                const data = doc.data();
                if (data.name && data.lastSeen && (now - data.lastSeen < activeThreshold)) {
                    onlineData.push({ name: data.name, lesson: data.lesson || 'æº–å‚™ä¸­' });
                }
            });
            const uniquePlayers = [];
            const seenNames = new Set();
            onlineData.forEach(p => {
                if(!seenNames.has(p.name)) { seenNames.add(p.name); uniquePlayers.push(p); }
            });
            updateOnlineUI(uniquePlayers);
        }, () => activateOfflineMode());
    }

    window.sendHeartbeat = async function(name, lesson) {
        if (isOffline || !currentUser || !name) return;
        try {
            const presenceRef = doc(db, 'artifacts', appId, 'public', 'data', 'presence', currentUser.uid);
            await setDoc(presenceRef, { name, lesson, lastSeen: Date.now() }, { merge: true });
        } catch (e) { activateOfflineMode(); }
    }

    function updateOnlineUI(players) {
        const listEl = document.getElementById('online-status-bar');
        if (!listEl) return;
        if (players.length === 0) {
            listEl.innerHTML = "ğŸŸ¢ <b>åœ¨ç·šåŒå­¸ï¼š</b>ç›®å‰åªæœ‰ä½ ";
        } else {
            const html = players.map(p => `<span style="margin-right:15px; display:inline-block;">${p.name} <span style="font-size:0.8em; opacity:0.8;">(${p.lesson})</span></span>`).join('');
            listEl.innerHTML = `ğŸŸ¢ <b>åœ¨ç·šåŒå­¸ï¼š</b> ` + html;
        }
    }

    window.saveScoreToCloud = async function(name, score, lessonName) {
        if (isOffline || !currentUser) return;
        try {
            const lbCol = collection(db, 'artifacts', appId, 'public', 'data', 'leaderboard');
            await addDoc(lbCol, { name, score, lesson: lessonName, timestamp: Date.now() });
        } catch (e) { activateOfflineMode(); }
    }

    function loadLeaderboard() {
        if (isOffline) return;
        const lbCol = collection(db, 'artifacts', appId, 'public', 'data', 'leaderboard');
        onSnapshot(lbCol, (snapshot) => {
            const scores = [];
            snapshot.forEach(doc => {
                const data = doc.data();
                if (data.name && data.score != null) { scores.push(data); }
            });
            scores.sort((a, b) => b.score - a.score);
            updateLeaderboardUI(scores.slice(0, 10));
        }, () => activateOfflineMode());
    }

    function updateLeaderboardUI(scores) {
        const createRows = (limit) => {
            if (scores.length === 0) return `<tr><td colspan="4">å°šç„¡ç´€éŒ„</td></tr>`;
            return scores.slice(0, limit).map((s, i) => {
                let rank = i + 1;
                let medal = rank === 1 ? "ğŸ¥‡" : (rank === 2 ? "ğŸ¥ˆ" : (rank === 3 ? "ğŸ¥‰" : rank + "."));
                let lessonDisplay = (s.lesson || "-").match(/ç¬¬\s*\d+\s*èª²/)?.[0] || (s.lesson?.includes("å…¨éƒ¨") ? "å…¨å†Š" : s.lesson?.split('ï¼š')[0]);
                return `<tr><td>${medal}</td><td style="font-weight:bold;">${s.name}</td><td style="color:var(--accent-color); font-weight:900;">${s.score}</td><td>${lessonDisplay}</td></tr>`;
            }).join('');
        };
        document.getElementById('leaderboard-body-modal').innerHTML = createRows(20);
        document.getElementById('leaderboard-body-gameover').innerHTML = createRows(5);
        document.getElementById('leaderboard-body-complete').innerHTML = createRows(5);
    }
</script>

<script>
    // --- Audio Logic ---
    const AudioContext = window.AudioContext || window.webkitAudioContext;
    let audioCtx;
    try { audioCtx = new AudioContext(); } catch(e) {}

    function playTone(freq, type, duration) {
        if (!isSoundOn || !audioCtx) return;
        if (audioCtx.state === 'suspended') audioCtx.resume();
        const osc = audioCtx.createOscillator();
        const gainNode = audioCtx.createGain();
        osc.type = type;
        osc.frequency.setValueAtTime(freq, audioCtx.currentTime);
        gainNode.gain.setValueAtTime(0.1, audioCtx.currentTime);
        gainNode.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + duration);
        osc.connect(gainNode); gainNode.connect(audioCtx.destination);
        osc.start(); osc.stop(audioCtx.currentTime + duration);
    }
    const playEatSound = () => playTone(440, 'sine', 0.1);
    const playBonusSound = () => { playTone(523, 'triangle', 0.1); setTimeout(() => playTone(659, 'triangle', 0.2), 100); };
    const playLevelUpSound = () => { playTone(523, 'square', 0.1); setTimeout(() => playTone(783, 'square', 0.2), 200); };
    const playCrashSound = () => playTone(150, 'sawtooth', 0.3);
    const playErrorSound = () => playTone(150, 'sawtooth', 0.2);
    const playHealSound = () => { playTone(400, 'sine', 0.1); setTimeout(() => playTone(600, 'sine', 0.2), 100); };
    const playBombSound = () => { playTone(100, 'sawtooth', 0.1); setTimeout(() => playTone(80, 'sawtooth', 0.3), 100); };

    // --- Data ---
    const fruitIcons = ['ğŸ', 'ğŸ', 'ğŸŠ', 'ğŸ‹', 'ğŸŒ', 'ğŸ‰', 'ğŸ‡', 'ğŸ“', 'ğŸ’', 'ğŸ‘'];
    const rawLessonData = {
        "1": ["è€å¸«ï¼šä»Šå¤©ï¼Œæˆ‘å€‘æœ‰å…©å€‹æ–°åŒå­¸ã€‚","è€å¸«ï¼šç¾åœ¨è«‹ä»–å€‘ä»‹ç´¹è‡ªå·±ã€‚","å‹æœ‹ï¼šå¤§å®¶å¥½ï¼Œæˆ‘å«æ–¹å‹æœ‹ï¼Œä»Šå¹´å…«æ­²ã€‚","å‹æœ‹ï¼šæˆ‘æœ€å–œæ­¡è·Ÿçˆ¸çˆ¸ä¸€èµ·æ¸¸æ³³ã€‚","å¼µè‰ï¼šå¤§å®¶å¥½ï¼Œæˆ‘å«å¼µè‰ï¼Œä»Šå¹´ä¸ƒæ­²ã€‚","å¼µè‰ï¼šæˆ‘æ¯”è¼ƒå–œæ­¡çœ‹æ›¸ã€‚","å¤§æ–‡ï¼šä½ å€‘å¥½ï¼Œæˆ‘å«æå¤§æ–‡ã€‚","å¤§æ–‡ï¼šå¾ˆé«˜èˆˆèªè­˜ä½ å€‘ã€‚","è€å¸«ï¼šæ­¡è¿ä½ å€‘ä¾†ä¸­æ–‡å­¸æ ¡å­¸è¯èªã€‚"],
        "2": ["å¤§æ–‡ï¼šå¼µè‰ï¼Œç…§ç‰‡è£¡é¢çš„äººæ˜¯èª°ï¼Ÿ","å¼µè‰ï¼šå·¦é‚Šæ˜¯æˆ‘å¤–å…¬ï¼Œä»–ä»¥å‰æ˜¯é†«ç”Ÿã€‚","å¼µè‰ï¼šå³é‚Šæ˜¯æˆ‘å¤–å©†ã€‚","å¤§æ–‡ï¼šä½ çˆ¸çˆ¸åª½åª½åšä»€éº¼å·¥ä½œï¼Ÿ","å¼µè‰ï¼šæˆ‘çˆ¸çˆ¸åšç”Ÿæ„ï¼Œæˆ‘åª½åª½å¹«ä»–ã€‚","å¼µè‰ï¼šä½ çˆ¸çˆ¸åª½åª½å‘¢?","å¤§æ–‡ï¼šæˆ‘çˆ¸çˆ¸åœ¨é›»è…¦å…¬å¸ä¸Šç­ã€‚","å¤§æ–‡ï¼šæˆ‘åª½åª½åœ¨éŠ€è¡Œå·¥ä½œã€‚","å¤§æ–‡ï¼šä½ ä»¥å¾Œæƒ³åšä»€éº¼ï¼Ÿ","å¼µè‰ï¼šæˆ‘ä»¥å¾Œæƒ³è·Ÿçˆ¸çˆ¸ä¸€æ¨£ã€‚"],
        "3": ["å¤§æ–‡ï¼šåª½åª½ï¼Œä½ è¦å»å“ªè£¡ï¼Ÿ","åª½åª½ï¼šæˆ‘è¦å»é™„è¿‘çš„è¶…ç´šå¸‚å ´è²·æ±è¥¿ã€‚","åª½åª½ï¼šä½ è¦è·Ÿæˆ‘ä¸€èµ·å»å—ï¼Ÿ","å¤§æ–‡ï¼šè¦ï¼Œæˆ‘æƒ³å»è²·å·§å…‹åŠ›å†°æ·‡æ·‹ã€‚","å¤§æ–‡ï¼šä½ ä»Šå¤©è¦è²·ä»€éº¼ï¼Ÿ","åª½åª½ï¼šæˆ‘ä»Šå¤©è¦è²·é­šã€ç‰›è‚‰ã€é’èœï¼Œé‚„è¦è²·ç±³ã€‚","å¤§æ–‡ï¼šæˆ‘ä¹Ÿå¯ä»¥è²·ç³–æœå—ï¼Ÿ","åª½åª½ï¼šæˆ‘å€‘å»çœ‹ä¸€ä¸‹å§ï¼"],
        "4": ["æ–‡æ–‡ï¼šæˆ‘æƒ³åƒæ¼¢å ¡è·Ÿè–¯æ¢ã€‚","æ–‡æ–‡ï¼šæˆ‘å€‘å¯ä¸å¯ä»¥å‡ºå»åƒï¼Ÿ","åª½åª½ï¼šä»Šå¤©å…ˆåœ¨å®¶åƒï¼Œé€±æœ«å†å‡ºå»åƒå§ï¼","åª½åª½ï¼šä»Šå¤©æ™šé¤æƒ³åƒä»€éº¼ï¼Ÿ","å¤§æ–‡ï¼šæˆ‘æƒ³åƒéºµã€‚æ–‡æ–‡ï¼Œä½ å‘¢ï¼Ÿ","æ–‡æ–‡ï¼šæˆ‘æƒ³åƒè›‹ç‚’é£¯ï¼Œæœ‰æ¹¯å—ï¼Ÿ","åª½åª½ï¼šæˆ‘å·²ç¶“åšäº†ç‰ç±³æ¹¯ã€‚","å¤§æ–‡ï¼šåª½ï¼Œæˆ‘ç¾åœ¨å¾ˆé¤“ï¼Œæƒ³å¿«é»åƒæ™šé£¯ï¼Œå¥½å—ï¼Ÿ"],
        "5": ["å¤§æ–‡ï¼šä½ çœ‹ï¼æ¨¹è‘‰è®Šé»ƒäº†ï¼Œç§‹å¤©å¿«åˆ°äº†ã€‚","å¼µè‰ï¼šå¯æ˜¯è‰é‚„æ˜¯ç¶ è‰²çš„ã€‚","å¿ƒç¾ï¼šç§‹å¤©å¤©æ°£å¾ˆå¥½ã€‚æˆ‘è¦ºå¾—å¾ˆèˆ’æœã€‚","æ±æ˜ï¼šæ˜¥å¤©ä¹Ÿä¸éŒ¯ã€‚","å¤§æ–‡ï¼šæ˜¥å¤©çš„æ™‚å€™ï¼Œæˆ‘å€‘å®¶é™¢å­æœ‰å¾ˆå¤šé¡è‰²çš„èŠ±ã€‚","å¤§æ–‡ï¼šç´…è‰²çš„ã€ç™½è‰²çš„éƒ½æœ‰ã€‚","å¿ƒç¾ï¼šæˆ‘è¦ºå¾—ç´…è‰²çš„èŠ±æœ€æ¼‚äº®ã€‚"],
        "6": ["å¤§æ–‡ï¼šè€å¸«èªªè¾²æ›†æ–°å¹´å¿«åˆ°äº†ã€‚","çˆ¸çˆ¸ï¼šå°ï¼Œä¸‹å€‹æ˜ŸæœŸäº”æ˜¯è¾²æ›†æ–°å¹´ã€‚","å¤§æ–‡ï¼šåª½åª½æœƒå»è¯äººè¶…å¸‚è²·å¹´ç³•å—ï¼Ÿ","çˆ¸çˆ¸ï¼šæœƒï¼Œé‚£å¤©æˆ‘å€‘é‚„è¦çµ¦çˆºçˆºå¥¶å¥¶æ‹œå¹´ã€‚","å¤§æ–‡ï¼šå¤ªå¥½äº†ï¼Œçˆºçˆºæ¯å¹´éƒ½æœƒçµ¦æˆ‘ç´…åŒ…ã€‚","çˆ¸çˆ¸ï¼šå¦‚æœåœ¨è‡ºç£ï¼Œæˆ‘å€‘é‚„æœƒè²¼æ˜¥è¯ã€æ”¾é­ç‚®ã€‚"],
        "7": ["çˆ¸çˆ¸ï¼šå¤§æ–‡ï¼Œè©²èµ·åºŠäº†ï¼ä¾†ä¸åŠäº†ï¼","å¤§æ–‡ï¼šæˆ‘å¾ˆç´¯ï¼Œé‚„æƒ³ç¡è¦ºã€‚","çˆ¸çˆ¸ï¼šä»Šå¤©æ™šä¸Šæ—©ä¸€é»ç¡,ç¾åœ¨è¶•å¿«å»åˆ·ç‰™ã€æ´—æ¾¡ã€‚","å¤§æ–‡ï¼šæˆ‘æ˜¨å¤©æ™šä¸Šæ´—éæ¾¡äº†ã€‚","çˆ¸çˆ¸ï¼šé‚„æœ‰ï¼Œåˆ¥å¿˜äº†ç”¨è‚¥çš‚æ´—è‡‰ã€‚","å¤§æ–‡ï¼šæˆ‘çŸ¥é“äº†ï¼Œè¦æ´—ä¹¾æ·¨ã€‚"],
        "8": ["å¿ƒç¾ï¼šæ˜¨å¤©æˆ‘çˆ¸çˆ¸çš„æœ‹å‹é€çµ¦æˆ‘ä¸€éš»ç‹—ã€‚","å¿ƒç¾ï¼šä½ å€‘å®¶æœ‰å¯µç‰©å—ï¼Ÿ","å¤§æ–‡ï¼šæœ‰ï¼Œæˆ‘å®¶æœ‰å…©éš»ç‹—ï¼Œæˆ‘æ¯å¤©éƒ½å¸¶ç‰ å€‘å»æ•£æ­¥ã€‚","å¿ƒç¾ï¼šå¼µè‰ï¼Œä½ é¤Šéç‹—å—ï¼Ÿ","å¼µè‰ï¼šæˆ‘æ²’é¤Šéç‹—ï¼Œæˆ‘å»å¹´é¤Šäº†ä¸€éš»è²“ï¼Œå¯æ˜¯ä¸Šå€‹æœˆä¸è¦‹äº†ã€‚","å‹æœ‹ï¼šæˆ‘ä¹Ÿé¤Šéè²“ï¼Œéå¸¸å¯æ„›ï¼Œæˆ‘æ¯å¤©éƒ½é¤µç‰ ã€‚","å¼µè‰ï¼šä»¥å¾Œæˆ‘æƒ³é¤Šä¸€éš»å…”å­ã€‚"],
        "9": ["å‹æœ‹ï¼šæ±æ˜ï¼Œé€™æ˜¯ä»€éº¼ï¼Ÿ","æ±æ˜ï¼šæŒ‡å—é‡ï¼Œä¹Ÿå«æŒ‡åŒ—é‡ï¼Œå®ƒå‘Šè¨´æˆ‘å€‘å—æ–¹å’ŒåŒ—æ–¹åœ¨å“ªè£¡ã€‚","å‹æœ‹ï¼šéŸ³æ¨‚æ•™å®¤æ˜¯ä»€éº¼æ–¹å‘ï¼Ÿ","æ±æ˜ï¼šéŸ³æ¨‚æ•™å®¤åœ¨åŒ—æ–¹ï¼Œæ ¡é–€å£åœ¨å—æ–¹ã€‚","å‹æœ‹ï¼šè¶³çƒå ´åœ¨æ±æ–¹ï¼Œé‚„æ˜¯è¥¿æ–¹ï¼Ÿ","æ±æ˜ï¼šå› ç‚ºéŸ³æ¨‚æ•™å®¤åœ¨åŒ—æ–¹ï¼Œæ‰€ä»¥è¶³çƒå ´åœ¨æ±æ–¹ã€‚"],
        "10": ["å¿ƒç¾ï¼šæš‘å‡çš„æ™‚å€™ï¼Œæˆ‘æœƒå»è‡ºç£çœ‹å¤–å…¬ã€å¤–å©†ã€‚","å¼µè‰ï¼šä½ å¤–å…¬ã€å¤–å©†å®¶åœ¨å“ªè£¡ï¼Ÿ","å¿ƒç¾ï¼šä»–å€‘æœ¬ä¾†ä½åœ¨è‡ºåŒ—ï¼Œé€€ä¼‘ä»¥å¾Œï¼Œè·Ÿæˆ‘çš„èˆ…èˆ…ä½åœ¨è‡ºå—ã€‚","å¼µè‰ï¼šä½ å€‘æ¯å¹´éƒ½å»çœ‹å¤–å…¬å¤–å©†å—ï¼Ÿ","å¿ƒç¾ï¼šæˆ‘å€‘æ¯å¹´éƒ½å»çœ‹ä»–å€‘ä¸€æ¬¡ï¼Œä½ å¤–å…¬å¤–å©†ä½åœ¨å“ªè£¡ï¼Ÿ","å¼µè‰ï¼šæˆ‘å¤–å…¬ã€å¤–å©†ç¾åœ¨ä½åœ¨ç´ç´„ï¼Œä»–å€‘ä¸‹å€‹æœˆæœƒä¾†çœ‹æˆ‘å€‘ã€‚","å¿ƒç¾ï¼šæˆ‘å¤–å…¬ã€å¤–å©†å–œæ­¡æ—…è¡Œï¼Œå¸¸å¸¸ä¾†çœ‹æˆ‘å€‘ï¼Œä¹Ÿå¸¸å»æ³•åœ‹çœ‹é˜¿å§¨ã€‚"],
        "11": ["å¿ƒç¾ï¼šä¸‹å€‹æ˜ŸæœŸäº”ï¼Œå­¸æ ¡è¦å¸¶æˆ‘å€‘å»å‹•ç‰©åœ’ç©ã€‚","å¿ƒç¾å“¥å“¥ï¼šå¤ªå¥½äº†ï¼ä½ å¯ä»¥çœ‹åˆ°ä½ å–œæ­¡çš„å¤§è±¡å’Œè€è™ã€‚","å¿ƒç¾ï¼šé€™ä¸€æ¬¡æˆ‘å¸Œæœ›å¯ä»¥çœ‹åˆ°ç†Šè²“å’ŒçŒ´å­ã€‚","å¿ƒç¾å“¥å“¥ï¼šå°ï¼Œä»¥å‰æˆ‘å»çš„æ™‚å€™ï¼Œå‹•ç‰©åœ’æ²’æœ‰ç†Šè²“ã€‚","çˆ¸çˆ¸ï¼šç¾åœ¨ä¸ä½†æœ‰ç†Šè²“ï¼Œé‚„æœ‰ä¼éµã€‚","å¿ƒç¾ï¼šæˆ‘è¦ºå¾—ç†Šè²“èƒ–èƒ–çš„ï¼ŒçœŸå¯æ„›ï¼","å¿ƒç¾å“¥å“¥ï¼šæˆ‘å–œæ­¡é•·é ¸é¹¿ï¼Œè„–å­é•·é•·çš„ã€‚"],
        "12": ["çˆ¸çˆ¸ï¼šå¤§æ–‡ï¼Œæˆ‘ç¾åœ¨è¦ç”¨ç¶²è·¯çµ¦å§‘å§‘æ‰“é›»è©±ã€‚","å¤§æ–‡ï¼šå¯ä»¥çœ‹åˆ°å§‘å§‘å—ï¼Ÿæˆ‘å¾ˆä¹…æ²’è·Ÿå§‘å§‘èªªè©±äº†ã€‚","çˆ¸çˆ¸ï¼šå¯ä»¥çœ‹åˆ°å¥¹çš„å½±åƒï¼Œå¿«ä¸€é»éä¾†ã€‚","å§‘å§‘ï¼šå¤§æ–‡ï¼Œä½ çœ‹èµ·ä¾†ç˜¦äº†ã€‚","å¤§æ–‡ï¼šæˆ‘æ²’ç˜¦ï¼Œæˆ‘é•·é«˜äº†ã€‚","å§‘å§‘ï¼šæ–‡æ–‡ç¾åœ¨ä¹Ÿè·Ÿä½ ä¸€èµ·å»å­¸è¯èªå—?","å¤§æ–‡ï¼šæ˜¯å•Šï¼ä¸Šä¸­æ–‡èª²å¾ˆæœ‰æ„æ€ã€‚","å§‘å§‘ï¼šä½ å¥½å¥½å­¸è¯èªï¼Œä»¥å¾Œå¯ä»¥ç”¨ç¶²è·¯çµ¦æˆ‘å¯«ä¿¡ã€‚","å¤§æ–‡ï¼šæ²’å•é¡Œï¼Œæˆ‘ä¸€å®šæœƒå¥½å¥½å­¸è¯èªã€‚"]
    };
    const lessonData = {};
    for (let key in rawLessonData) { lessonData[key] = rawLessonData[key].map(s => s.replace(/^[^ï¼š]+ï¼š/, '')); }

    // --- Game Variables ---
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    const scoreElement = document.getElementById('score');
    const livesElement = document.getElementById('lives');
    const progressCurrentElement = document.getElementById('progress-current');
    const progressTotalElement = document.getElementById('progress-total');
    const sentenceDisplay = document.getElementById('current-sentence-display');
    const startScreen = document.getElementById('start-screen');
    const gameOverScreen = document.getElementById('game-over-screen');
    const lessonCompleteScreen = document.getElementById('lesson-complete-screen');
    const quitModal = document.getElementById('quit-modal');
    const reviveModal = document.getElementById('revive-modal');
    const leaderboardModal = document.getElementById('leaderboard-modal');
    const modalBackdrop = document.getElementById('backdrop');

    // GRID SIZE CHANGE: Increased from 40 to 50, tileCount from 15 to 12 (600px width constant)
    const gridSize = 50, tileCount = 12;
    let speed, score, lives, heartRefillCount, isRevived = false;
    let snake, foodItems, bonusItem, bombItem, heartItem;
    let dx, dy, gameLoop, isGameRunning, isPaused, isTransitioning, playerName, heartbeatInterval;
    let particles, popups, currentLessonSentences, availableIndices, sentencesCompleted, totalSentencesCount, currentSentence, charIndex, eatenSentenceChars, isSoundOn = true;
    let comboCount = 0, comboTimer = 0;
    let ouchTimer = 0; 

    (function init() {
        const urlParams = new URLSearchParams(window.location.search);
        if (urlParams.get('lesson')) {
            document.getElementById('lesson-select').value = urlParams.get('lesson');
            document.getElementById('start-title').innerHTML = `æŒ‘æˆ°ï¼šç¬¬${urlParams.get('lesson')}èª²`;
        }
        const savedName = localStorage.getItem('snake_player_name');
        if (savedName) document.getElementById('player-name').value = savedName;
    })();

    window.shareLesson = function() {
        const lessonVal = document.getElementById('lesson-select').value;
        const url = new URL(window.location.href); url.searchParams.set('lesson', lessonVal);
        const temp = document.createElement("textarea"); temp.value = url.toString();
        document.body.appendChild(temp); temp.select(); document.execCommand("copy");
        document.body.removeChild(temp); showToast("å·²è¤‡è£½èª²ç¨‹é€£çµï¼");
    }

    function showToast(msg) {
        const t = document.getElementById("toast"); t.innerText = msg; t.className = "show";
        setTimeout(() => t.className = t.className.replace("show", ""), 3000);
    }

    function initGame() {
        resetSnakePos();
        // SPEED CHANGE: set default based on select or default 2.5
        const speedSelect = document.getElementById('speed-select');
        speed = speedSelect ? parseFloat(speedSelect.value) : 2.5;
        
        score = 0; lives = 3; heartRefillCount = 0; isRevived = false; isPaused = false; 
        eatenSentenceChars = []; particles = []; popups = []; foodItems = [];
        bonusItem = { x: -1, y: -1, active: false }; bombItem = { x: -1, y: -1, active: false }; heartItem = { x: -1, y: -1, active: false };
        scoreElement.innerText = score;
        scoreElement.parentElement.classList.remove('locked-score');
        document.getElementById('revive-note').classList.add('hidden');
        updateLivesDisplay(); isTransitioning = false; loadSentences(); startNewSentence();
        ouchTimer = 0; 
    }

    function resetSnakePos() { snake = [{ x: 6, y: 6 }, { x: 5, y: 6 }, { x: 4, y: 6 }]; dx = 1; dy = 0; }

    function updateLivesDisplay() {
        let h = ""; for(let i=0; i<lives; i++) h += "â¤ï¸"; for(let i=lives; i<3; i++) h += "ğŸ–¤";
        livesElement.innerText = h;
    }

    function loadSentences() {
        const val = document.getElementById('lesson-select').value;
        currentLessonSentences = val === "all" ? [].concat(...Object.values(lessonData)) : lessonData[val];
        availableIndices = currentLessonSentences.map((_, i) => i);
        sentencesCompleted = 0; totalSentencesCount = currentLessonSentences.length;
        updateProgressDisplay();
    }

    function updateProgressDisplay() { progressCurrentElement.innerText = sentencesCompleted; progressTotalElement.innerText = totalSentencesCount; }

    function startNewSentence() {
        if (availableIndices.length === 0) { showLessonComplete(); return; }
        const idx = Math.floor(Math.random() * availableIndices.length);
        const sIdx = availableIndices[idx]; availableIndices.splice(idx, 1);
        currentSentence = currentLessonSentences[sIdx]; charIndex = 0; isTransitioning = false;
        while (charIndex < currentSentence.length && isPunctuation(currentSentence[charIndex])) charIndex++;
        updateSentenceDisplay(); speakText(currentSentence); spawnFoods();
    }

    function spawnFoods() {
        foodItems = []; if (charIndex >= currentSentence.length) return;
        const target = currentSentence[charIndex];
        const p1 = getFreePosition(); foodItems.push({ x: p1.x, y: p1.y, char: target, isCorrect: true });
        for (let i = 0; i < 2; i++) {
            let dist = target, safety = 0;
            while ((dist === target || foodItems.some(f => f.char === dist)) && safety < 50) {
                const rs = currentLessonSentences[Math.floor(Math.random() * currentLessonSentences.length)];
                const rc = rs[Math.floor(Math.random() * rs.length)];
                if (!isPunctuation(rc)) dist = rc; safety++;
            }
            const p = getFreePosition(); foodItems.push({ x: p.x, y: p.y, char: dist, isCorrect: false });
        }
    }

    function getFreePosition() {
        let p = { x: 0, y: 0 }, valid = false, attempts = 0;
        while (!valid && attempts < 100) {
            valid = true; p.x = Math.floor(Math.random() * tileCount); p.y = Math.floor(Math.random() * tileCount);
            if (snake.some(s => s.x === p.x && s.y === p.y)) valid = false;
            if (foodItems.some(f => f.x === p.x && f.y === p.y)) valid = false;
            attempts++;
        }
        return p;
    }

    function spawnHappyEffect(gx, gy, type) { // Grid coordinates, type: 'char', 'fruit', 'wrong', 'bomb'
        let icons = [];
        let count = 4;
        let isExplosion = false;

        if (type === 'fruit') {
            icons = ['â­', 'âœ¨', 'ğŸŒŸ', 'ğŸ’«']; 
        } else if (type === 'char') {
            icons = ['â¤ï¸', 'ğŸ’–', 'ğŸ¥°', 'ğŸ˜']; 
        } else if (type === 'wrong') {
            icons = ['âŒ', 'â“', 'ğŸŒ€', 'ğŸ˜µ'];
        } else if (type === 'bomb') {
            icons = ['ğŸ’¥', 'ğŸ”¥', 'ğŸ’¨', 'ğŸ’€'];
            count = 8; // More particles for explosion
            isExplosion = true;
        }
        
        for (let i = 0; i < count; i++) {
            let vx, vy;
            if (isExplosion) {
                // Explosion spreads in all directions
                vx = (Math.random() - 0.5) * 10; 
                vy = (Math.random() - 0.5) * 10;
            } else {
                // Others float upwards
                vx = (Math.random() - 0.5) * 4; 
                vy = -Math.random() * 2 - 2;    
            }

            particles.push({
                x: gx * gridSize + 25, // Center x
                y: gy * gridSize + 25, // Center y
                vx: vx,
                vy: vy,
                life: 1.0,
                content: icons[Math.floor(Math.random() * icons.length)]
            });
        }
    }

    function moveSnake() {
        let nx = snake[0].x + dx, ny = snake[0].y + dy;
        if (nx < 0) nx = tileCount - 1; else if (nx >= tileCount) nx = 0;
        if (ny < 0) ny = tileCount - 1; else if (ny >= tileCount) ny = 0;
        const head = { x: nx, y: ny }; snake.unshift(head);

        // Score logic - Only update score var if not revived
        const addScore = (pts) => { if (!isRevived) { score += pts; scoreElement.innerText = score; } };

        if (bonusItem.active && head.x === bonusItem.x && head.y === bonusItem.y) {
            addScore(100); bonusItem.active = false; playBonusSound(); 
            spawnPopup(head.x, head.y, "+100", "#E76F51");
            spawnHappyEffect(head.x, head.y, 'fruit'); 
        }
        if (bombItem.active && head.x === bombItem.x && head.y === bombItem.y) {
            if (!isRevived) { score = Math.max(0, score - 50); scoreElement.innerText = score; }
            bombItem.active = false; playBombSound(); spawnPopup(head.x, head.y, "-50", "#555");
            ouchTimer = 6; 
            spawnHappyEffect(head.x, head.y, 'bomb'); // Added bomb effect
        }
        if (heartItem.active && head.x === heartItem.x && head.y === heartItem.y) {
            lives++; heartRefillCount++; heartItem.active = false; updateLivesDisplay(); playHealSound();
        }

        let fIdx = foodItems.findIndex(f => f.x === head.x && f.y === head.y);
        if (fIdx !== -1 && !isTransitioning) {
            if (foodItems[fIdx].isCorrect) {
                let pts = 10;
                let displayText = "+10";
                
                if (comboTimer > 0) { 
                    comboCount++; 
                    pts += comboCount * 5; 
                    displayText = `Combo x${comboCount}`;
                } else { 
                    comboCount = 1; 
                }
                
                comboTimer = 30; 
                addScore(pts); 
                eatenSentenceChars.push(foodItems[fIdx].char);
                speakText(getCorrectAudioText(foodItems[fIdx].char, charIndex, currentSentence));
                playEatSound(); 
                spawnPopup(head.x, head.y, displayText, "#2A9D8F"); 
                spawnHappyEffect(head.x, head.y, 'char'); 
                
                charIndex++; 
                while (charIndex < currentSentence.length && isPunctuation(currentSentence[charIndex])) charIndex++;
                updateSentenceDisplay();
                if (charIndex >= currentSentence.length) {
                    addScore(50); isTransitioning = true; foodItems = []; sentencesCompleted++;
                    updateProgressDisplay(); playLevelUpSound();
                    setTimeout(() => { if (isGameRunning) startNewSentence(); }, 1200);
                } else spawnFoods();
            } else {
                if (!isRevived) { score = Math.max(0, score - 20); scoreElement.innerText = score; }
                comboCount = 0; playErrorSound(); spawnPopup(head.x, head.y, "é¸éŒ¯äº†!", "#D32F2F"); spawnFoods();
                ouchTimer = 6; 
                spawnHappyEffect(head.x, head.y, 'wrong'); // Added wrong effect
            }
        } else snake.pop();
    }

    function askToRevive() {
        isGameRunning = false; clearInterval(gameLoop);
        document.getElementById('revive-remaining').innerText = totalSentencesCount - sentencesCompleted;
        reviveModal.classList.remove('hidden');
    }

    function manageItems() {
        if (!bonusItem.active && Math.random() < 0.02) { let p = getFreePosition(); bonusItem = { ...p, active: true, timer: 100, icon: fruitIcons[Math.floor(Math.random()*fruitIcons.length)] }; }
        else if (bonusItem.active && --bonusItem.timer <= 0) bonusItem.active = false;
        
        // REVERTED to standard rates
        if (!bombItem.active && Math.random() < 0.015) { let p = getFreePosition(); bombItem = { ...p, active: true, timer: 150 }; }
        else if (bombItem.active && --bombItem.timer <= 0) bombItem.active = false;
        
        if (!heartItem.active && lives === 1 && heartRefillCount < 2 && Math.random() < 0.02) { let p = getFreePosition(); heartItem = { ...p, active: true, timer: 300 }; }
        else if (heartItem.active && --heartItem.timer <= 0) heartItem.active = false;
    }

    window.reviveGame = function() {
        lives = 3; isRevived = true;
        scoreElement.parentElement.classList.add('locked-score');
        document.getElementById('revive-note').classList.remove('hidden');
        updateLivesDisplay(); reviveModal.classList.add('hidden'); resetSnakePos(); spawnFoods();
        isGameRunning = true; gameLoop = setInterval(drawGame, 1000 / speed);
    }

    window.gameOver = function() {
        reviveModal.classList.add('hidden'); isGameRunning = false; clearInterval(gameLoop); clearInterval(heartbeatInterval);
        document.getElementById('game-over-title').innerText = `ğŸ˜² ${playerName}ï¼Œç·´ç¿’çµç®—ï¼`;
        document.getElementById('game-over-name').innerText = playerName;
        document.getElementById('final-score').innerText = score;
        const lessonName = document.getElementById('lesson-select').options[document.getElementById('lesson-select').selectedIndex].text;
        document.getElementById('game-over-lesson').innerText = `ç·´ç¿’èª²ç¨‹ï¼š${lessonName}`;
        window.saveScoreToCloud(playerName, score, lessonName);
        gameOverScreen.classList.remove('hidden');
    }

    function showLessonComplete() {
        isGameRunning = false; clearInterval(gameLoop); clearInterval(heartbeatInterval);
        playLevelUpSound();
        const lessonName = document.getElementById('lesson-select').options[document.getElementById('lesson-select').selectedIndex].text;
        document.getElementById('complete-lesson-name').innerText = lessonName;
        document.getElementById('complete-score').innerText = score;
        
        // Show revive note in complete screen if used
        if (isRevived) {
             document.getElementById('revive-note').classList.remove('hidden');
        } else {
             document.getElementById('revive-note').classList.add('hidden');
        }
        
        window.saveScoreToCloud(playerName, score, lessonName);
        lessonCompleteScreen.classList.remove('hidden');
    }

    function drawGame() {
        if (!isGameRunning || isPaused) return;
        moveSnake(); manageItems();
        if (comboTimer > 0) comboTimer--; else comboCount = 0;
        if (ouchTimer > 0) ouchTimer--; 
        if (snake.slice(1).some(p => p.x === snake[0].x && p.y === snake[0].y)) { handleCollision(); return; }
        ctx.fillStyle = "#FFF"; ctx.fillRect(0, 0, canvas.width, canvas.height);
        ctx.lineWidth = 0.5; ctx.strokeStyle = "rgba(42, 157, 143, 0.2)";
        for(let i=0; i<tileCount; i++) {
            ctx.beginPath(); ctx.moveTo(i*gridSize,0); ctx.lineTo(i*gridSize,600); ctx.stroke();
            ctx.beginPath(); ctx.moveTo(0,i*gridSize); ctx.lineTo(600,i*gridSize); ctx.stroke();
        }
        foodItems.forEach(f => {
            // ADJUSTED: Offset +25 for 50px grid center
            ctx.fillStyle = "#FFE8D6"; ctx.beginPath(); ctx.arc(f.x*gridSize+25, f.y*gridSize+25, 28, 0, Math.PI*2); ctx.fill();
            ctx.fillStyle = "#E76F51"; ctx.font = "bold 28px Noto Sans TC"; ctx.textAlign = "center"; ctx.textBaseline = "middle";
            ctx.fillText(f.char, f.x*gridSize+25, f.y*gridSize+27);
        });
        // ADJUSTED: Offsets for 50px grid
        if (bonusItem.active) { ctx.font = "32px Arial"; ctx.fillText(bonusItem.icon, bonusItem.x*gridSize+25, bonusItem.y*gridSize+27); }
        if (bombItem.active) { ctx.font = "32px Arial"; ctx.fillText("ğŸ’£", bombItem.x*gridSize+25, bombItem.y*gridSize+27); }
        if (heartItem.active) { ctx.font = "32px Arial"; ctx.fillText("â¤ï¸", heartItem.x*gridSize+25, heartItem.y*gridSize+27); }
        
        snake.forEach((p, i) => {
            ctx.fillStyle = i === 0 ? "#2A9D8F" : "#F4A261";
            // ADJUSTED: Snake body size 48px
            ctx.beginPath(); ctx.roundRect(p.x*gridSize+1, p.y*gridSize+1, 48, 48, 8); ctx.fill();
            if (i === 0) {
                ctx.fillStyle = "white";
                // ADJUSTED: Eye offsets for 50px grid
                // Right: [38, 12, 38, 38]
                // Left: [12, 12, 12, 38]
                // Down: [12, 38, 38, 38]
                // Up: [12, 12, 38, 12]
                let offset = dx === 1 ? [38,12,38,38] : (dx === -1 ? [12,12,12,38] : (dy === 1 ? [12,38,38,38] : [12,12,38,12]));
                
                if (ouchTimer > 0) {
                    ctx.strokeStyle = "white";
                    ctx.lineWidth = 2;
                    ctx.beginPath();
                    // Left eye X
                    ctx.moveTo(p.x*gridSize+offset[0]-4, p.y*gridSize+offset[1]-4);
                    ctx.lineTo(p.x*gridSize+offset[0]+4, p.y*gridSize+offset[1]+4);
                    ctx.moveTo(p.x*gridSize+offset[0]+4, p.y*gridSize+offset[1]-4);
                    ctx.lineTo(p.x*gridSize+offset[0]-4, p.y*gridSize+offset[1]+4);
                    // Right eye X
                    ctx.moveTo(p.x*gridSize+offset[2]-4, p.y*gridSize+offset[3]-4);
                    ctx.lineTo(p.x*gridSize+offset[2]+4, p.y*gridSize+offset[3]+4);
                    ctx.moveTo(p.x*gridSize+offset[2]+4, p.y*gridSize+offset[3]-4);
                    ctx.lineTo(p.x*gridSize+offset[2]-4, p.y*gridSize+offset[3]+4);
                    ctx.stroke();
                } else {
                    ctx.beginPath(); 
                    ctx.arc(p.x*gridSize+offset[0], p.y*gridSize+offset[1], 5, 0, Math.PI*2); 
                    ctx.arc(p.x*gridSize+offset[2], p.y*gridSize+offset[3], 5, 0, Math.PI*2); 
                    ctx.fill();
                }
            } else {
                let char = eatenSentenceChars[eatenSentenceChars.length - (snake.length - 1) + (i - 1)];
                if (char) { ctx.fillStyle = "#FFF"; ctx.font = "bold 22px Noto Sans TC"; ctx.fillText(char, p.x*gridSize+25, p.y*gridSize+27); }
            }
        });
        updateAndDrawParticles(); updateAndDrawPopups();
    }

    function handleCollision() {
        playCrashSound(); lives--; updateLivesDisplay(); comboCount = 0;
        ouchTimer = 6; 
        if (lives <= 0) askToRevive(); else { resetSnakePos(); spawnFoods(); isPaused = true; setTimeout(() => isPaused = false, 500); }
    }

    function spawnPopup(x, y, text, color) { popups.push({ x: x*gridSize+25, y: y*gridSize, text, life: 1, color }); }
    
    function updateAndDrawPopups() {
        for (let i = popups.length-1; i>=0; i--) {
            let p = popups[i]; p.y -= 1; p.life -= 0.02;
            if (p.life <= 0) popups.splice(i, 1);
            else { ctx.globalAlpha = p.life; ctx.fillStyle = p.color; ctx.font = "bold 20px Noto Sans TC"; ctx.fillText(p.text, p.x, p.y); ctx.globalAlpha = 1; }
        }
    }
    
    function updateAndDrawParticles() {
        for (let i = particles.length-1; i>=0; i--) {
            let p = particles[i]; p.x += p.vx; p.y += p.vy; p.life -= 0.03; // Slower fade
            if (p.life <= 0) particles.splice(i, 1);
            else { 
                ctx.globalAlpha = p.life; 
                if (p.content) {
                    ctx.font = "20px Arial";
                    ctx.fillText(p.content, p.x, p.y);
                } else {
                    ctx.fillStyle = p.color; 
                    ctx.beginPath(); 
                    ctx.arc(p.x, p.y, 4, 0, Math.PI*2); 
                    ctx.fill(); 
                }
                ctx.globalAlpha = 1; 
            }
        }
    }

    window.startGame = function() {
        playerName = document.getElementById('player-name').value.trim() || "å°å‹‡å£«";
        localStorage.setItem('snake_player_name', playerName);
        let lesson = document.getElementById('lesson-select').value === 'all' ? 'å…¨å†Š' : `ç¬¬${document.getElementById('lesson-select').value}èª²`;
        window.sendHeartbeat(playerName, lesson);
        if (heartbeatInterval) clearInterval(heartbeatInterval);
        heartbeatInterval = setInterval(() => window.sendHeartbeat(playerName, lesson), 30000);
        startScreen.classList.add('hidden'); gameOverScreen.classList.add('hidden'); lessonCompleteScreen.classList.add('hidden');

        // Ensure UI is reset
        document.getElementById('pause-btn').innerText = "â¸ï¸";
        document.getElementById('pause-overlay').classList.add('hidden');
        
        initGame(); 
        isGameRunning = true; 
        gameLoop = setInterval(drawGame, 1000 / speed);
    };

    window.resetGame = () => window.startGame();
    window.showStartScreen = () => { gameOverScreen.classList.add('hidden'); lessonCompleteScreen.classList.add('hidden'); reviveModal.classList.add('hidden'); startScreen.classList.remove('hidden'); isGameRunning = false; clearInterval(heartbeatInterval); };
    window.toggleSound = () => { isSoundOn = !isSoundOn; document.getElementById('sound-btn').innerText = isSoundOn ? "ğŸ”Š" : "ğŸ”‡"; };
    window.togglePause = () => { if (!isGameRunning) return; isPaused = !isPaused; document.getElementById('pause-btn').innerText = isPaused ? "â–¶ï¸" : "â¸ï¸"; document.getElementById('pause-overlay').classList.toggle('hidden'); };
    window.triggerQuit = () => { if (isGameRunning && !isPaused) window.togglePause(); quitModal.classList.remove('hidden'); };
    window.cancelQuit = () => quitModal.classList.add('hidden');
    window.confirmQuit = () => { reviveModal.classList.add('hidden'); quitModal.classList.add('hidden'); isGameRunning = false; clearInterval(gameLoop); clearInterval(heartbeatInterval); window.showStartScreen(); };
    window.hideLeaderboardModal = () => { modalBackdrop.classList.add('hidden'); leaderboardModal.classList.add('hidden'); };
    window.showLeaderboardModal = () => { modalBackdrop.classList.remove('hidden'); leaderboardModal.classList.remove('hidden'); };

    function speakText(t) { if (!isSoundOn) return; window.speechSynthesis.cancel(); 
        let cleanText = t.replace(/éƒ½/g, 'å…œ').replace(/ä»€/g, 'ç¥'); // Fix: Force 'éƒ½' -> 'å…œ', 'ä»€' -> 'ç¥'
        const u = new SpeechSynthesisUtterance(cleanText); u.lang = 'zh-TW'; u.rate = 0.85; window.speechSynthesis.speak(u); }
    function isPunctuation(c) { return /[ï¼Œã€‚ã€ï¼Ÿï¼ï¼šï¼›ã€Œã€ã€ã€\s,.?!:;"'()ï¼ˆï¼‰]/.test(c); }
    function updateSentenceDisplay() {
        let h = ''; for (let i = 0; i < currentSentence.length; i++) {
            if (i < charIndex) h += `<span class="char-eaten">${currentSentence[i]}</span>`;
            else if (i === charIndex) h += `<span class="char-current">${currentSentence[i]}</span>`;
            else h += `<span class="char-pending">${currentSentence[i]}</span>`;
        }
        h += `<button id="replay-btn" onclick="replayCurrentAudio()">ğŸ”Š</button>`; sentenceDisplay.innerHTML = h;
    }
    window.replayCurrentAudio = () => speakText(currentSentence);

    // --- Controls ---
    document.addEventListener('keydown', e => {
        if (isPaused) return;
        // Left: ArrowLeft (37) or KeyA
        if ((e.keyCode === 37 || e.code === 'KeyA') && dx !== 1) { dx = -1; dy = 0; }
        // Up: ArrowUp (38) or KeyW
        if ((e.keyCode === 38 || e.code === 'KeyW') && dy !== 1) { dx = 0; dy = -1; }
        // Right: ArrowRight (39) or KeyD
        if ((e.keyCode === 39 || e.code === 'KeyD') && dx !== -1) { dx = 1; dy = 0; }
        // Down: ArrowDown (40) or KeyS
        if ((e.keyCode === 40 || e.code === 'KeyS') && dy !== -1) { dx = 0; dy = 1; }
        
        if (e.code === 'KeyP') window.togglePause();
    });
    let tsX, tsY;
    document.addEventListener('touchstart', e => { if (!['BUTTON','INPUT','SELECT'].includes(e.target.tagName)) e.preventDefault(); tsX = e.touches[0].screenX; tsY = e.touches[0].screenY; }, {passive: false});
    document.addEventListener('touchend', e => {
        if (isPaused || !isGameRunning) return;
        let dx_s = e.changedTouches[0].screenX - tsX, dy_s = e.changedTouches[0].screenY - tsY;
        if (Math.abs(dx_s) > Math.abs(dy_s)) { if (Math.abs(dx_s)>20) { dx = dx_s > 0 ? 1 : -1; dy = 0; } }
        else { if (Math.abs(dy_s)>20) { dy = dy_s > 0 ? 1 : -1; dx = 0; } }
    });
    window.addEventListener("keydown", e => { if(["Space","ArrowUp","ArrowDown","ArrowLeft","ArrowRight"].includes(e.code)) e.preventDefault(); });
    function getCorrectAudioText(c, i, s) { 
        if (c==='è¦º' && s[i-1]==='ç¡') return 'å«'; 
        if (c==='æ¨‚' && (s[i-1]==='éŸ³'||s[i+1]==='éšŠ')) return 'æœˆ';
        if (c==='éƒ½') return 'å…œ'; // Fix: Force 'éƒ½' to be pronounced as 'dÅu' (å…œ)
        if (c==='ä»€') return 'ç¥'; // Fix: Force 'ä»€' to be pronounced as 'shÃ©n' (ç¥)
        if (c==='èˆˆ' && s[i-1]==='é«˜') return 'å¹¸'; // Fix: Force 'èˆˆ' in 'é«˜èˆˆ' to be pronounced as 'xÃ¬ng' (å¹¸)
        return c; 
    }
</script>
</body>
</html>