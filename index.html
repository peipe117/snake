<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <title>è¯èªè²ªé£Ÿè›‡ï¼šèª²æ–‡å¤§å†’éšª</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=Gaegu:wght@400;700&display=swap');

        :root {
            --primary-color: #F4A261;   
            --secondary-color: #2A9D8F; 
            --accent-color: #E76F51;    
            --bg-color: #FDF6E3;        
            --text-color: #264653;      
            --card-bg: #FFFFFF;         
            --locked-score: #999;       
        }

        html {
            width: 100%;
            min-height: 100vh;
            margin: 0;
            padding: 0;
            overflow-y: auto;
        }

        body {
            font-family: 'Noto Sans TC', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            gap: 1.5vh;
            user-select: none;
            background-image: radial-gradient(#E0E0E0 1px, transparent 1px);
            background-size: 20px 20px;
            padding: 20px 0;
            box-sizing: border-box;
            min-height: 100vh;
        }

        button, input, select, .screen, .leaderboard-container, .speed-slider-container {
            touch-action: manipulation;
        }

        h1 {
            color: var(--secondary-color);
            margin: 0;
            font-size: 2rem; 
            text-align: center;
            font-family: 'Gaegu', cursive, 'Noto Sans TC', sans-serif;
            flex-shrink: 0; 
            text-shadow: 2px 2px 0px rgba(0,0,0,0.1);
        }

        #top-controls, #game-controls-container, #online-status-bar {
            width: 95%;
            max-width: 600px;
            flex-shrink: 0;
            box-sizing: border-box;
            margin: 0;
        }

        #top-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 5px;
        }

        #score-info {
            font-weight: bold;
            color: var(--text-color);
            display: flex;
            flex-direction: column;
            font-size: 1rem; 
            line-height: 1.3;
        }
        
        #lives { color: var(--accent-color); font-size: 1.2rem; letter-spacing: 2px; }

        .speed-slider-container {
            display: flex;
            align-items: center;
            gap: 10px;
            background: #f0f0f0;
            padding: 6px 15px;
            border-radius: 15px;
            width: 100%;
            box-sizing: border-box;
        }

        #online-status-bar {
            font-size: 0.9rem;
            color: #555;
            background: rgba(255,255,255,0.9);
            padding: 6px 15px;
            border-radius: 20px;
            text-align: left;
            border: 2px solid #FFF;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }

        #game-wrapper-flex {
            flex: 0 1 auto;
            display: flex;
            justify-content: center;
            align-items: center;
            width: 100%;
            min-height: 0; 
            padding: 0 5px; 
            box-sizing: border-box;
        }

        #game-container {
            position: relative;
            background: var(--card-bg);
            padding: 10px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(38, 70, 83, 0.15);
            border: 4px solid #FFF;
            width: 100%;
            max-width: 600px;
            aspect-ratio: 1 / 1;
            display: flex;
            justify-content: center;
            align-items: center;
            box-sizing: border-box;
        }

        canvas {
            background-color: #FFFFFF;
            border: 3px solid var(--secondary-color);
            border-radius: 12px;
            display: block;
            touch-action: none;
            box-shadow: inset 0 0 20px rgba(0,0,0,0.02);
            width: 100%;
            height: 100%;
            object-fit: contain;
        }

        #bottom-area {
            width: 95%;
            max-width: 600px;
            display: flex;
            flex-direction: column;
            align-items: center;
            flex-shrink: 0;
        }

        #current-sentence-display {
            margin: 0;
            min-height: 60px; 
            padding: 10px 15px;
            background: #fff;
            border-radius: 15px;
            border: 3px dashed var(--secondary-color);
            width: 100%; 
            text-align: center;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.3rem; 
            color: #ccc; 
            font-weight: bold;
            line-height: 1.4;
            flex-wrap: wrap;
            position: relative;
            box-shadow: 0 5px 10px rgba(0,0,0,0.08);
            box-sizing: border-box;
        }

        .char-eaten { color: var(--secondary-color); text-shadow: 0 0 1px rgba(42, 157, 143, 0.2); transition: color 0.3s; }
        .char-current { color: var(--accent-color); text-decoration: underline; text-underline-offset: 4px; animation: pulseTarget 1.5s infinite; }
        .char-pending { color: #ccc; }
        @keyframes pulseTarget { 0%, 100% { opacity: 1; transform: scale(1); } 50% { opacity: 0.7; transform: scale(1.02); } }
        button { background-color: var(--primary-color); color: white; border: none; padding: 10px 20px; font-size: 1rem; border-radius: 30px; cursor: pointer; font-family: 'Noto Sans TC', sans-serif; font-weight: bold; margin: 5px; transition: all 0.1s; box-shadow: 0 3px 0 rgba(0,0,0,0.1); white-space: nowrap; }
        button:active { transform: translateY(2px); box-shadow: 0 1px 0 rgba(0,0,0,0.1); }
        button.secondary { background-color: var(--secondary-color); }
        button.danger { background-color: var(--accent-color); }
        button.control-btn { background: #fff; color: var(--text-color); border: 2px solid var(--text-color); padding: 6px 10px; font-size: 1.2rem; min-width: 44px; box-shadow: none; }
        input[type="range"] { flex: 1; cursor: pointer; accent-color: var(--primary-color); }
        input[type="text"], select { padding: 10px 14px; font-size: 1rem; border-radius: 12px; border: 2px solid var(--secondary-color); margin-bottom: 5px; width: 100%; box-sizing: border-box; background: #F4F1DE; outline: none; }
        .footer { font-size: 0.8rem; color: #888; margin-top: 5px; flex-shrink: 0; }
        #toast { visibility: hidden; background-color: var(--text-color); color: #fff; text-align: center; border-radius: 25px; padding: 10px 20px; position: fixed; left: 50%; transform: translateX(-50%); bottom: 30px; z-index: 4000; }
        #toast.show { visibility: visible; opacity: 1; bottom: 50px; transition: all 0.3s;}
        .locked-score { color: #999 !important; text-decoration: line-through; opacity: 0.7; }
        .leaderboard-container { width: 100%; min-height: 100px; max-height: 250px; overflow-y: auto; margin: 10px 0; border: 1px solid #eee; border-radius: 10px; -webkit-overflow-scrolling: touch; }
        table.leaderboard-table { width: 100%; border-collapse: collapse; font-size: 1rem; }
        table.leaderboard-table th { background-color: var(--secondary-color); color: white; padding: 10px; position: sticky; top: 0; }
        table.leaderboard-table td { padding: 10px 8px; border-bottom: 1px solid #eee; text-align: center; }
        #ui-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 3000; }
        .screen { background: rgba(255, 255, 255, 0.98); padding: 20px; border-radius: 20px; text-align: center; pointer-events: auto; width: 90%; max-width: 450px; max-height: 85%; overflow-y: auto; box-shadow: 0 15px 30px rgba(38, 70, 83, 0.2); border: 4px solid var(--primary-color); display: flex; flex-direction: column; gap: 10px; animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); align-items: center; position: relative; z-index: 3100; }
        .modal-backdrop { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: rgba(38, 70, 83, 0.5); backdrop-filter: blur(4px); z-index: 2500; }
        @keyframes popIn { from { transform: scale(0.8); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        .hidden { display: none !important; }

        @media (max-width: 600px) {
            h1 { font-size: 1.4rem; }
            #current-sentence-display { font-size: 1.2rem; min-height: 50px; }
            button { padding: 8px 16px; }
        }
    </style>
</head>
<body>

    <div id="backdrop" class="modal-backdrop hidden"></div>

    <h1>ğŸ è¯èªè²ªé£Ÿè›‡ ğŸ</h1>

    <div id="top-controls">
        <div id="score-info">
            <div>å¾—åˆ†: <span id="score-display-wrapper"><span id="score">0</span></span> &nbsp;|&nbsp; <span id="level-info">é—œå¡: 1</span></div>
            <div id="progress-info">é€²åº¦: <span id="progress-current">0</span> / <span id="progress-total">0</span></div>
            <div id="lives">â¤ï¸â¤ï¸â¤ï¸</div>
        </div>
        <div style="display: flex; gap: 5px;">
            <button class="control-btn" id="sound-btn" onclick="window.toggleSound()">ğŸ”Š</button>
            <button class="control-btn" id="pause-btn" onclick="window.togglePause()">â¸ï¸</button>
            <button class="control-btn" id="exit-btn" onclick="window.triggerQuit()">ğŸ </button>
        </div>
    </div>

    <div id="game-controls-container">
        <div class="speed-slider-container">
            <label>ğŸ¢ æ…¢</label>
            <input type="range" id="speed-slider" min="2" max="15" value="5" oninput="window.updateSpeedFromSlider(this.value)">
            <label>ğŸš€ å¿«</label>
            <span id="speed-val" style="margin-left: 5px; font-weight: bold; min-width: 25px;">5</span>
        </div>
    </div>

    <div id="online-status-bar">ğŸŸ¡ é€£ç·šä¸­...</div>

    <div id="game-wrapper-flex">
        <div id="game-container">
            <canvas id="gameCanvas" width="600" height="600"></canvas>
            
            <div id="pause-overlay" class="hidden" style="position:absolute; top:0; left:0; width:100%; height:100%; display:flex; justify-content:center; align-items:center; background:rgba(255,255,255,0.7); border-radius:12px; z-index: 10; backdrop-filter: blur(2px);">
                <div style="background:white; padding:20px 40px; border-radius:20px; font-size:3rem; font-weight:bold; border:4px solid var(--primary-color); color: var(--text-color); box-shadow: 0 10px 25px rgba(0,0,0,0.1);">æš«åœ</div>
            </div>

            <div id="ui-layer">
                <div id="start-screen" class="screen">
                    <h2 id="start-title" style="margin: 0 0 5px 0; color: var(--primary-color); font-size: 1.8rem;">æº–å‚™å¥½äº†å—ï¼Ÿ</h2>
                    <input type="text" id="player-name" placeholder="è«‹è¼¸å…¥åå­—" maxlength="8">
                    
                    <label style="font-size: 1rem; font-weight: bold; color:#555; align-self: start; margin-left: 5px; margin-top: 5px;">é¸æ“‡èª²ç¨‹ï¼š</label>
                    <div style="display: flex; gap: 5px; width: 100%; margin-bottom: 10px;">
                        <select id="lesson-select">
                            <option value="1">ç¬¬ 1 èª²ï¼šæ–°åŒå­¸</option>
                            <option value="2">ç¬¬ 2 èª²ï¼šæˆ‘çˆ¸çˆ¸åšç”Ÿæ„</option>
                            <option value="3">ç¬¬ 3 èª²ï¼šå»è¶…ç´šå¸‚å ´</option>
                            <option value="4">ç¬¬ 4 èª²ï¼šæˆ‘æƒ³åƒæ¼¢å ¡</option>
                            <option value="5">ç¬¬ 5 èª²ï¼šæ˜¥å¤©å¿«åˆ°äº†</option>
                            <option value="6">ç¬¬ 6 èª²ï¼šè¾²æ›†æ–°å¹´</option>
                            <option value="7">ç¬¬ 7 èª²ï¼šæ—©ä¸€é»ç¡è¦º</option>
                            <option value="8">ç¬¬ 8 èª²ï¼šæˆ‘çš„å¯µç‰©</option>
                            <option value="9">ç¬¬ 9 èª²ï¼šéŸ³æ¨‚æ•™å®¤åœ¨åŒ—æ–¹</option>
                            <option value="10">ç¬¬ 10 èª²ï¼šå¤–å…¬å¤–å©†ä½è‡ºç£</option>
                            <option value="11">ç¬¬ 11 èª²ï¼šå»å‹•ç‰©åœ’</option>
                            <option value="12">ç¬¬ 12 èª²ï¼šæ‰“ç¶²è·¯é›»è©±</option>
                            <option value="all">ğŸ“š å…¨éƒ¨è¤‡ç¿’ (1-12èª²)</option>
                        </select>
                        <button class="secondary" onclick="window.shareLesson()" style="margin: 0; padding: 0 20px;">ğŸ”—</button>
                    </div>
                    
                    <div style="display: flex; flex-direction: column; gap: 10px; width: 100%;">
                        <button onclick="window.startGame()" style="width: 100%;">é–‹å§‹éŠæˆ² â–¶ï¸</button>
                        <div style="display: flex; gap: 10px; width: 100%;">
                            <button class="secondary" onclick="window.showLeaderboardModal()" style="flex:1;">ğŸ† æ’è¡Œæ¦œ</button>
                            <button class="secondary" onclick="window.showHelpModal()" style="flex:1;">â“ éŠæˆ²èªªæ˜</button>
                        </div>
                    </div>
                </div>

                <div id="help-modal" class="screen hidden" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 3500; text-align: left;">
                    <h2 style="color: var(--secondary-color); margin: 0 0 10px 0; font-size: 1.8rem; text-align: center;">ğŸ éŠæˆ²èªªæ˜</h2>
                    <div style="font-size: 1.05rem; line-height: 1.6; color: var(--text-color);">
                        <p style="margin: 8px 0;">ğŸ¯ <b>ä»»å‹™ï¼š</b>ç…§é †åºåƒæ‰å‡ºç¾çš„å­—ï¼Œå®Œæˆèª²æ–‡å¥å­ã€‚åƒå°åŠ åˆ†ï¼ŒåƒéŒ¯æ‰£åˆ†ï¼</p>
                        <p style="margin: 8px 0;">ğŸ® <b>æ“ä½œï¼š</b><br>ğŸ’» é›»è…¦ï¼š<code>W A S D</code> æˆ– <code>â¬†ï¸â¬‡ï¸â¬…ï¸â¡ï¸</code><br>ğŸ“± æ‰‹æ©Ÿï¼šåœ¨ç•«é¢ä¸Š ğŸ‘† æ»‘å‹•æ–¹å‘</p>
                        <p style="margin: 8px 0;">âœ¨ <b>é“å…·ï¼š</b><br>
                            ğŸ <b>æ°´æœï¼š</b>å¥½é‹åŠ  100 åˆ†ï¼<br>
                            ğŸ’£ <b>ç‚¸å½ˆï¼š</b>æ‰£ 50 åˆ†ï¼Œé‚„æœƒçœ¼å†’é‡‘æ˜Ÿï¼<br>
                            â¤ï¸ <b>æ„›å¿ƒï¼š</b>è£œè¡€ 1 æ»´ï¼ˆä¸Šé™ 3 æ»´è¡€ï¼‰ã€‚
                        </p>
                        <p style="margin: 8px 0; color: var(--accent-color);">âš ï¸ <b>æ³¨æ„ï¼š</b>æ’åˆ°è‡ªå·±çš„èº«é«”æœƒæ‰£è¡€å–”ï¼</p>
                    </div>
                    <button class="secondary" onclick="window.hideHelpModal()" style="width: 100%; margin-top: 15px;">æˆ‘çŸ¥é“äº†</button>
                </div>

                <div id="revive-modal" class="screen hidden">
                    <h2 style="color: var(--accent-color); margin: 0 0 10px 0; font-size: 1.6rem;">ğŸ’” æ„›å¿ƒç”¨å…‰äº†ï¼</h2>
                    <p style="margin: 5px 0; font-size: 1.1rem;">åˆ¥æ°£é¤’ï¼Œæˆ‘å€‘æŠŠå‰©ä¸‹çš„ç·´ç¿’åšå®Œå§ï¼</p>
                    <div style="margin-bottom: 15px; color: #555;">(é‚„æœ‰ <span id="revive-remaining">0</span> å€‹å¥å­)</div>
                    <button onclick="window.reviveGame()" style="font-size: 1.2rem; padding: 12px 30px; width: 100%;">ğŸ’ª å¾©æ´»ç¹¼çºŒ</button>
                    <button class="secondary" onclick="window.showStartScreen()">çµæŸç·´ç¿’</button>
                </div>

                <div id="lesson-complete-screen" class="screen hidden">
                    <h2 style="margin: 0; color: var(--primary-color);">ğŸ‰ æ­å–œå®Œæˆï¼</h2>
                    <div style="background: #f0f0f0; padding: 15px; border-radius: 15px; width: 100%; box-sizing: border-box;">
                        <p id="complete-lesson-name" style="font-size: 1.2rem; font-weight: bold; margin: 5px 0;"></p>
                        <p style="margin: 10px 0; font-size: 1.4rem;">ç¸½å¾—åˆ†ï¼š<span id="complete-score" style="color: var(--accent-color); font-weight: 900;">0</span></p>
                    </div>
                    <div style="display: flex; gap: 10px; justify-content: center; width: 100%; margin-top: 10px;">
                        <button onclick="window.resetGame()" style="flex: 1;">å†è¤‡ç¿’ä¸€æ¬¡ ğŸ”„</button>
                        <button class="secondary" onclick="window.showStartScreen()" style="flex: 1;">å›é¦–é  ğŸ </button>
                    </div>
                </div>

                <div id="leaderboard-modal" class="screen hidden" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 3500;">
                    <h2 style="color: var(--secondary-color); margin: 0 0 10px 0; font-size: 1.8rem;">ğŸ† æ­·å²æ¦®è­½æ¦œ</h2>
                    <div class="leaderboard-container">
                        <table class="leaderboard-table">
                            <thead>
                                <tr><th>åæ¬¡</th><th>åå­—</th><th>åˆ†æ•¸</th><th>èª²ç¨‹</th></tr>
                            </thead>
                            <tbody id="leaderboard-body-modal"></tbody>
                        </table>
                    </div>
                    <button class="secondary" onclick="window.hideLeaderboardModal()">é—œé–‰</button>
                </div>

                <div id="quit-modal" class="screen hidden">
                    <h2 style="color: var(--accent-color); margin: 0 0 10px 0;">ç¢ºå®šè¦é›¢é–‹å—ï¼Ÿ</h2>
                    <p style="margin: 10px 0;">ç›®å‰çš„éŠæˆ²é€²åº¦æœƒæ¶ˆå¤±å–”ï¼</p>
                    <div style="display: flex; gap: 10px; justify-content: center; width: 100%;">
                        <button class="danger" onclick="window.confirmQuit()" style="flex: 1;">ç¢ºå®šé›¢é–‹</button>
                        <button class="secondary" onclick="window.cancelQuit()" style="flex: 1;">å–æ¶ˆ</button>
                    </div>
                </div>
                
                <div id="game-over-screen" class="screen hidden">
                    <h2 id="game-over-title" style="margin: 0; color: var(--text-color);">ğŸ˜² éŠæˆ²çµæŸï¼</h2>
                    <div style="background: #f0f0f0; padding: 15px; border-radius: 15px; width: 100%; box-sizing: border-box;">
                        <p id="game-over-lesson" style="font-size: 1.1rem; color: #555; margin: 5px 0;"></p>
                        <p style="margin: 5px 0; font-size: 1.3rem;"><span id="game-over-name">ä½ </span>çš„æœ€çµ‚å¾—åˆ†</p>
                        <p style="margin: 0; font-size: 3rem; color: var(--accent-color); font-weight: 900; line-height: 1;"><span id="final-score">0</span></p>
                    </div>
                    <div style="display: flex; gap: 10px; justify-content: center; width: 100%; margin-top: 10px;">
                        <button onclick="window.resetGame()" style="flex: 1;">å†ç©ä¸€æ¬¡ ğŸ”„</button>
                        <button class="secondary" onclick="window.showStartScreen()" style="flex: 1;">æ›èª²æ–‡ ğŸ“–</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="bottom-area">
        <div id="current-sentence-display">æº–å‚™é–‹å§‹...<button id="replay-btn" onclick="window.replayCurrentAudio()">ğŸ”Š</button></div>
        <div class="footer">Design by Sophia Wong</div>
    </div>
    <div id="toast"></div>

<!-- Firebase Logic -->
<script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js';
    import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js';
    import { getFirestore, collection, doc, setDoc, addDoc, onSnapshot } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js';

    let firebaseConfig;
    if (typeof __firebase_config !== 'undefined') {
        try { firebaseConfig = JSON.parse(__firebase_config); } catch (e) { console.warn("Environment config parse error"); }
    }
    
    if (!firebaseConfig) {
        firebaseConfig = {
            apiKey: "AIzaSyBQI17CXEhD5mJhDCid-mt0cAL6qvdcAiA",
            authDomain: "chinses-snake-game.firebaseapp.com",
            projectId: "chinses-snake-game",
            storageBucket: "chinses-snake-game.firebasestorage.app",
            messagingSenderId: "239140560404",
            appId: "1:239140560404:web:dd5ead9018a0f0e5ad5101"
        };
    }

    const appId = (typeof __app_id !== 'undefined' ? __app_id : 'default-app').replace(/\//g, '_');
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    let isOffline = false;

    setTimeout(() => {
        const bar = document.getElementById('online-status-bar');
        if (bar && bar.innerText.includes("é€£ç·šä¸­")) {
            bar.innerText = "ğŸ”´ å–®æ©Ÿæ¨¡å¼ (é€£ç·šé€¾æ™‚)";
            isOffline = true;
        }
    }, 5000);

    const initAuth = async () => {
        try {
            if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) await signInWithCustomToken(auth, __initial_auth_token);
            else await signInAnonymously(auth);
        } catch (e) { 
            isOffline = true; 
            const bar = document.getElementById('online-status-bar');
            if(bar) bar.innerText = "ğŸ”´ å–®æ©Ÿæ¨¡å¼ (é€£ç·šå¤±æ•—)";
        }
    };

    onAuthStateChanged(auth, (user) => {
        if (user && !isOffline) {
            startFirebaseListeners();
            const bar = document.getElementById('online-status-bar');
            if(bar) bar.innerText = "ğŸŸ¢ å·²é€£ç·š";
            const savedName = localStorage.getItem('snake_player_name') || "è¨ªå®¢";
            window.sendHeartbeat(savedName, "é¦–é ");
        }
    });

    function startFirebaseListeners() {
        if (!auth.currentUser) return;
        onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'presence'), (snap) => {
            const now = Date.now(), online = [];
            snap.forEach(doc => {
                const d = doc.data();
                if (d.name && d.lastSeen && (now - d.lastSeen < 300000)) online.push(d);
            });
            const unique = []; const seen = new Set();
            online.forEach(p => { if(!seen.has(p.name)) { seen.add(p.name); unique.push(p); }});
            const el = document.getElementById('online-status-bar');
            if(el) {
                const currentName = localStorage.getItem('snake_player_name') || "è¨ªå®¢";
                if (unique.length <= 1) el.innerHTML = "ğŸŸ¢ åœ¨ç·šåŒå­¸ï¼šç›®å‰åªæœ‰ä½ ";
                else el.innerHTML = "ğŸŸ¢ åœ¨ç·šåŒå­¸ï¼š " + unique.map(p => p.name === currentName ? `<b style="color:var(--secondary-color)">${p.name}(ä½ )</b>` : p.name).join(', ');
            }
        }, (err) => console.warn("Presence locked."));

        onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'leaderboard'), (snap) => {
            const scores = [];
            snap.forEach(doc => { const d = doc.data(); if(d.name && d.score != null) scores.push(d); });
            scores.sort((a,b) => b.score - a.score);
            const rows = scores.slice(0, 10).map((s, i) => `<tr><td>${i+1}</td><td>${s.name}</td><td>${s.score}</td><td>${s.lesson}</td></tr>`).join('');
            const body = document.getElementById('leaderboard-body-modal');
            if(body) body.innerHTML = rows || "<tr><td colspan='4' style='padding:20px; color:#999;'>å°šç„¡ç´€éŒ„<br>å¿«ä¾†ç•¶ç¬¬ä¸€åï¼</td></tr>";
        }, (err) => console.warn("Leaderboard locked."));
    }

    window.sendHeartbeat = async (name, lesson) => {
        if (isOffline || !auth.currentUser) return;
        try { await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'presence', auth.currentUser.uid), { name, lesson, lastSeen: Date.now() }, { merge: true }); } catch (e) {}
    };
    
    window.saveScoreToCloud = async (name, score, lessonName) => {
        if (isOffline || !auth.currentUser) return;
        try { await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'leaderboard'), { name, score, lesson: lessonName, timestamp: Date.now() }); } catch (e) {}
    };
    initAuth();
</script>

<script>
    const gridSize = 50, tileCount = 12; 
    const fruitIcons = ['ğŸ', 'ğŸŒ', 'ğŸ‡', 'ğŸŠ', 'ğŸ“', 'ğŸ‰', 'ğŸ’', 'ğŸ‘', 'ğŸ', 'ğŸ¥'];
    
    const rawLessonData = {
        "1": ["è€å¸«ï¼šä»Šå¤©ï¼Œæˆ‘å€‘æœ‰å…©å€‹æ–°åŒå­¸ã€‚","å‹æœ‹ï¼šå¤§å®¶å¥½ï¼Œæˆ‘å«æ–¹å‹æœ‹ï¼Œä»Šå¹´å…«æ­²ã€‚","å‹æœ‹ï¼šæˆ‘æœ€å–œæ­¡è·Ÿçˆ¸çˆ¸ä¸€èµ·æ¸¸æ³³ã€‚","å¼µè‰ï¼šå¤§å®¶å¥½ï¼Œæˆ‘å«å¼µè‰ï¼Œä»Šå¹´ä¸ƒæ­²ã€‚","å¼µè‰ï¼šæˆ‘æ¯”è¼ƒå–œæ­¡çœ‹æ›¸ã€‚","å¤§æ–‡ï¼šä½ å€‘å¥½ï¼Œæˆ‘å«æå¤§æ–‡ã€‚","å¤§æ–‡ï¼šå¾ˆé«˜èˆˆèªè­˜ä½ å€‘ã€‚","è€å¸«ï¼šæ­¡è¿ä½ å€‘ä¾†ä¸­æ–‡å­¸æ ¡å­¸è¯èªã€‚"],
        "2": ["å¤§æ–‡ï¼šå¼µè‰ï¼Œç…§ç‰‡è£¡é¢çš„äººæ˜¯èª°ï¼Ÿ","å¼µè‰ï¼šå·¦é‚Šæ˜¯æˆ‘å¤–å…¬ï¼Œä»–ä»¥å‰æ˜¯é†«ç”Ÿã€‚","å¼µè‰ï¼šå³é‚Šæ˜¯æˆ‘å¤–å©†ã€‚","å¤§æ–‡ï¼šä½ çˆ¸çˆ¸åª½åª½åšä»€éº¼å·¥ä½œï¼Ÿ","å¼µè‰ï¼šæˆ‘çˆ¸çˆ¸åšç”Ÿæ„ï¼Œæˆ‘åª½åª½å¹«ä»–ã€‚","å¼µè‰ï¼šä½ çˆ¸çˆ¸åª½åª½å‘¢?","å¤§æ–‡ï¼šæˆ‘çˆ¸çˆ¸åœ¨é›»è…¦å…¬å¸ä¸Šç­ã€‚","å¤§æ–‡ï¼šæˆ‘åª½åª½åœ¨éŠ€è¡Œå·¥ä½œã€‚","å¤§æ–‡ï¼šä½ ä»¥å¾Œæƒ³åšä»€éº¼ï¼Ÿ","å¼µè‰ï¼šæˆ‘ä»¥å¾Œæƒ³è·Ÿçˆ¸çˆ¸ä¸€æ¨£ã€‚"],
        "3": ["å¤§æ–‡ï¼šåª½åª½ï¼Œä½ è¦å»å“ªè£¡ï¼Ÿ","åª½åª½ï¼šæˆ‘è¦å»é™„è¿‘çš„è¶…ç´šå¸‚å ´è²·æ±è¥¿ã€‚","åª½åª½ï¼šä½ è¦è·Ÿæˆ‘ä¸€èµ·å»å—ï¼Ÿ","å¤§æ–‡ï¼šè¦ï¼Œæˆ‘æƒ³å»è²·å·§å…‹åŠ›å†°æ·‡æ·‹ã€‚","å¤§æ–‡ï¼šä½ ä»Šå¤©è¦è²·ä»€éº¼ï¼Ÿ","åª½åª½ï¼šæˆ‘ä»Šå¤©è¦è²·é­šã€ç‰›è‚‰ã€é’èœï¼Œé‚„è¦è²·ç±³ã€‚","å¤§æ–‡ï¼šæˆ‘ä¹Ÿå¯ä»¥è²·ç³–æœå—ï¼Ÿ","åª½åª½ï¼šæˆ‘å€‘å»çœ‹ä¸€ä¸‹å§ï¼"],
        "4": ["æ–‡æ–‡ï¼šæˆ‘æƒ³åƒæ¼¢å ¡è·Ÿè–¯æ¢ã€‚","æ–‡æ–‡ï¼šæˆ‘å€‘å¯ä¸å¯ä»¥å‡ºå»åƒï¼Ÿ","åª½åª½ï¼šä»Šå¤©å…ˆåœ¨å®¶åƒï¼Œé€±æœ«å†å‡ºå»åƒå§ï¼","åª½åª½ï¼šä»Šå¤©æ™šé¤æƒ³åƒä»€éº¼ï¼Ÿ","å¤§æ–‡ï¼šæˆ‘æƒ³åƒéºµã€‚æ–‡æ–‡ï¼Œä½ å‘¢ï¼Ÿ","æ–‡æ–‡ï¼šæˆ‘æƒ³åƒè›‹ç‚’é£¯ï¼Œæœ‰æ¹¯å—ï¼Ÿ","åª½åª½ï¼šæˆ‘å·²ç¶“åšäº†ç‰ç±³æ¹¯ã€‚","å¤§æ–‡ï¼šåª½ï¼Œæˆ‘ç¾åœ¨å¾ˆé¤“ï¼Œæƒ³å¿«é»åƒæ™šé£¯ï¼Œå¥½å—ï¼Ÿ"],
        "5": ["å¤§æ–‡ï¼šä½ çœ‹ï¼æ¨¹è‘‰è®Šé»ƒäº†ï¼Œç§‹å¤©å¿«åˆ°äº†ã€‚","å¼µè‰ï¼šå¯æ˜¯è‰é‚„æ˜¯ç¶ è‰²çš„ã€‚","å¿ƒç¾ï¼šç§‹å¤©å¤©æ°£å¾ˆå¥½ã€‚æˆ‘è¦ºå¾—å¾ˆèˆ’æœã€‚","æ±æ˜ï¼šæ˜¥å¤©ä¹Ÿä¸éŒ¯ã€‚","å¤§æ–‡ï¼šæ˜¥å¤©çš„æ™‚å€™ï¼Œæˆ‘å€‘å®¶é™¢å­æœ‰å¾ˆå¤šé¡è‰²çš„èŠ±ã€‚","å¤§æ–‡ï¼šç´…è‰²çš„ã€ç™½è‰²çš„éƒ½æœ‰ã€‚","å¿ƒç¾ï¼šæˆ‘è¦ºå¾—ç´…è‰²çš„èŠ±æœ€æ¼‚äº®ã€‚"],
        "6": ["å¤§æ–‡ï¼šè€å¸«èªªè¾²æ›†æ–°å¹´å¿«åˆ°äº†ã€‚","çˆ¸çˆ¸ï¼šå°ï¼Œä¸‹å€‹æ˜ŸæœŸäº”æ˜¯è¾²æ›†æ–°å¹´ã€‚","å¤§æ–‡ï¼šåª½åª½æœƒå»è¯äººè¶…å¸‚è²·å¹´ç³•å—ï¼Ÿ","çˆ¸çˆ¸ï¼šæœƒï¼Œé‚£å¤©æˆ‘å€‘é‚„è¦çµ¦çˆºçˆºå¥¶å¥¶æ‹œå¹´ã€‚","å¤§æ–‡ï¼šå¤ªå¥½äº†ï¼Œçˆºçˆºæ¯å¹´éƒ½æœƒçµ¦æˆ‘ç´…åŒ…ã€‚","çˆ¸çˆ¸ï¼šå¦‚æœåœ¨è‡ºç£ï¼Œæˆ‘å€‘é‚„æœƒè²¼æ˜¥è¯ã€æ”¾é­ç‚®ã€‚"],
        "7": ["çˆ¸çˆ¸ï¼šå¤§æ–‡ï¼Œè©²èµ·åºŠäº†ï¼ä¾†ä¸åŠäº†ï¼","å¤§æ–‡ï¼šæˆ‘å¾ˆç´¯ï¼Œé‚„æƒ³ç¡è¦ºã€‚","çˆ¸çˆ¸ï¼šä»Šå¤©æ™šä¸Šæ—©ä¸€é»ç¡,ç¾åœ¨è¶•å¿«å»åˆ·ç‰™ã€æ´—æ¾¡ã€‚","å¤§æ–‡ï¼šæˆ‘æ˜¨å¤©æ™šä¸Šæ´—éæ¾¡äº†ã€‚","çˆ¸çˆ¸ï¼šé‚„æœ‰ï¼Œåˆ¥å¿˜äº†ç”¨è‚¥çš‚æ´—è‡‰ã€‚","å¤§æ–‡ï¼šæˆ‘çŸ¥é“äº†ï¼Œè¦æ´—ä¹¾æ·¨ã€‚"],
        "8": ["å¿ƒç¾ï¼šæ˜¨å¤©æˆ‘çˆ¸çˆ¸çš„æœ‹å‹é€çµ¦æˆ‘ä¸€éš»ç‹—ã€‚","å¿ƒç¾ï¼šä½ å€‘å®¶æœ‰å¯µç‰©å—ï¼Ÿ","å¤§æ–‡ï¼šæœ‰ï¼Œæˆ‘å®¶æœ‰å…©éš»ç‹—ï¼Œæˆ‘æ¯å¤©éƒ½å¸¶ç‰ å€‘å»æ•£æ­¥ã€‚","å¿ƒç¾ï¼šå¼µè‰ï¼Œä½ é¤Šéç‹—å—ï¼Ÿ","å¼µè‰ï¼šæˆ‘æ²’é¤Šéç‹—ï¼Œæˆ‘å»å¹´é¤Šäº†ä¸€éš»è²“ï¼Œå¯æ˜¯ä¸Šå€‹æœˆä¸è¦‹äº†ã€‚","å‹æœ‹ï¼šæˆ‘ä¹Ÿé¤Šéè²“ï¼Œéå¸¸å¯æ„›ï¼Œæˆ‘æ¯å¤©éƒ½é¤µç‰ ã€‚","å¼µè‰ï¼šä»¥å¾Œæˆ‘æƒ³é¤Šä¸€éš»å…”å­ã€‚"],
        "9": ["å‹æœ‹ï¼šæ±æ˜ï¼Œé€™æ˜¯ä»€éº¼ï¼Ÿ","æ±æ˜ï¼šæŒ‡å—é‡ï¼Œä¹Ÿå«æŒ‡åŒ—é‡ï¼Œå®ƒå‘Šè¨´æˆ‘å€‘å—æ–¹å’ŒåŒ—æ–¹åœ¨å“ªè£¡ã€‚","å‹æœ‹ï¼šéŸ³æ¨‚æ•™å®¤æ˜¯ä»€éº¼æ–¹å‘ï¼Ÿ","æ±æ˜ï¼šéŸ³æ¨‚æ•™å®¤åœ¨åŒ—æ–¹ï¼Œæ ¡é–€å£åœ¨å—æ–¹ã€‚","å‹æœ‹ï¼šè¶³çƒå ´åœ¨æ±æ–¹ï¼Œé‚„æ˜¯è¥¿æ–¹ï¼Ÿ","æ±æ˜ï¼šå› ç‚ºéŸ³æ¨‚æ•™å®¤åœ¨åŒ—æ–¹ï¼Œæ‰€ä»¥è¶³çƒå ´åœ¨æ±æ–¹ã€‚"],
        "10": ["å¿ƒç¾ï¼šæš‘å‡çš„æ™‚å€™ï¼Œæˆ‘æœƒå»è‡ºç£çœ‹å¤–å…¬ã€å¤–å©†ã€‚","å¼µè‰ï¼šä½ å¤–å…¬ã€å¤–å©†å®¶åœ¨å“ªè£¡ï¼Ÿ","å¿ƒç¾ï¼šä»–å€‘æœ¬ä¾†ä½åœ¨è‡ºåŒ—ï¼Œé€€ä¼‘ä»¥å¾Œï¼Œè·Ÿæˆ‘çš„èˆ…èˆ…ä½åœ¨è‡ºå—ã€‚","å¼µè‰ï¼šä½ å€‘æ¯å¹´éƒ½å»çœ‹å¤–å…¬å¤–å©†å—ï¼Ÿ","å¿ƒç¾ï¼šæˆ‘å€‘æ¯å¹´éƒ½å»çœ‹ä»–å€‘ä¸€æ¬¡ï¼Œä½ å¤–å…¬å¤–å©†ä½åœ¨å“ªè£¡ï¼Ÿ","å¼µè‰ï¼šæˆ‘å¤–å…¬ã€å¤–å©†ç¾åœ¨ä½åœ¨ç´ç´„ï¼Œä»–å€‘ä¸‹å€‹æœˆæœƒä¾†çœ‹æˆ‘å€‘ã€‚", "å¿ƒç¾ï¼šæˆ‘å¤–å…¬ã€å¤–å©†å–œæ­¡æ—…è¡Œï¼Œå¸¸å¸¸ä¾†çœ‹æˆ‘å€‘ï¼Œä¹Ÿå¸¸å»æ³•åœ‹çœ‹é˜¿å§¨ã€‚"],
        "11": ["å¿ƒç¾ï¼šä¸‹å€‹æ˜ŸæœŸäº”ï¼Œå­¸æ ¡è¦å¸¶æˆ‘å€‘å»å‹•ç‰©åœ’ç©ã€‚","å¿ƒç¾å“¥å“¥ï¼šå¤ªå¥½äº†ï¼ä½ å¯ä»¥çœ‹åˆ°ä½ å–œæ­¡çš„å¤§è±¡å’Œè€è™ã€‚", "å¿ƒç¾ï¼šé€™ä¸€æ¬¡æˆ‘å¸Œæœ›å¯ä»¥çœ‹åˆ°ç†Šè²“å’ŒçŒ´å­ã€‚", "å¿ƒç¾å“¥å“¥ï¼šå°ï¼Œä»¥å‰æˆ‘å»çš„æ™‚å€™ï¼Œå‹•ç‰©åœ’æ²’æœ‰ç†Šè²“ã€‚", "çˆ¸çˆ¸ï¼šç¾åœ¨ä¸ä½†æœ‰ç†Šè²“ï¼Œé‚„æœ‰ä¼éµã€‚", "å¿ƒç¾ï¼šæˆ‘è¦ºå¾—ç†Šè²“èƒ–èƒ–çš„ï¼ŒçœŸå¯æ„›ï¼", "å¿ƒç¾å“¥å“¥ï¼šæˆ‘å–œæ­¡é•·é ¸é¹¿ï¼Œè„–å­é•·é•·çš„ã€‚"],
        "12": ["çˆ¸çˆ¸ï¼šå¤§æ–‡ï¼Œæˆ‘ç¾åœ¨è¦ç”¨ç¶²è·¯çµ¦å§‘å§‘æ‰“é›»è©±ã€‚", "å¤§æ–‡ï¼šå¯ä»¥çœ‹åˆ°å§‘å§‘å—ï¼Ÿæˆ‘å¾ˆä¹…æ²’è·Ÿå§‘å§‘èªªè©±äº†ã€‚", "çˆ¸çˆ¸ï¼šå¯ä»¥çœ‹åˆ°å¥¹çš„å½±åƒï¼Œå¿«ä¸€é»éä¾†ã€‚", "å§‘å§‘ï¼šå¤§æ–‡ï¼Œä½ çœ‹èµ·ä¾†ç˜¦äº†ã€‚", "å¤§æ–‡ï¼šæˆ‘æ²’ç˜¦ï¼Œæˆ‘é•·é«˜äº†ã€‚", "å§‘å§‘ï¼šæ–‡æ–‡ç¾åœ¨ä¹Ÿè·Ÿä½ ä¸€èµ·å»å­¸è¯èªå—?", "å¤§æ–‡ï¼šæ˜¯å•Šï¼ä¸Šä¸­æ–‡èª²å¾ˆæœ‰æ„æ€ã€‚", "å§‘å§‘ï¼šä½ å¥½å¥½å­¸è¯èªï¼Œä»¥å¾Œå¯ä»¥ç”¨ç¶²è·¯çµ¦æˆ‘å¯«ä¿¡ã€‚", "å¤§æ–‡ï¼šæ²’å•é¡Œï¼Œæˆ‘ä¸€å®šæœƒå¥½å¥½å­¸è¯èªã€‚"]
    };
    const lessonData = {};
    for (let key in rawLessonData) { lessonData[key] = rawLessonData[key].map(s => s.replace(/^[^ï¼š]+ï¼š/, '')); }

    let canvas, ctx, gameLoop = null, speed = 5, score = 0, lives = 3, ouchTimer = 0, happyTimer = 0;
    let isGameRunning = false, isPaused = false, isTransitioning = false, isRevived = false;
    let snake = [], foodItems = [], bonusItem = {active:false}, bombItem = {active:false}, heartItem = {active:false};
    let dx = 1, dy = 0, particles = [], popups = [];
    let currentLessonSentences, availableIndices, currentSentence, charIndex, eatenSentenceChars = [];
    let sentencesCompleted = 0, totalSentencesCount = 0, playerName = "", isSoundOn = true;

    const AudioContext = window.AudioContext || window.webkitAudioContext;
    let audioCtx; try { audioCtx = new AudioContext(); } catch(e) {}

    // --- 2. å·¥å…·å‡½å¼ (Utility Functions) ---
    function stopGameLoop() { if(gameLoop) { clearInterval(gameLoop); gameLoop = null; } }
    function resetSnakePos() { snake = [{ x: 5, y: 5 }, { x: 4, y: 5 }, { x: 3, y: 5 }]; dx = 1; dy = 0; }
    function updateLivesDisplay() { let h = ""; for(let i=0; i<lives; i++) h += "â¤ï¸"; for(let i=lives; i<3; i++) h += "ğŸ–¤"; const el = document.getElementById('lives'); if(el) el.innerText = h; }
    function getFreePosition() {
        let p = { x: 0, y: 0 }, v = false, a = 0;
        while (!v && a < 100) {
            v = true; p.x = Math.floor(Math.random() * tileCount); p.y = Math.floor(Math.random() * tileCount);
            if (snake.some(s => s.x === p.x && s.y === p.y)) v = false;
            if (foodItems.some(f => f.x === p.x && f.y === p.y)) v = false;
            if (bonusItem.active && bonusItem.x === p.x && bonusItem.y === p.y) v = false;
            if (bombItem.active && bombItem.x === p.x && bombItem.y === p.y) v = false;
            if (heartItem.active && heartItem.x === p.x && heartItem.y === p.y) v = false;
            a++;
        }
        return p;
    }
    function spawnPopup(x, y, text, color) { popups.push({ x: x * gridSize + 25, y: y * gridSize, text, life: 1, color }); }
    
    // --- å¼·åŒ–ç‰ˆç²’å­ç‰¹æ•ˆå‡½å¼ ---
    function spawnParticles(gx, gy, color, customEmojis = null) {
        let icons = customEmojis || ['âœ¨', 'â­'];
        let isExplosion = false;
        let count = 4;

        // å¦‚æœæ˜¯ç‚¸å½ˆï¼Œè¨­å®šç‚ºçˆ†ç‚¸æ¨¡å¼
        if (icons.includes('ğŸ’¥') || icons.includes('ğŸ’€')) { 
            isExplosion = true; 
            count = 8; 
        }

        for(let i=0; i<count; i++) {
            let vx, vy;
            if (isExplosion) {
                // çˆ†ç‚¸ï¼šå‘å››é¢å…«æ–¹é£›æ•£
                vx = (Math.random() - 0.5) * 12; 
                vy = (Math.random() - 0.5) * 12;
            } else {
                // é£„å‹•ï¼šä¸»è¦å‘ä¸Šé£„
                vx = (Math.random() - 0.5) * 4; 
                vy = -Math.random() * 2 - 2; 
            }
            particles.push({ 
                x: gx * gridSize + 25, 
                y: gy * gridSize + 25, 
                vx: vx, 
                vy: vy, 
                life: 1, 
                emoji: icons[Math.floor(Math.random() * icons.length)] 
            });
        }
    }

    function isPunctuation(c) { return /[ï¼Œã€‚ã€ï¼Ÿï¼ï¼šï¼›ã€Œã€ã€ã€\s,.?!:;"'()ï¼ˆï¼‰]/.test(c); }
    function getCorrectAudioText(c, i, s) { 
        if (c === 'é•·' && (s[i+1] === 'å¤§' || s[i+1] === 'é«˜')) return 'æŒ'; 
        if (c === 'è¦º' && s[i-1] === 'ç¡') return 'å«';
        if (c === 'æ¨‚' && s[i-1] === 'éŸ³') return 'æœˆ';
        if (c === 'éƒ½') return 'å…œ'; 
        if (c === 'ä»€') return 'ç¥';
        if (c === 'èˆˆ' && s[i-1] === 'é«˜') return 'å¹¸';
        return c; 
    }
    function speakText(t) { 
        if (!isSoundOn) return; window.speechSynthesis.cancel(); 
        let proc = ""; for(let i=0; i<t.length; i++) proc += getCorrectAudioText(t[i], i, t);
        const u = new SpeechSynthesisUtterance(proc); u.lang = 'zh-TW'; u.rate = 0.85; window.speechSynthesis.speak(u); 
    }
    function playTone(freq, duration) { if (!isSoundOn || !audioCtx) return; if (audioCtx.state === 'suspended') audioCtx.resume(); const o = audioCtx.createOscillator(), g = audioCtx.createGain(); o.frequency.setValueAtTime(freq, audioCtx.currentTime); g.gain.setValueAtTime(0.1, audioCtx.currentTime); g.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + duration); o.connect(g); g.connect(audioCtx.destination); o.start(); o.stop(audioCtx.currentTime + duration); }
    function playEatSound() { playTone(440, 0.1); }
    function playBonusSound() { playTone(523, 0.1); setTimeout(() => playTone(659, 0.2), 100); }
    function playLevelUpSound() { playTone(523, 0.1); setTimeout(() => playTone(783, 0.2), 200); }
    function playCrashSound() { playTone(150, 0.3); }
    function playErrorSound() { playTone(150, 0.2); }
    function playHealSound() { playTone(400, 0.1); setTimeout(() => playTone(600, 0.2), 100); }

    function loadSentences() {
        const val = document.getElementById('lesson-select').value;
        currentLessonSentences = val === "all" ? [].concat(...Object.values(lessonData)) : (lessonData[val] || lessonData["1"]);
        availableIndices = currentLessonSentences.map((_, i) => i);
        sentencesCompleted = 0; totalSentencesCount = currentLessonSentences.length;
        document.getElementById('progress-current').innerText = 0;
        document.getElementById('progress-total').innerText = totalSentencesCount;
    }
    function updateSentenceDisplay() {
        if (!currentSentence) return;
        const display = document.getElementById('current-sentence-display');
        let h = ''; for (let i = 0; i < currentSentence.length; i++) {
            if (i < charIndex) h += `<span class="char-eaten">${currentSentence[i]}</span>`;
            else if (i === charIndex) h += `<span class="char-current">${currentSentence[i]}</span>`;
            else h += `<span class="char-pending">${currentSentence[i]}</span>`;
        }
        h += `<button id="replay-btn" onclick="window.replayCurrentAudio()" style="position: absolute; right: -12px; top: -12px; background: var(--secondary-color); border-radius: 50%; width: 40px; height: 40px; padding: 0; font-size: 1.2rem; display: flex; align-items: center; justify-content: center; box-shadow: 0 3px 6px rgba(0,0,0,0.15); border: 2px solid #fff; cursor: pointer; color: white;">ğŸ”Š</button>`; 
        if(display) display.innerHTML = h;
    }
    function spawnFoods() {
        foodItems = []; if (!currentSentence || charIndex >= currentSentence.length) return;
        const target = currentSentence[charIndex];
        const p1 = getFreePosition(); foodItems.push({ x: p1.x, y: p1.y, char: target, isCorrect: true });
        for (let i = 0; i < 2; i++) {
            let dist = "çš„ä¸€æ˜¯æˆ‘ä½ ä»–åœ¨".split('')[Math.floor(Math.random()*7)];
            const p = getFreePosition(); foodItems.push({ x: p.x, y: p.y, char: dist, isCorrect: false });
        }
    }
    function manageItems() {
        if (!bonusItem.active && Math.random() < 0.015) { let p = getFreePosition(); bonusItem = { ...p, active: true, timer: 200, icon: fruitIcons[Math.floor(Math.random()*fruitIcons.length)] }; } else if (bonusItem.active && --bonusItem.timer <= 0) bonusItem.active = false;
        if (!bombItem.active && Math.random() < 0.01) { let p = getFreePosition(); bombItem = { ...p, active: true, timer: 150 }; } else if (bombItem.active && --bombItem.timer <= 0) bombItem.active = false;
        if (!heartItem.active && lives === 1 && Math.random() < 0.025) { let p = getFreePosition(); heartItem = { ...p, active: true, timer: 300 }; } else if (heartItem.active && --heartItem.timer <= 0) heartItem.active = false;
    }
    function startNewSentence() {
        if (availableIndices.length === 0) { showLessonComplete(); return; }
        const idx = Math.floor(Math.random() * availableIndices.length);
        const sIdx = availableIndices[idx]; availableIndices.splice(idx, 1);
        currentSentence = currentLessonSentences[sIdx]; charIndex = 0; isTransitioning = false;
        while (charIndex < currentSentence.length && isPunctuation(currentSentence[charIndex])) charIndex++;
        updateSentenceDisplay(); speakText(currentSentence); spawnFoods();
    }
    function initGame() {
        stopGameLoop();
        resetSnakePos(); score = 0; lives = 3; ouchTimer = 0; happyTimer = 0;
        eatenSentenceChars = []; foodItems = []; particles = []; popups = [];
        bonusItem.active = false; bombItem.active = false; heartItem.active = false;
        const sld = document.getElementById('speed-slider'); if(sld) speed = parseInt(sld.value) || 2.5;
        document.getElementById('score').innerText = score;
        updateLivesDisplay(); loadSentences(); startNewSentence();
        document.getElementById('pause-overlay').classList.add('hidden');
        document.getElementById('pause-btn').innerText = "â¸ï¸";
        isPaused = false;
    }

    function moveSnake() {
        let nx = snake[0].x + dx, ny = snake[0].y + dy;
        if (nx < 0) nx = tileCount - 1; else if (nx >= tileCount) nx = 0;
        if (ny < 0) ny = tileCount - 1; else if (ny >= tileCount) ny = 0;
        const head = { x: nx, y: ny }; snake.unshift(head);
        
        // Item Hits
        if (bonusItem.active && head.x === bonusItem.x && head.y === bonusItem.y) { 
            score += 100; document.getElementById('score').innerText = score; 
            bonusItem.active = false; playBonusSound(); 
            // æ°´æœç‰¹æ•ˆï¼šæ˜Ÿæ˜Ÿ
            spawnParticles(head.x, head.y, "#FFD166", ['â­', 'âœ¨', 'ğŸŒŸ', 'ğŸ’«']); 
            spawnPopup(head.x, head.y, "+100", "#F4A261"); 
        }
        if (bombItem.active && head.x === bombItem.x && head.y === bombItem.y) { 
            score = Math.max(0, score - 50); document.getElementById('score').innerText = score; 
            bombItem.active = false; ouchTimer = 30; playErrorSound(); 
            // ç‚¸å½ˆç‰¹æ•ˆï¼šçˆ†ç‚¸
            spawnParticles(head.x, head.y, "#555", ['ğŸ’¥', 'ğŸ”¥', 'ğŸ’¨', 'ğŸ’€']); 
            spawnPopup(head.x, head.y, "-50", "#555"); 
        }
        if (heartItem.active && head.x === heartItem.x && head.y === heartItem.y) { 
            lives = Math.min(3, lives + 1); updateLivesDisplay(); 
            heartItem.active = false; playHealSound(); 
            // æ„›å¿ƒç‰¹æ•ˆ
            spawnParticles(head.x, head.y, "#FF6B6B", ['â¤ï¸', 'ğŸ’–', 'âœ¨']); 
            spawnPopup(head.x, head.y, "+1â¤ï¸", "#E76F51"); 
        }

        let fIdx = foodItems.findIndex(f => f.x === head.x && f.y === head.y);
        if (fIdx !== -1 && !isTransitioning) {
            const eatenChar = foodItems[fIdx].char;
            if (foodItems[fIdx].isCorrect) {
                if(!isRevived) score += 10; document.getElementById('score').innerText = score;
                eatenSentenceChars.push(eatenChar); speakText(eatenChar); happyTimer = 25;
                // æ­£ç¢ºå­—ç‰¹æ•ˆï¼šæ„›å¿ƒ
                spawnParticles(head.x, head.y, "#2A9D8F", ['â¤ï¸', 'ğŸ’–', 'ğŸ¥°', 'ğŸ˜']); 
                spawnPopup(head.x, head.y, "+10", "#2A9D8F"); 
                charIndex++; while (charIndex < currentSentence.length && isPunctuation(currentSentence[charIndex])) charIndex++;
                updateSentenceDisplay();
                if (charIndex >= currentSentence.length) {
                    if(!isRevived) score += 50; isTransitioning = true; foodItems = []; sentencesCompleted++;
                    document.getElementById('progress-current').innerText = sentencesCompleted; playLevelUpSound();
                    setTimeout(() => { if (isGameRunning) startNewSentence(); }, 1200);
                } else spawnFoods();
            } else {
                if (!isRevived) score = Math.max(0, score - 20); document.getElementById('score').innerText = score;
                ouchTimer = 30; playErrorSound(); 
                // éŒ¯èª¤å­—ç‰¹æ•ˆï¼šæšˆçœ©/å‰å‰
                spawnParticles(head.x, head.y, "#D32F2F", ['âŒ', 'â“', 'ğŸŒ€', 'ğŸ˜µ']); 
                spawnPopup(head.x, head.y, "-20", "#D32F2F"); spawnFoods();
            }
        } else snake.pop();

        if (ouchTimer > 0) ouchTimer--; if (happyTimer > 0) happyTimer--;
        if (snake.slice(1).some(p => p.x === snake[0].x && p.y === snake[0].y)) { handleCollision(); return; }
    }

    // --- 4. ç¹ªåœ–å‡½å¼ (Draw) ---
    function drawGame() {
        if (!isGameRunning || isPaused || !ctx) return;
        moveSnake(); manageItems(); 
        
        ctx.fillStyle = "#FFF"; ctx.fillRect(0, 0, 600, 600);
        ctx.lineWidth = 0.5; ctx.strokeStyle = "rgba(42, 157, 143, 0.1)";
        for(let i=0; i<=tileCount; i++) { ctx.beginPath(); ctx.moveTo(i*gridSize,0); ctx.lineTo(i*gridSize,600); ctx.stroke(); ctx.beginPath(); ctx.moveTo(0,i*gridSize); ctx.lineTo(600,i*gridSize); ctx.stroke(); }
        
        foodItems.forEach(f => {
            ctx.fillStyle = "#FFE8D6"; ctx.beginPath(); ctx.roundRect(f.x*gridSize+4, f.y*gridSize+4, 42, 42, 10); ctx.fill();
            ctx.fillStyle = "#E76F51"; ctx.font = "bold 32px Noto Sans TC"; ctx.textAlign = "center"; ctx.textBaseline = "middle";
            ctx.fillText(f.char, f.x*gridSize+25, f.y*gridSize+27);
        });

        if (bonusItem.active) { ctx.font = "36px Arial"; ctx.textAlign="center"; ctx.textBaseline="middle"; ctx.fillText(bonusItem.icon, bonusItem.x*gridSize+25, bonusItem.y*gridSize+27); }
        if (bombItem.active) { ctx.font = "36px Arial"; ctx.textAlign="center"; ctx.textBaseline="middle"; ctx.fillText("ğŸ’£", bombItem.x*gridSize+25, bombItem.y*gridSize+27); }
        if (heartItem.active) { ctx.font = "36px Arial"; ctx.textAlign="center"; ctx.textBaseline="middle"; ctx.fillText("â¤ï¸", heartItem.x*gridSize+25, heartItem.y*gridSize+27); }

        snake.forEach((p, i) => {
            ctx.fillStyle = i === 0 ? "#2A9D8F" : "#F4A261"; ctx.beginPath(); ctx.roundRect(p.x*gridSize+2, p.y*gridSize+2, 46, 46, 10); ctx.fill();
            if (i === 0) {
                let e = dx === 1 ? [35,15,35,35] : (dx === -1 ? [15,15,15,35] : (dy === 1 ? [15,35,35,35] : [15,15,35,15]));
                ctx.strokeStyle = "white"; ctx.lineWidth = 4;
                if (ouchTimer > 0) { const dX = (cx, cy) => { ctx.beginPath(); ctx.moveTo(cx-5,cy-5); ctx.lineTo(cx+5,cy+5); ctx.stroke(); ctx.beginPath(); ctx.moveTo(cx+5,cy-5); ctx.lineTo(cx-5,cy+5); ctx.stroke(); }; dX(p.x*gridSize+e[0], p.y*gridSize+e[1]); dX(p.x*gridSize+e[2], p.y*gridSize+e[3]); }
                else if (happyTimer > 0) { const dH = (cx, cy) => { ctx.beginPath(); ctx.moveTo(cx-5,cy+3); ctx.lineTo(cx,cy-3); ctx.lineTo(cx+5,cy+3); ctx.stroke(); }; dH(p.x*gridSize+e[0], p.y*gridSize+e[1]); dH(p.x*gridSize+e[2], p.y*gridSize+e[3]); }
                else { ctx.fillStyle = "white"; ctx.beginPath(); ctx.arc(p.x*gridSize+e[0], p.y*gridSize+e[1], 5, 0, Math.PI * 2); ctx.arc(p.x*gridSize+e[2], p.y*gridSize+e[3], 5, 0, Math.PI * 2); ctx.fill(); }
            } else { let char = eatenSentenceChars[eatenSentenceChars.length - (snake.length - 1) + (i - 1)]; if (char) { ctx.fillStyle = "#FFF"; ctx.font = "bold 32px Noto Sans TC"; ctx.textAlign="center"; ctx.textBaseline="middle"; ctx.fillText(char, p.x*gridSize+25, p.y*gridSize+27); } }
        });

        for(let i=particles.length-1; i>=0; i--) { let p = particles[i]; p.x += p.vx; p.y += p.vy; p.life -= 0.04; if(p.life <= 0) particles.splice(i, 1); else { ctx.globalAlpha = p.life; ctx.font = "24px Arial"; ctx.fillText(p.emoji, p.x, p.y); } }
        ctx.globalAlpha = 1;
        for(let i=popups.length-1; i>=0; i--) { let p = popups[i]; p.y -= 1; p.life -= 0.02; if(p.life <= 0) popups.splice(i, 1); else { ctx.globalAlpha = p.life; ctx.fillStyle = p.color; ctx.font = "bold 28px Noto Sans TC"; ctx.textAlign="center"; ctx.fillText(p.text, p.x, p.y); } }
        ctx.globalAlpha = 1;
    }

    function handleCollision() {
        lives--; updateLivesDisplay(); ouchTimer = 30;
        if (lives <= 0) { isGameRunning = false; stopGameLoop(); document.getElementById('revive-modal').classList.remove('hidden'); document.getElementById('backdrop').classList.remove('hidden'); }
        else { resetSnakePos(); spawnFoods(); isPaused = true; setTimeout(() => { if(!isPaused) return; isPaused = false; }, 500); }
    }

    function showLessonComplete() { isGameRunning = false; stopGameLoop(); playLevelUpSound(); const sel = document.getElementById('lesson-select'); const text = sel.options[sel.selectedIndex].text; document.getElementById('complete-lesson-name').innerText = text; document.getElementById('complete-score').innerText = score; if(window.saveScoreToCloud) window.saveScoreToCloud(playerName, score, text); document.getElementById('lesson-complete-screen').classList.remove('hidden'); document.getElementById('backdrop').classList.remove('hidden'); }
    function showToast(msg) { const t = document.getElementById("toast"); if(!t) return; t.innerText = msg; t.className = "show"; setTimeout(() => t.className = "", 3000); }

    // --- UI Control Methods ---
    window.showHelpModal = function() { document.getElementById('backdrop').classList.remove('hidden'); document.getElementById('help-modal').classList.remove('hidden'); };
    window.hideHelpModal = function() { document.getElementById('backdrop').classList.add('hidden'); document.getElementById('help-modal').classList.add('hidden'); };
    window.showLeaderboardModal = function() { if (isGameRunning && !isPaused) window.togglePause(); document.getElementById('backdrop').classList.remove('hidden'); document.getElementById('leaderboard-modal').classList.remove('hidden'); };
    window.hideLeaderboardModal = function() { document.getElementById('backdrop').classList.add('hidden'); document.getElementById('leaderboard-modal').classList.add('hidden'); if (isGameRunning && isPaused) window.togglePause(); };
    window.updateSpeedFromSlider = function(val) { speed = parseInt(val); document.getElementById('speed-val').innerText = speed; if (isGameRunning && !isPaused) { stopGameLoop(); gameLoop = setInterval(drawGame, 1000 / speed); } };
    window.toggleFullscreen = function() { 
        if (!document.fullscreenElement) { 
            document.documentElement.requestFullscreen().catch((err) => {
                console.log(`Error attempting to enable full-screen mode: ${err.message} (${err.name})`);
            }); 
            document.getElementById('full-btn').innerText = "âŒ"; 
        } else { 
            document.exitFullscreen(); 
            document.getElementById('full-btn').innerText = "â›¶"; 
        } 
    };
    window.toggleSound = function() { isSoundOn = !isSoundOn; document.getElementById('sound-btn').innerText = isSoundOn ? "ğŸ”Š" : "ğŸ”‡"; };
    window.togglePause = function() {
        if (!isGameRunning) return; isPaused = !isPaused;
        const btn = document.getElementById('pause-btn'), overlay = document.getElementById('pause-overlay');
        if(btn) btn.innerText = isPaused ? "â–¶ï¸" : "â¸ï¸";
        if(overlay) { if(isPaused) overlay.classList.remove('hidden'); else overlay.classList.add('hidden'); }
        if(!isPaused) { stopGameLoop(); gameLoop = setInterval(drawGame, 1000 / speed); } else stopGameLoop();
    };
    window.triggerQuit = function() { if (isGameRunning && !isPaused) window.togglePause(); document.getElementById('quit-modal').classList.remove('hidden'); document.getElementById('backdrop').classList.remove('hidden'); };
    window.confirmQuit = function() { stopGameLoop(); isGameRunning = false; window.showStartScreen(); };
    window.cancelQuit = function() { document.getElementById('quit-modal').classList.add('hidden'); document.getElementById('backdrop').classList.add('hidden'); if(isGameRunning && isPaused) window.togglePause(); };
    window.startGame = function() {
        canvas = document.getElementById('gameCanvas'); ctx = canvas.getContext('2d');
        playerName = document.getElementById('player-name').value.trim() || "å°å‹‡å£«";
        localStorage.setItem('snake_player_name', playerName);
        document.getElementById('start-screen').classList.add('hidden');
        document.getElementById('lesson-complete-screen').classList.add('hidden');
        initGame(); isGameRunning = true; 
        stopGameLoop(); gameLoop = setInterval(drawGame, 1000 / speed);
        const sel = document.getElementById('lesson-select');
        if (window.sendHeartbeat) window.sendHeartbeat(playerName, sel.options[sel.selectedIndex].text);
    };
    window.resetGame = function() { window.startGame(); };
    window.showStartScreen = function() { stopGameLoop(); isGameRunning = false; document.getElementById('start-screen').classList.remove('hidden'); document.getElementById('leaderboard-modal').classList.add('hidden'); document.getElementById('help-modal').classList.add('hidden'); document.getElementById('backdrop').classList.add('hidden'); document.getElementById('quit-modal').classList.add('hidden'); document.getElementById('revive-modal').classList.add('hidden'); document.getElementById('pause-overlay').classList.add('hidden'); document.getElementById('lesson-complete-screen').classList.add('hidden'); };
    window.reviveGame = function() { lives = 3; isRevived = true; document.getElementById('score-display-wrapper').classList.add('locked-score'); document.getElementById('revive-note').classList.remove('hidden'); document.getElementById('revive-modal').classList.add('hidden'); document.getElementById('backdrop').classList.add('hidden'); resetSnakePos(); spawnFoods(); isGameRunning = true; stopGameLoop(); gameLoop = setInterval(drawGame, 1000 / speed); };
    window.gameOver = function() { document.getElementById('revive-modal').classList.add('hidden'); isGameRunning = false; stopGameLoop(); document.getElementById('final-score').innerText = score; document.getElementById('game-over-screen').classList.remove('hidden'); if(window.saveScoreToCloud) window.saveScoreToCloud(playerName, score, document.getElementById('lesson-select').options[document.getElementById('lesson-select').selectedIndex].text); };
    window.shareLesson = function() { const v = document.getElementById('lesson-select').value; const url = new URL(window.location.href); url.searchParams.set('lesson', v); const temp = document.createElement("textarea"); temp.value = url.toString(); document.body.appendChild(temp); temp.select(); document.execCommand("copy"); document.body.removeChild(temp); showToast("å·²è¤‡è£½èª²ç¨‹é€£çµï¼"); };
    window.replayCurrentAudio = function() { speakText(currentSentence); };

    window.onload = function() {
        const savedName = localStorage.getItem('snake_player_name'); 
        if (savedName) document.getElementById('player-name').value = savedName; 
        const urlParams = new URLSearchParams(window.location.search);
        const lessonParam = urlParams.get('lesson');
        if (lessonParam) {
            const select = document.getElementById('lesson-select');
            if (select) {
                const optionExists = [...select.options].some(o => o.value === lessonParam);
                if (optionExists) {
                    select.value = lessonParam;
                    showToast("å·²è¼‰å…¥åˆ†äº«çš„èª²ç¨‹é€²åº¦");
                }
            }
        }
    };
    
    // --- å¼·åŒ–ç‰ˆè§¸æ§é–å®šé‚è¼¯ ---
    let tsX, tsY;
    const gameCanvasElement = document.getElementById('gameCanvas');
    if (gameCanvasElement) {
        gameCanvasElement.addEventListener('touchstart', function(e) {
            e.preventDefault(); 
            tsX = e.touches[0].screenX;
            tsY = e.touches[0].screenY;
        }, { passive: false });

        gameCanvasElement.addEventListener('touchmove', function(e) {
            e.preventDefault(); 
        }, { passive: false });

        gameCanvasElement.addEventListener('touchend', function(e) {
            e.preventDefault();
            if (isPaused || !isGameRunning) return;
            let dx_s = e.changedTouches[0].screenX - tsX;
            let dy_s = e.changedTouches[0].screenY - tsY;
            if (Math.abs(dx_s) > Math.abs(dy_s)) { if (Math.abs(dx_s)>20) { dx = dx_s > 0 ? 1 : -1; dy = 0; } } else { if (Math.abs(dy_s)>20) { dy = dy_s > 0 ? 1 : -1; dx = 0; } } 
        }, { passive: false });
    }

    window.addEventListener("keydown", e => { 
        if(["Space","ArrowUp","ArrowDown","ArrowLeft","ArrowRight"].includes(e.code)) e.preventDefault(); 
        if (!isGameRunning || isPaused) return; 
        if ((e.keyCode === 37 || e.code === 'KeyA') && dx !== 1) { dx = -1; dy = 0; } 
        else if ((e.keyCode === 38 || e.code === 'KeyW') && dy !== 1) { dx = 0; dy = -1; } 
        else if ((e.keyCode === 39 || e.code === 'KeyD') && dx !== -1) { dx = 1; dy = 0; } 
        else if ((e.keyCode === 40 || e.code === 'KeyS') && dy !== -1) { dx = 0; dy = 1; } 
    });
</script>
</body>
</html>