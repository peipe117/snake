<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <title>è¯èªè²ªé£Ÿè›‡ï¼šèª²æ–‡å¤§å†’éšª</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=Gaegu:wght@400;700&display=swap'); /* Handwriting font */

        :root {
            /* æŸ”å’Œè‰²èª¿ Palette */
            --primary-color: #F4A261;   /* Soft Orange/Coral */
            --secondary-color: #2A9D8F; /* Sage Green */
            --accent-color: #E76F51;    /* Terra Cotta */
            --bg-color: #FDF6E3;        /* Warm Cream */
            --text-color: #264653;      /* Dark Slate Blue */
            --card-bg: #FFFFFF;         
            --bonus-color: #FFD166;     
            --bomb-color: #264653;      
            --grid-line: #E0F7FA;       
        }

        body {
            font-family: 'Noto Sans TC', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh; 
            overflow: hidden;
            touch-action: none;
            user-select: none;
            background-image: radial-gradient(#E0E0E0 1px, transparent 1px);
            background-size: 20px 20px;
        }

        /* Fullscreen specific styles */
        body.fullscreen-mode {
            justify-content: center;
            background-color: #F0EAD6; 
        }
        
        body.fullscreen-mode .subtitle,
        body.fullscreen-mode h1,
        body.fullscreen-mode .footer {
            display: none; 
        }

        .subtitle {
            color: #7D8597; 
            font-size: 1.2rem; /* Larger font */
            margin-bottom: -5px;
            font-weight: bold;
            letter-spacing: 1px;
            text-shadow: 1px 1px 0px rgba(255,255,255,0.8);
        }

        h1 {
            color: var(--secondary-color);
            margin: 5px 0 10px 0;
            font-size: 2.2rem; /* Larger font */
            text-align: center;
            font-family: 'Gaegu', cursive, 'Noto Sans TC', sans-serif;
        }

        #game-container {
            position: relative;
            background: var(--card-bg);
            padding: 12px;
            border-radius: 20px;
            box-shadow: 0 10px 20px rgba(38, 70, 83, 0.15);
            border: 6px solid #FFF;
            width: 95%;
            max-width: 600px; /* Increased max width for tablet */
            box-sizing: border-box;
        }

        canvas {
            background-color: #FFFFFF;
            border: 3px solid var(--secondary-color);
            border-radius: 12px;
            display: block;
            touch-action: none;
            box-shadow: inset 0 0 20px rgba(0,0,0,0.02);
            width: 100%; /* Responsive width */
            height: auto; /* Maintain aspect ratio */
            aspect-ratio: 1 / 1; /* Square */
        }

        #ui-layer {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 20;
        }

        .screen {
            background: rgba(255, 255, 255, 0.98);
            padding: 20px; 
            border-radius: 20px;
            text-align: center;
            pointer-events: auto;
            width: 90%; 
            max-width: 450px; /* Wider modal */
            max-height: 96%; 
            overflow-y: auto; 
            box-shadow: 0 15px 30px rgba(38, 70, 83, 0.2);
            border: 4px solid var(--primary-color);
            display: flex;
            flex-direction: column;
            gap: 10px; 
            animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            align-items: center; 
        }
        
        #leaderboard-modal {
            position: fixed; 
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 90%;
            max-width: 600px; 
            max-height: 90vh;
            z-index: 1000;
            background: #FFF;
            border: 5px solid var(--secondary-color);
            padding: 25px;
            border-radius: 25px;
            box-shadow: 0 20px 50px rgba(0,0,0,0.25);
        }
        
        .modal-backdrop {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(38, 70, 83, 0.4);
            backdrop-filter: blur(4px);
            z-index: 999;
        }

        @keyframes popIn {
            from { transform: scale(0.8); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }

        @keyframes popInFixed {
            from { transform: translate(-50%, -50%) scale(0.8); opacity: 0; }
            to { transform: translate(-50%, -50%) scale(1); opacity: 1; }
        }
        
        #leaderboard-modal.screen {
            animation: popInFixed 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        .hidden {
            display: none !important;
        }

        button {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 12px 24px; /* Larger touch targets */
            font-size: 1.1rem; /* Larger font */
            border-radius: 30px;
            cursor: pointer;
            font-family: 'Noto Sans TC', sans-serif;
            font-weight: bold;
            margin: 5px; 
            transition: all 0.1s;
            box-shadow: 0 4px 0 rgba(0,0,0,0.1);
            white-space: nowrap;
        }

        button:active {
            transform: translateY(2px);
            box-shadow: 0 2px 0 rgba(0,0,0,0.1);
        }

        button.secondary {
            background-color: var(--secondary-color);
        }
        
        button.danger {
            background-color: var(--accent-color);
        }

        button.control-btn {
            background: #fff;
            color: var(--text-color);
            border: 2px solid var(--text-color);
            padding: 8px 14px;
            font-size: 1.4rem; /* Larger icons */
            min-width: 50px;
            box-shadow: none;
        }
        
        #top-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
            max-width: 600px; /* Match game container */
            margin-bottom: 8px;
            padding: 0 5px;
            box-sizing: border-box;
        }

        #score-info {
            font-weight: bold;
            color: var(--text-color);
            display: flex;
            flex-direction: column;
            font-size: 1.1rem; /* Larger font */
            line-height: 1.4;
        }
        
        #lives {
            color: var(--accent-color); 
            font-size: 1.4rem; /* Larger hearts */
            letter-spacing: 3px;
        }

        #level {
            color: var(--accent-color);
            font-weight: bold;
            transition: transform 0.2s;
            display: inline-block;
        }

        #progress-container {
            font-size: 0.95rem;
            color: #7D8597;
            margin-top: 2px;
        }
        
        #progress-current {
            color: var(--secondary-color);
            font-weight: bold;
            font-size: 1.1rem;
        }

        #current-sentence-display {
            margin-top: 15px; /* Back to bottom, add margin top */
            margin-bottom: 5px;
            min-height: 70px; /* Taller */
            padding: 12px 20px;
            background: #fff;
            border-radius: 15px;
            border: 3px dashed var(--secondary-color);
            width: 95%; 
            max-width: 600px; /* Match canvas */
            text-align: center;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.6rem; /* Larger text */
            color: #ccc; 
            font-weight: bold;
            line-height: 1.5;
            flex-wrap: wrap;
            position: relative;
            box-shadow: 0 5px 10px rgba(0,0,0,0.08);
            box-sizing: border-box;
        }
        
        #replay-btn {
            position: absolute;
            right: -12px;
            top: -12px;
            background: var(--secondary-color);
            border-radius: 50%;
            width: 40px; /* Larger button */
            height: 40px;
            padding: 0;
            font-size: 1.2rem;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 3px 6px rgba(0,0,0,0.15);
            border: 2px solid #fff;
        }

        .char-eaten { color: var(--secondary-color); transition: color 0.3s; }
        .char-current { color: var(--accent-color); text-decoration: underline; font-size: 2.0rem; font-weight: 900; } /* Larger current char */
        .char-pending { color: #BBB; }

        select, input[type="text"] {
            padding: 12px 16px; 
            font-size: 1.1rem; /* Larger font */
            border-radius: 12px;
            border: 2px solid var(--secondary-color);
            margin-bottom: 5px; 
            font-family: 'Noto Sans TC', sans-serif;
            width: 100%;
            box-sizing: border-box;
            background: #F4F1DE; 
            outline: none;
            color: var(--text-color);
        }
        
        select:focus, input:focus {
            border-color: var(--primary-color);
        }
        
        input[type="text"] {
            text-align: center;
            font-weight: bold;
        }

        #online-status-bar {
            width: 100%;
            max-width: 600px; /* Match game container */
            margin-bottom: 10px;
            font-size: 1rem;
            color: #555;
            background: rgba(255,255,255,0.8);
            padding: 8px 15px;
            border-radius: 20px;
            box-sizing: border-box;
            white-space: nowrap;
            overflow-x: auto; 
            overflow-y: hidden;
            text-overflow: unset; 
            text-align: left;
            border: 2px solid #FFF;
            box-shadow: 0 3px 8px rgba(0,0,0,0.05);
            -webkit-overflow-scrolling: touch; 
            scrollbar-width: none; 
        }
        #online-status-bar::-webkit-scrollbar {
            display: none; 
        }
        
        .leaderboard-container {
            width: 100%;
            max-height: 400px; /* Taller */
            overflow-y: auto;
            margin: 15px 0;
            border: 1px solid #eee;
            border-radius: 10px;
            box-shadow: inset 0 2px 5px rgba(0,0,0,0.05);
        }
        
        table.leaderboard-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 1.05rem; /* Larger font */
        }
        
        table.leaderboard-table th {
            background-color: var(--secondary-color);
            color: white;
            padding: 12px;
            position: sticky;
            top: 0;
            font-weight: bold;
        }
        
        table.leaderboard-table td {
            padding: 12px 10px;
            border-bottom: 1px solid #eee;
            text-align: center;
            color: var(--text-color);
        }

        table.leaderboard-table th:nth-child(1), table.leaderboard-table td:nth-child(1) { width: 15%; } /* Rank */
        table.leaderboard-table th:nth-child(2), table.leaderboard-table td:nth-child(2) { width: 35%; text-align: left; padding-left: 15px; } /* Name */
        table.leaderboard-table th:nth-child(3), table.leaderboard-table td:nth-child(3) { width: 25%; } /* Score */
        table.leaderboard-table th:nth-child(4), table.leaderboard-table td:nth-child(4) { width: 25%; font-size: 0.9em; } /* Lesson */
        
        table.leaderboard-table tr:nth-child(even) {
            background-color: #f9f9f9;
        }
        
        table.leaderboard-table tr:nth-child(1) td { background-color: #FFF8E1; color: #D4AF37; font-weight: bold; }
        table.leaderboard-table tr:nth-child(2) td { background-color: #F5F5F5; color: #A9A9A9; font-weight: bold; }
        table.leaderboard-table tr:nth-child(3) td { background-color: #FFF0E6; color: #CD7F32; font-weight: bold; }

        /* Pause Overlay */
        #pause-overlay {
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(255,255,255,0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(3px);
            z-index: 10;
            border-radius: 10px;
        }
        
        .pause-text {
            font-size: 3.5rem; /* Larger */
            font-weight: bold;
            color: var(--text-color);
            text-shadow: 2px 2px white;
            background: rgba(255,255,255,0.9);
            padding: 15px 40px;
            border-radius: 25px;
            border: 4px solid var(--primary-color);
        }

        #mobile-hint {
            margin-top: 15px;
            color: #7D8597;
            font-size: 1rem;
            text-align: center;
            background: rgba(255,255,255,0.6);
            padding: 8px 20px;
            border-radius: 20px;
        }
        
        .footer {
            margin-top: 25px;
            color: #888;
            font-size: 0.9rem;
            font-weight: bold;
            letter-spacing: 1px;
            opacity: 0.7;
        }

        #toast {
            visibility: hidden;
            min-width: 250px;
            background-color: var(--text-color);
            color: #fff;
            text-align: center;
            border-radius: 25px;
            padding: 15px 25px;
            position: fixed;
            z-index: 100;
            left: 50%;
            transform: translateX(-50%);
            bottom: 30px;
            font-size: 1.1rem;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
            opacity: 0;
            transition: opacity 0.3s, bottom 0.3s;
        }

        #toast.show {
            visibility: visible;
            opacity: 1;
            bottom: 50px;
        }
        
        @media (max-width: 600px) {
            h1 { font-size: 1.5rem; }
            .subtitle { font-size: 0.9rem; }
            #current-sentence-display { font-size: 1.3rem; }
            #leaderboard-modal { width: 95%; padding: 10px; }
            table.leaderboard-table { font-size: 0.85rem; }
        }
    </style>
</head>
<body>

    <!-- Backdrop for modals -->
    <div id="backdrop" class="modal-backdrop hidden"></div>

    <div class="subtitle">å­¸è¯èªå‘å‰èµ°ç¬¬äºŒå†Š</div>
    <h1>ğŸ èª²æ–‡è²ªé£Ÿè›‡ï¼šèª²æ–‡å¤§å†’éšª</h1>

    <div id="top-controls">
        <div id="score-info">
            <div>å¾—åˆ†: <span id="score">0</span> &nbsp;|&nbsp; é€Ÿåº¦: <span id="level">1</span></div>
            <div id="progress-container">é€²åº¦: <span id="progress-current">0</span> / <span id="progress-total">0</span></div>
            <div id="lives">â¤ï¸â¤ï¸â¤ï¸â¤ï¸â¤ï¸</div>
        </div>
        <div style="display: flex; gap: 5px;">
            <button class="control-btn" id="sound-btn" onclick="toggleSound()" title="è²éŸ³é–‹é—œ">ğŸ”Š</button>
            <button class="control-btn" id="pause-btn" onclick="togglePause()" title="æš«åœéŠæˆ²">â¸ï¸</button>
            <button class="control-btn" id="fullscreen-btn" onclick="toggleFullscreen()" title="å…¨è¢å¹•">â›¶</button>
            <button class="control-btn" id="exit-btn" onclick="triggerQuit()" title="å›åˆ°é¦–é ">ğŸ </button>
        </div>
    </div>

    <div id="online-status-bar">ğŸŸ¢ é€£ç·šä¸­...</div>

    <div id="game-container">
        <!-- Canvas width/height increased to 600 for better resolution -->
        <canvas id="gameCanvas" width="600" height="600"></canvas>
        
        <div id="pause-overlay" class="hidden">
            <div class="pause-text">æš«åœ</div>
        </div>

        <div id="ui-layer">
            <!-- Start Screen -->
            <div id="start-screen" class="screen">
                <h2 id="start-title" style="margin: 0 0 10px 0; color: var(--primary-color); font-size: 1.8rem;">æº–å‚™å¥½äº†å—ï¼Ÿ</h2>
                
                <label for="player-name" style="font-size: 1rem; font-weight: bold; color:#555; align-self: start; margin-left: 5px;">ä½ çš„åå­—ï¼š</label>
                <input type="text" id="player-name" placeholder="è«‹è¼¸å…¥åå­— (ä¾‹å¦‚: å°ç¾)" maxlength="8">
                
                <label for="lesson-select" style="font-size: 1rem; font-weight: bold; color:#555; align-self: start; margin-left: 5px; margin-top: 5px;">é¸æ“‡èª²ç¨‹ï¼š</label>
                <div style="display: flex; gap: 5px; width: 100%; margin-bottom: 10px;">
                    <select id="lesson-select" style="margin-bottom: 0;">
                        <option value="1">ç¬¬ 1 èª²ï¼šæ–°åŒå­¸</option>
                        <option value="2">ç¬¬ 2 èª²ï¼šæˆ‘çˆ¸çˆ¸åšç”Ÿæ„</option>
                        <option value="3">ç¬¬ 3 èª²ï¼šå»è¶…ç´šå¸‚å ´</option>
                        <option value="4">ç¬¬ 4 èª²ï¼šæˆ‘æƒ³åƒæ¼¢å ¡</option>
                        <option value="5">ç¬¬ 5 èª²ï¼šæ˜¥å¤©å¿«åˆ°äº†</option>
                        <option value="6">ç¬¬ 6 èª²ï¼šè¾²æ›†æ–°å¹´</option>
                        <option value="7">ç¬¬ 7 èª²ï¼šæ—©ä¸€é»ç¡è¦º</option>
                        <option value="8">ç¬¬ 8 èª²ï¼šæˆ‘çš„å¯µç‰©</option>
                        <option value="9">ç¬¬ 9 èª²ï¼šéŸ³æ¨‚æ•™å®¤åœ¨åŒ—æ–¹</option>
                        <option value="10">ç¬¬ 10 èª²ï¼šå¤–å…¬å¤–å©†ä½è‡ºç£</option>
                        <option value="11">ç¬¬ 11 èª²ï¼šå»å‹•ç‰©åœ’</option>
                        <option value="12">ç¬¬ 12 èª²ï¼šæ‰“ç¶²è·¯é›»è©±</option>
                        <option value="all">ğŸ“š å…¨éƒ¨è¤‡ç¿’ (1-12èª²)</option>
                    </select>
                    <button class="secondary" onclick="shareLesson()" style="margin: 0; padding: 0 20px;" title="è¤‡è£½èª²ç¨‹é€£çµ">ğŸ”—</button>
                </div>
                
                <div style="display: flex; gap: 10px; width: 100%;">
                    <button onclick="startGame()" style="flex:2;">é–‹å§‹éŠæˆ² â–¶ï¸</button>
                    <button class="secondary" onclick="showLeaderboardModal()" style="flex:1;">ğŸ† æ’è¡Œæ¦œ</button>
                </div>

                <p style="font-size: 0.9rem; color: #7D8597; margin: 15px 0 0 0;">
                    é›»è…¦ï¼šâ¬†ï¸â¬‡ï¸â¬…ï¸â¡ï¸ &nbsp;|&nbsp; å¹³æ¿ï¼šğŸ‘† æ»‘å‹•è¢å¹•<br>
                    <span style="color: var(--accent-color);">æç¤ºï¼šæ’ç‰†ä¸æœƒæ­»æ‰ï¼Œé‚„æœ‰æ°´æœçå‹µ ğŸ</span>
                </p>
            </div>

            <!-- Quit Confirmation Modal (Inside UI Layer) -->
            <div id="quit-modal" class="screen hidden" style="z-index: 50;">
                <h2 style="color: var(--accent-color); margin: 0 0 10px 0;">ç¢ºå®šè¦é›¢é–‹å—ï¼Ÿ</h2>
                <p style="margin: 10px 0; font-size: 1.1rem;">ç›®å‰çš„éŠæˆ²é€²åº¦æœƒæ¶ˆå¤±å–”ï¼</p>
                <div style="display: flex; gap: 10px; justify-content: center; width: 100%;">
                    <button class="danger" onclick="confirmQuit()" style="flex: 1;">ç¢ºå®šé›¢é–‹</button>
                    <button class="secondary" onclick="cancelQuit()" style="flex: 1;">å–æ¶ˆ</button>
                </div>
            </div>

            <!-- Lesson Complete Screen -->
            <div id="lesson-complete-screen" class="screen hidden">
                <h2 style="margin: 0; color: var(--primary-color);">ğŸ‰ æ­å–œå®Œæˆï¼</h2>
                <div style="background: #f0f0f0; padding: 15px; border-radius: 15px; width: 100%; box-sizing: border-box;">
                    <p style="margin: 5px 0; font-size: 1.2rem; color: #555;">ä½ å·²ç¶“è¤‡ç¿’å®Œ</p>
                    <p id="complete-lesson-name" style="font-size: 1.3rem; color: var(--secondary-color); font-weight: bold; margin: 5px 0;">ç¬¬ X èª²</p>
                    <p style="margin: 5px 0 0 0;">æ‰€æœ‰çš„å¥å­äº†ï¼</p>
                    <p style="margin: 10px 0; font-size: 1.4rem;">ç¸½å¾—åˆ†ï¼š<span id="complete-score" style="color: var(--accent-color); font-weight: 900;">0</span></p>
                </div>

                <!-- Mini Leaderboard for Complete Screen -->
                <div style="width:100%; margin-top:10px;">
                    <div style="font-size: 1rem; color: #555; font-weight: bold; margin-bottom: 5px;">ğŸ† æ­·å²æ’è¡Œæ¦œ</div>
                    <div class="leaderboard-container" style="max-height: 120px;">
                        <table class="leaderboard-table">
                            <tbody id="leaderboard-body-complete"></tbody>
                        </table>
                    </div>
                </div>
                
                <div id="lesson-nav-buttons" style="display: flex; gap: 10px; justify-content: center; width: 100%; margin-top: 10px;">
                     <button id="btn-prev-lesson" class="secondary" style="flex: 1; font-size: 1rem;">â¬…ï¸ ä¸Šä¸€èª²</button>
                     <button id="btn-next-lesson" class="secondary" style="flex: 1; font-size: 1rem;">ä¸‹ä¸€èª² â¡ï¸</button>
                </div>

                <div style="display: flex; gap: 10px; justify-content: center; width: 100%; margin-top: 5px;">
                    <button onclick="resetGame()" style="flex: 1;">å†è¤‡ç¿’ä¸€æ¬¡ ğŸ”„</button>
                    <button class="secondary" onclick="showStartScreen()" style="flex: 1;">å›é¦–é  ğŸ </button>
                </div>
            </div>

            <!-- Game Over Screen -->
            <div id="game-over-screen" class="screen hidden">
                <h2 id="game-over-title" style="margin: 0; color: var(--text-color);">ğŸ˜² éŠæˆ²çµæŸï¼</h2>
                <div style="background: #f0f0f0; padding: 15px; border-radius: 15px; width: 100%; box-sizing: border-box;">
                    <p id="game-over-lesson" style="font-size: 1.1rem; color: #555; margin: 5px 0;"></p>
                    <p style="margin: 5px 0; font-size: 1.3rem;"><span id="game-over-name">ä½ </span>çš„æœ€çµ‚å¾—åˆ†</p>
                    <p style="margin: 0; font-size: 3rem; color: var(--accent-color); font-weight: 900; line-height: 1;"><span id="final-score">0</span></p>
                </div>
                
                <!-- Mini Leaderboard -->
                <div style="width:100%; margin-top:10px;">
                    <div style="font-size: 1rem; color: #555; font-weight: bold; margin-bottom: 5px;">ğŸ† æ­·å²æ’è¡Œæ¦œ</div>
                    <div class="leaderboard-container" style="max-height: 120px;">
                        <table class="leaderboard-table">
                            <tbody id="leaderboard-body-gameover"></tbody>
                        </table>
                    </div>
                </div>

                <div style="display: flex; gap: 10px; justify-content: center; width: 100%; margin-top: 10px;">
                    <button onclick="resetGame()" style="flex: 1;">å†ç©ä¸€æ¬¡ ğŸ”„</button>
                    <button class="secondary" onclick="showStartScreen()" style="flex: 1;">æ›èª²æ–‡ ğŸ“–</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Leaderboard Modal (Separate from UI Layer for Full Screen) -->
    <div id="leaderboard-modal" class="screen hidden">
        <h2 style="color: var(--secondary-color); margin: 0 0 10px 0; font-size: 1.8rem;">ğŸ† æ­·å²æ¦®è­½æ¦œ</h2>
        <div class="leaderboard-container" style="max-height: 50vh;">
            <table class="leaderboard-table">
                <thead>
                    <tr>
                        <th>åæ¬¡</th>
                        <th>åå­—</th>
                        <th>åˆ†æ•¸</th>
                        <th>èª²ç¨‹</th>
                    </tr>
                </thead>
                <tbody id="leaderboard-body-modal">
                    <!-- Populated by JS -->
                </tbody>
            </table>
        </div>
        <button class="secondary" onclick="hideLeaderboardModal()" style="margin-top: 15px; min-width: 150px;">é—œé–‰</button>
    </div>

    <div id="current-sentence-display">
        æº–å‚™é–‹å§‹...
        <button id="replay-btn" onclick="replayCurrentAudio()" title="é‡è½ä¸€æ¬¡">ğŸ”Š</button>
    </div>
    
    <div id="mobile-hint">ğŸ’¡ æç¤ºï¼šé †åºåƒå­—çµ„æˆå¥å­ï¼Œæ’ç‰†æœƒå¾å¦ä¸€é‚Šå‡ºä¾†</div>
    
    <div class="footer">Design by Sophia Wong</div>
    <div id="toast"></div>

<!-- Firebase Integration -->
<script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js';
    import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js';
    import { getFirestore, collection, doc, setDoc, addDoc, getDocs, onSnapshot, query, serverTimestamp } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js';

    // Provided globals
   const firebaseConfig = {
  apiKey: "AIzaSyBQI17CXEhD5mJhDCid-mt0cAL6qvdcAiA",
  authDomain: "chinses-snake-game.firebaseapp.com",
  projectId: "chinses-snake-game",
  storageBucket: "chinses-snake-game.firebasestorage.app",
  messagingSenderId: "239140560404",
  appId: "1:239140560404:web:dd5ead9018a0f0e5ad5101"
};
    
    // Fix: Sanitize appId to ensure it's a valid path segment (no slashes or dots)
    const rawAppId = typeof __app_id !== 'undefined' ? __app_id : 'default-app';
    // Use a clean ID. If rawAppId contains paths, we just use the last segment or a hash-like replacement
    // Here we replace any non-alphanumeric with _ to be safe
    const appId = rawAppId.split('/')[0].replace(/[^a-zA-Z0-9_-]/g, '_');
    
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    
    let currentUser = null;
    let isOffline = false; // Flag to track if we should stop trying cloud ops

    // 1. Auth Logic
    const initAuth = async () => {
        try {
            if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                await signInWithCustomToken(auth, __initial_auth_token);
            } else {
                await signInAnonymously(auth);
            }
        } catch (error) {
            console.error("Auth Error (Switching to Offline):", error);
            activateOfflineMode();
        }
    };
    initAuth();

    function activateOfflineMode() {
        if(isOffline) return;
        isOffline = true;
        const listEl = document.getElementById('online-status-bar');
        if(listEl) listEl.innerText = "ğŸ”´ å–®æ©Ÿæ¨¡å¼ (é›²ç«¯åŠŸèƒ½æš«åœ)";
        
        const modalBody = document.getElementById('leaderboard-body-modal');
        if(modalBody) modalBody.innerHTML = `<tr><td colspan="4">ç„¡æ³•é€£ç·šï¼Œç›®å‰ç‚ºå–®æ©Ÿæ¨¡å¼ã€‚</td></tr>`;
        
        const gameoverBody = document.getElementById('leaderboard-body-gameover');
        if(gameoverBody) gameoverBody.innerHTML = `<tr><td colspan="4">å–®æ©Ÿæ¨¡å¼</td></tr>`;

        const completeBody = document.getElementById('leaderboard-body-complete');
        if(completeBody) completeBody.innerHTML = `<tr><td colspan="4">å–®æ©Ÿæ¨¡å¼</td></tr>`;
    }

    onAuthStateChanged(auth, (user) => {
        if (user) {
            currentUser = user;
            if (!isOffline) {
                startPresenceSystem(); 
                loadLeaderboard();     
            }
        }
    });

    // 2. Presence System (Online Status)
    function startPresenceSystem() {
        if (!currentUser || isOffline) return;
        
        try {
            const presenceCol = collection(db, 'artifacts', appId, 'public', 'data', 'presence');
            
            onSnapshot(presenceCol, (snapshot) => {
                const now = Date.now();
                const activeThreshold = 60 * 1000 * 5; 
                
                const onlineData = [];
                snapshot.forEach(doc => {
                    const data = doc.data();
                    if (data.name && data.lastSeen && (now - data.lastSeen < activeThreshold)) {
                        onlineData.push({ name: data.name, lesson: data.lesson || 'æº–å‚™ä¸­' });
                    }
                });
                
                // Use a map to ensure unique users if duplicate names exist (though auth uid is key)
                // Filter distinct names for display:
                const uniquePlayers = [];
                const seenNames = new Set();
                onlineData.forEach(p => {
                     if(!seenNames.has(p.name)) {
                         seenNames.add(p.name);
                         uniquePlayers.push(p);
                     }
                });

                updateOnlineUI(uniquePlayers);
            }, (error) => {
                console.warn("Presence offline:", error.message);
                activateOfflineMode();
            });
        } catch (e) {
            activateOfflineMode();
        }
    }

    // Heartbeat function
    window.sendHeartbeat = async function(name, lesson) {
        if (isOffline || !currentUser || !name) return;
        
        try {
            const presenceRef = doc(db, 'artifacts', appId, 'public', 'data', 'presence', currentUser.uid);
            await setDoc(presenceRef, {
                name: name,
                lesson: lesson,
                lastSeen: Date.now()
            }, { merge: true });
        } catch (e) {
            if (e.code === 'permission-denied' || (e.message && e.message.includes('permissions'))) {
                activateOfflineMode();
            } else {
                console.warn("Heartbeat warning (switching offline):", e.message);
                activateOfflineMode();
            }
        }
    }

    function updateOnlineUI(players) {
        const listEl = document.getElementById('online-status-bar');
        if (!listEl) return;
        
        if (players.length === 0) {
            listEl.innerHTML = "ğŸŸ¢ <b>åœ¨ç·šåŒå­¸ï¼š</b>ç›®å‰åªæœ‰ä½ ";
        } else {
            // New Format: Name (Lesson)
            const html = players.map(p => {
                return `<span style="margin-right:15px; display:inline-block;"><span class="online-badge"></span>${p.name} <span style="font-size:0.8em; opacity:0.8; font-weight:normal;">(${p.lesson})</span></span>`;
            }).join('');
            listEl.innerHTML = `ğŸŸ¢ <b>åœ¨ç·šåŒå­¸ï¼š</b> ` + html;
        }
    }

    // 3. Leaderboard System
    window.saveScoreToCloud = async function(name, score, lessonName) {
        if (isOffline || !currentUser) return;
        
        try {
            const lbCol = collection(db, 'artifacts', appId, 'public', 'data', 'leaderboard');
            await addDoc(lbCol, {
                name: name,
                score: score,
                lesson: lessonName,
                timestamp: Date.now()
            });
            console.log("Score saved!");
        } catch (e) {
            if (e.code === 'permission-denied' || (e.message && e.message.includes('permissions'))) {
                activateOfflineMode();
            } else {
                console.warn("Score save warning:", e.message);
            }
        }
    }

    // Load leaderboard
    function loadLeaderboard() {
        if (isOffline) return;
        
        try {
            const lbCol = collection(db, 'artifacts', appId, 'public', 'data', 'leaderboard');
            onSnapshot(lbCol, (snapshot) => {
                const scores = [];
                snapshot.forEach(doc => {
                    const data = doc.data();
                    if (data.name && data.score != null) {
                        scores.push(data);
                    }
                });
                
                scores.sort((a, b) => b.score - a.score);
                const topScores = scores.slice(0, 10);
                updateLeaderboardUI(topScores);
            }, (error) => {
                 console.warn("Leaderboard offline:", error.message);
                 activateOfflineMode();
            });
        } catch (e) {
            activateOfflineMode();
        }
    }

    function updateLeaderboardUI(scores) {
        const createRows = (limit) => {
            if (scores.length === 0) return `<tr><td colspan="4">å°šç„¡ç´€éŒ„ï¼Œå¿«ä¾†ç•¶ç¬¬ä¸€åï¼</td></tr>`;
            return scores.slice(0, limit).map((s, i) => {
                let rank = i + 1;
                let medal = "";
                if (rank === 1) medal = "ğŸ¥‡";
                else if (rank === 2) medal = "ğŸ¥ˆ";
                else if (rank === 3) medal = "ğŸ¥‰";
                else medal = rank + ".";
                
                // --- MODIFIED: Simplify Lesson Name ---
                let lessonDisplay = s.lesson || "-";
                const match = lessonDisplay.match(/ç¬¬\s*\d+\s*èª²/);
                if (match) {
                    lessonDisplay = match[0]; 
                } else if (lessonDisplay.includes("å…¨éƒ¨")) {
                    lessonDisplay = "å…¨å†Š";
                } else {
                    lessonDisplay = lessonDisplay.split('ï¼š')[0];
                    if (lessonDisplay.length > 6) lessonDisplay = lessonDisplay.substring(0, 5) + "..";
                }
                // -------------------------------------

                return `
                    <tr>
                        <td>${medal}</td>
                        <td style="font-weight:bold; color:var(--text-color);">${s.name}</td>
                        <td style="color:var(--accent-color); font-weight:900;">${s.score}</td>
                        <td style="font-size:0.8em; color:#666;">${lessonDisplay}</td>
                    </tr>
                `;
            }).join('');
        };

        const modalBody = document.getElementById('leaderboard-body-modal');
        if(modalBody) modalBody.innerHTML = createRows(20);

        const gameoverBody = document.getElementById('leaderboard-body-gameover');
        if(gameoverBody) gameoverBody.innerHTML = createRows(5);
        
        const completeBody = document.getElementById('leaderboard-body-complete');
        if(completeBody) completeBody.innerHTML = createRows(5);
    }

</script>

<!-- Existing Game Logic Script -->
<script>
    // --- Safe Audio Context ---
    const AudioContext = window.AudioContext || window.webkitAudioContext;
    let audioCtx;
    if (AudioContext) {
        try {
            audioCtx = new AudioContext();
        } catch(e) {
            console.warn("AudioContext creation failed:", e);
        }
    }

    function playTone(freq, type, duration) {
        if (!isSoundOn || !audioCtx) return;
        if (audioCtx.state === 'suspended') {
            audioCtx.resume().catch(e => console.warn("Audio resume failed", e));
        }
        
        try {
            const osc = audioCtx.createOscillator();
            const gainNode = audioCtx.createGain();
            
            osc.type = type;
            osc.frequency.setValueAtTime(freq, audioCtx.currentTime);
            
            gainNode.gain.setValueAtTime(0.1, audioCtx.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + duration);
            
            osc.connect(gainNode);
            gainNode.connect(audioCtx.destination);
            
            osc.start();
            osc.stop(audioCtx.currentTime + duration);
        } catch(e) {
            console.warn("Play tone failed", e);
        }
    }

    function playEatSound() { playTone(440, 'sine', 0.1); }
    function playBonusSound() { 
        playTone(523.25, 'triangle', 0.1); // C5
        setTimeout(() => playTone(659.25, 'triangle', 0.2), 100); // E5
    }
    function playLevelUpSound() {
        playTone(523.25, 'square', 0.1); 
        setTimeout(() => playTone(659.25, 'square', 0.1), 100); 
        setTimeout(() => playTone(783.99, 'square', 0.2), 200); 
    }
    function playCrashSound() { playTone(150, 'sawtooth', 0.3); }
    function playBombSound() { 
        playTone(100, 'sawtooth', 0.1); 
        setTimeout(() => playTone(80, 'sawtooth', 0.3), 50);
    }

    const rawLessonData = {
        "1": [
            "è€å¸«ï¼šä»Šå¤©ï¼Œæˆ‘å€‘æœ‰å…©å€‹æ–°åŒå­¸ã€‚",
            "è€å¸«ï¼šç¾åœ¨è«‹ä»–å€‘ä»‹ç´¹è‡ªå·±ã€‚",
            "å‹æœ‹ï¼šå¤§å®¶å¥½ï¼Œæˆ‘å«æ–¹å‹æœ‹ï¼Œä»Šå¹´å…«æ­²ã€‚",
            "å‹æœ‹ï¼šæˆ‘æœ€å–œæ­¡è·Ÿçˆ¸çˆ¸ä¸€èµ·æ¸¸æ³³ã€‚",
            "å¼µè‰ï¼šå¤§å®¶å¥½ï¼Œæˆ‘å«å¼µè‰ï¼Œä»Šå¹´ä¸ƒæ­²ã€‚",
            "å¼µè‰ï¼šæˆ‘æ¯”è¼ƒå–œæ­¡çœ‹æ›¸ã€‚",
            "å¤§æ–‡ï¼šä½ å€‘å¥½ï¼Œæˆ‘å«æå¤§æ–‡ã€‚",
            "å¤§æ–‡ï¼šå¾ˆé«˜èˆˆèªè­˜ä½ å€‘ã€‚",
            "è€å¸«ï¼šæ­¡è¿ä½ å€‘ä¾†ä¸­æ–‡å­¸æ ¡å­¸è¯èªã€‚"
        ],
        "2": [
            "å¤§æ–‡ï¼šå¼µè‰ï¼Œç…§ç‰‡è£¡é¢çš„äººæ˜¯èª°ï¼Ÿ",
            "å¼µè‰ï¼šå·¦é‚Šæ˜¯æˆ‘å¤–å…¬ï¼Œä»–ä»¥å‰æ˜¯é†«ç”Ÿã€‚",
            "å¼µè‰ï¼šå³é‚Šæ˜¯æˆ‘å¤–å©†ã€‚",
            "å¤§æ–‡ï¼šä½ çˆ¸çˆ¸åª½åª½åšä»€éº¼å·¥ä½œï¼Ÿ",
            "å¼µè‰ï¼šæˆ‘çˆ¸çˆ¸åšç”Ÿæ„ï¼Œæˆ‘åª½åª½å¹«ä»–ã€‚",
            "å¼µè‰ï¼šä½ çˆ¸çˆ¸åª½åª½å‘¢?",
            "å¤§æ–‡ï¼šæˆ‘çˆ¸çˆ¸åœ¨é›»è…¦å…¬å¸ä¸Šç­ã€‚",
            "å¤§æ–‡ï¼šæˆ‘åª½åª½åœ¨éŠ€è¡Œå·¥ä½œã€‚",
            "å¤§æ–‡ï¼šä½ ä»¥å¾Œæƒ³åšä»€éº¼ï¼Ÿ",
            "å¼µè‰ï¼šæˆ‘ä»¥å¾Œæƒ³è·Ÿçˆ¸çˆ¸ä¸€æ¨£ã€‚"
        ],
        "3": [
            "å¤§æ–‡ï¼šåª½åª½ï¼Œä½ è¦å»å“ªè£¡ï¼Ÿ",
            "åª½åª½ï¼šæˆ‘è¦å»é™„è¿‘çš„è¶…ç´šå¸‚å ´è²·æ±è¥¿ã€‚",
            "åª½åª½ï¼šä½ è¦è·Ÿæˆ‘ä¸€èµ·å»å—ï¼Ÿ",
            "å¤§æ–‡ï¼šè¦ï¼Œæˆ‘æƒ³å»è²·å·§å…‹åŠ›å†°æ·‡æ·‹ã€‚",
            "å¤§æ–‡ï¼šä½ ä»Šå¤©è¦è²·ä»€éº¼ï¼Ÿ",
            "åª½åª½ï¼šæˆ‘ä»Šå¤©è¦è²·é­šã€ç‰›è‚‰ã€é’èœï¼Œé‚„è¦è²·ç±³ã€‚",
            "å¤§æ–‡ï¼šæˆ‘ä¹Ÿå¯ä»¥è²·ç³–æœå—ï¼Ÿ",
            "åª½åª½ï¼šæˆ‘å€‘å»çœ‹ä¸€ä¸‹å§ï¼"
        ],
        "4": [
            "æ–‡æ–‡ï¼šæˆ‘æƒ³åƒæ¼¢å ¡è·Ÿè–¯æ¢ã€‚",
            "æ–‡æ–‡ï¼šæˆ‘å€‘å¯ä¸å¯ä»¥å‡ºå»åƒï¼Ÿ",
            "åª½åª½ï¼šä»Šå¤©å…ˆåœ¨å®¶åƒï¼Œé€±æœ«å†å‡ºå»åƒå§ï¼",
            "åª½åª½ï¼šä»Šå¤©æ™šé¤æƒ³åƒä»€éº¼ï¼Ÿ",
            "å¤§æ–‡ï¼šæˆ‘æƒ³åƒéºµã€‚æ–‡æ–‡ï¼Œä½ å‘¢ï¼Ÿ",
            "æ–‡æ–‡ï¼šæˆ‘æƒ³åƒè›‹ç‚’é£¯ï¼Œæœ‰æ¹¯å—ï¼Ÿ",
            "åª½åª½ï¼šæˆ‘å·²ç¶“åšäº†ç‰ç±³æ¹¯ã€‚",
            "å¤§æ–‡ï¼šåª½ï¼Œæˆ‘ç¾åœ¨å¾ˆé¤“ï¼Œæƒ³å¿«é»åƒæ™šé£¯ï¼Œå¥½å—ï¼Ÿ"
        ],
        "5": [
            "å¤§æ–‡ï¼šä½ çœ‹ï¼æ¨¹è‘‰è®Šé»ƒäº†ï¼Œç§‹å¤©å¿«åˆ°äº†ã€‚",
            "å¼µè‰ï¼šå¯æ˜¯è‰é‚„æ˜¯ç¶ è‰²çš„ã€‚",
            "å¿ƒç¾ï¼šç§‹å¤©å¤©æ°£å¾ˆå¥½ã€‚æˆ‘è¦ºå¾—å¾ˆèˆ’æœã€‚",
            "æ±æ˜ï¼šæ˜¥å¤©ä¹Ÿä¸éŒ¯ã€‚",
            "å¤§æ–‡ï¼šæ˜¥å¤©çš„æ™‚å€™ï¼Œæˆ‘å€‘å®¶é™¢å­æœ‰å¾ˆå¤šé¡è‰²çš„èŠ±ã€‚",
            "å¤§æ–‡ï¼šç´…è‰²çš„ã€ç™½è‰²çš„éƒ½æœ‰ã€‚",
            "å¿ƒç¾ï¼šæˆ‘è¦ºå¾—ç´…è‰²çš„èŠ±æœ€æ¼‚äº®ã€‚"
        ],
        "6": [
            "å¤§æ–‡ï¼šè€å¸«èªªè¾²æ›†æ–°å¹´å¿«åˆ°äº†ã€‚",
            "çˆ¸çˆ¸ï¼šå°ï¼Œä¸‹å€‹æ˜ŸæœŸäº”æ˜¯è¾²æ›†æ–°å¹´ã€‚",
            "å¤§æ–‡ï¼šåª½åª½æœƒå»è¯äººè¶…å¸‚è²·å¹´ç³•å—ï¼Ÿ",
            "çˆ¸çˆ¸ï¼šæœƒï¼Œé‚£å¤©æˆ‘å€‘é‚„è¦çµ¦çˆºçˆºå¥¶å¥¶æ‹œå¹´ã€‚",
            "å¤§æ–‡ï¼šå¤ªå¥½äº†ï¼Œçˆºçˆºæ¯å¹´éƒ½æœƒçµ¦æˆ‘ç´…åŒ…ã€‚",
            "çˆ¸çˆ¸ï¼šå¦‚æœåœ¨è‡ºç£ï¼Œæˆ‘å€‘é‚„æœƒè²¼æ˜¥è¯ã€æ”¾é­ç‚®ã€‚"
        ],
        "7": [
            "çˆ¸çˆ¸ï¼šå¤§æ–‡ï¼Œè©²èµ·åºŠäº†ï¼ä¾†ä¸åŠäº†ï¼",
            "å¤§æ–‡ï¼šæˆ‘å¾ˆç´¯ï¼Œé‚„æƒ³ç¡è¦ºã€‚",
            "çˆ¸çˆ¸ï¼šä»Šå¤©æ™šä¸Šæ—©ä¸€é»ç¡,ç¾åœ¨è¶•å¿«å»åˆ·ç‰™ã€æ´—æ¾¡ã€‚",
            "å¤§æ–‡ï¼šæˆ‘æ˜¨å¤©æ™šä¸Šæ´—éæ¾¡äº†ã€‚",
            "çˆ¸çˆ¸ï¼šé‚„æœ‰ï¼Œåˆ¥å¿˜äº†ç”¨è‚¥çš‚æ´—è‡‰ã€‚",
            "å¤§æ–‡ï¼šæˆ‘çŸ¥é“äº†ï¼Œè¦æ´—ä¹¾æ·¨ã€‚"
        ],
        "8": [
            "å¿ƒç¾ï¼šæ˜¨å¤©æˆ‘çˆ¸çˆ¸çš„æœ‹å‹é€çµ¦æˆ‘ä¸€éš»ç‹—ã€‚",
            "å¿ƒç¾ï¼šä½ å€‘å®¶æœ‰å¯µç‰©å—ï¼Ÿ",
            "å¤§æ–‡ï¼šæœ‰ï¼Œæˆ‘å®¶æœ‰å…©éš»ç‹—ï¼Œæˆ‘æ¯å¤©éƒ½å¸¶ç‰ å€‘å»æ•£æ­¥ã€‚",
            "å¿ƒç¾ï¼šå¼µè‰ï¼Œä½ é¤Šéç‹—å—ï¼Ÿ",
            "å¼µè‰ï¼šæˆ‘æ²’é¤Šéç‹—ï¼Œæˆ‘å»å¹´é¤Šäº†ä¸€éš»è²“ï¼Œå¯æ˜¯ä¸Šå€‹æœˆä¸è¦‹äº†ã€‚",
            "å‹æœ‹ï¼šæˆ‘ä¹Ÿé¤Šéè²“ï¼Œéå¸¸å¯æ„›ï¼Œæˆ‘æ¯å¤©éƒ½é¤µç‰ ã€‚",
            "å¼µè‰ï¼šä»¥å¾Œæˆ‘æƒ³é¤Šä¸€éš»å…”å­ã€‚"
        ],
        "9": [
            "å‹æœ‹ï¼šæ±æ˜ï¼Œé€™æ˜¯ä»€éº¼ï¼Ÿ",
            "æ±æ˜ï¼šæŒ‡å—é‡ï¼Œä¹Ÿå«æŒ‡åŒ—é‡ï¼Œå®ƒå‘Šè¨´æˆ‘å€‘å—æ–¹å’ŒåŒ—æ–¹åœ¨å“ªè£¡ã€‚",
            "å‹æœ‹ï¼šéŸ³æ¨‚æ•™å®¤æ˜¯ä»€éº¼æ–¹å‘ï¼Ÿ",
            "æ±æ˜ï¼šéŸ³æ¨‚æ•™å®¤åœ¨åŒ—æ–¹ï¼Œæ ¡é–€å£åœ¨å—æ–¹ã€‚",
            "å‹æœ‹ï¼šè¶³çƒå ´åœ¨æ±æ–¹ï¼Œé‚„æ˜¯è¥¿æ–¹ï¼Ÿ",
            "æ±æ˜ï¼šå› ç‚ºéŸ³æ¨‚æ•™å®¤åœ¨åŒ—æ–¹ï¼Œæ‰€ä»¥è¶³çƒå ´åœ¨æ±æ–¹ã€‚"
        ],
        "10": [
            "å¿ƒç¾ï¼šæš‘å‡çš„æ™‚å€™ï¼Œæˆ‘æœƒå»è‡ºç£çœ‹å¤–å…¬ã€å¤–å©†ã€‚",
            "å¼µè‰ï¼šä½ å¤–å…¬ã€å¤–å©†å®¶åœ¨å“ªè£¡ï¼Ÿ",
            "å¿ƒç¾ï¼šä»–å€‘æœ¬ä¾†ä½åœ¨è‡ºåŒ—ï¼Œé€€ä¼‘ä»¥å¾Œï¼Œè·Ÿæˆ‘çš„èˆ…èˆ…ä½åœ¨è‡ºå—ã€‚",
            "å¼µè‰ï¼šä½ å€‘æ¯å¹´éƒ½å»çœ‹å¤–å…¬å¤–å©†å—ï¼Ÿ",
            "å¿ƒç¾ï¼šæˆ‘å€‘æ¯å¹´éƒ½å»çœ‹ä»–å€‘ä¸€æ¬¡ï¼Œä½ å¤–å…¬å¤–å©†ä½åœ¨å“ªè£¡ï¼Ÿ",
            "å¼µè‰ï¼šæˆ‘å¤–å…¬ã€å¤–å©†ç¾åœ¨ä½åœ¨ç´ç´„ï¼Œä»–å€‘ä¸‹å€‹æœˆæœƒä¾†çœ‹æˆ‘å€‘ã€‚",
            "å¿ƒç¾ï¼šæˆ‘å¤–å…¬ã€å¤–å©†å–œæ­¡æ—…è¡Œï¼Œå¸¸å¸¸ä¾†çœ‹æˆ‘å€‘ï¼Œä¹Ÿå¸¸å»æ³•åœ‹çœ‹é˜¿å§¨ã€‚"
        ],
        "11": [
            "å¿ƒç¾ï¼šä¸‹å€‹æ˜ŸæœŸäº”ï¼Œå­¸æ ¡è¦å¸¶æˆ‘å€‘å»å‹•ç‰©åœ’ç©ã€‚",
            "å¿ƒç¾å“¥å“¥ï¼šå¤ªå¥½äº†ï¼ä½ å¯ä»¥çœ‹åˆ°ä½ å–œæ­¡çš„å¤§è±¡å’Œè€è™ã€‚",
            "å¿ƒç¾ï¼šé€™ä¸€æ¬¡æˆ‘å¸Œæœ›å¯ä»¥çœ‹åˆ°ç†Šè²“å’ŒçŒ´å­ã€‚",
            "å¿ƒç¾å“¥å“¥ï¼šå°ï¼Œä»¥å‰æˆ‘å»çš„æ™‚å€™ï¼Œå‹•ç‰©åœ’æ²’æœ‰ç†Šè²“ã€‚",
            "çˆ¸çˆ¸ï¼šç¾åœ¨ä¸ä½†æœ‰ç†Šè²“ï¼Œé‚„æœ‰ä¼éµã€‚",
            "å¿ƒç¾ï¼šæˆ‘è¦ºå¾—ç†Šè²“èƒ–èƒ–çš„ï¼ŒçœŸå¯æ„›ï¼",
            "å¿ƒç¾å“¥å“¥ï¼šæˆ‘å–œæ­¡é•·é ¸é¹¿ï¼Œè„–å­é•·é•·çš„ã€‚"
        ],
        "12": [
            "çˆ¸çˆ¸ï¼šå¤§æ–‡ï¼Œæˆ‘ç¾åœ¨è¦ç”¨ç¶²è·¯çµ¦å§‘å§‘æ‰“é›»è©±ã€‚",
            "å¤§æ–‡ï¼šå¯ä»¥çœ‹åˆ°å§‘å§‘å—ï¼Ÿæˆ‘å¾ˆä¹…æ²’è·Ÿå§‘å§‘èªªè©±äº†ã€‚",
            "çˆ¸çˆ¸ï¼šå¯ä»¥çœ‹åˆ°å¥¹çš„å½±åƒï¼Œå¿«ä¸€é»éä¾†ã€‚",
            "å§‘å§‘ï¼šå¤§æ–‡ï¼Œä½ çœ‹èµ·ä¾†ç˜¦äº†ã€‚",
            "å¤§æ–‡ï¼šæˆ‘æ²’ç˜¦ï¼Œæˆ‘é•·é«˜äº†ã€‚",
            "å§‘å§‘ï¼šæ–‡æ–‡ç¾åœ¨ä¹Ÿè·Ÿä½ ä¸€èµ·å»å­¸è¯èªå—?",
            "å¤§æ–‡ï¼šæ˜¯å•Šï¼ä¸Šä¸­æ–‡èª²å¾ˆæœ‰æ„æ€ã€‚",
            "å§‘å§‘ï¼šä½ å¥½å¥½å­¸è¯èªï¼Œä»¥å¾Œå¯ä»¥ç”¨ç¶²è·¯çµ¦æˆ‘å¯«ä¿¡ã€‚",
            "å¤§æ–‡ï¼šæ²’å•é¡Œï¼Œæˆ‘ä¸€å®šæœƒå¥½å¥½å­¸è¯èªã€‚"
        ]
    };

    const lessonData = {};
    for (let key in rawLessonData) {
        lessonData[key] = rawLessonData[key].map(sentence => {
            return sentence.replace(/^[^ï¼š]+ï¼š/, '');
        });
    }

    // --- Game Variables ---
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    const scoreElement = document.getElementById('score');
    const levelElement = document.getElementById('level');
    const livesElement = document.getElementById('lives');
    const progressCurrentElement = document.getElementById('progress-current');
    const progressTotalElement = document.getElementById('progress-total');
    const sentenceDisplay = document.getElementById('current-sentence-display');
    
    // Screens & Modals
    const startScreen = document.getElementById('start-screen');
    const startTitle = document.getElementById('start-title');
    const gameOverScreen = document.getElementById('game-over-screen');
    const lessonCompleteScreen = document.getElementById('lesson-complete-screen');
    const quitModal = document.getElementById('quit-modal');
    const leaderboardModal = document.getElementById('leaderboard-modal');
    const modalBackdrop = document.getElementById('backdrop'); // Backdrop
    
    // Game Over Elements
    const gameOverTitle = document.getElementById('game-over-title');
    const gameOverName = document.getElementById('game-over-name');
    const gameOverLesson = document.getElementById('game-over-lesson');
    const finalScoreElement = document.getElementById('final-score');
    
    // Lesson Complete Elements
    const completeLessonName = document.getElementById('complete-lesson-name');
    const completeScore = document.getElementById('complete-score');

    // Controls
    const lessonSelect = document.getElementById('lesson-select');
    const playerInput = document.getElementById('player-name');
    const soundBtn = document.getElementById('sound-btn');
    const pauseBtn = document.getElementById('pause-btn');
    const pauseOverlay = document.getElementById('pause-overlay');

    // Config
    const gridSize = 30; // Increased size to make grid smaller (20x20)
    const tileCount = canvas.width / gridSize;
    let initialSpeed = 5;
    let speed = initialSpeed;
    
    // State
    let score = 0;
    let lives = 5; 
    let snake = [];
    let food = { x: 10, y: 10, char: '' };
    // Bonus Item with Icon
    let bonusItem = { x: -1, y: -1, active: false, timer: 0, icon: '' }; 
    const fruitIcons = ['ğŸ', 'ğŸŒ', 'ğŸ‡', 'ğŸŠ', 'ğŸ“', 'ğŸ‰', 'ğŸ’', 'ğŸ‘', 'ğŸ', 'ğŸ¥'];
    
    // Bomb Item
    let bombItem = { x: -1, y: -1, active: false, timer: 0 };
    
    let dx = 0;
    let dy = 0;
    let gameLoop;
    let isGameRunning = false;
    let isPaused = false;
    let isTransitioning = false;
    let playerName = "";
    let heartbeatInterval = null;
    
    // Particles & Popups
    let particles = [];
    let popups = []; 
    
    // Sentence Logic State
    let currentLessonSentences = [];
    let availableIndices = []; 
    let sentencesCompleted = 0;
    let totalSentencesCount = 0;
    let activeLesson = "all";
    let currentSentence = "";
    let charIndex = 0;
    let eatenSentenceChars = []; 
    
    // Sound State
    let isSoundOn = true;

    // --- Check URL Params Immediately ---
    (function checkParams() {
        const urlParams = new URLSearchParams(window.location.search);
        const lessonParam = urlParams.get('lesson');
        if (lessonParam) {
            const select = document.getElementById('lesson-select');
            // Verify if lesson exists in select options
            const option = select.querySelector(`option[value="${lessonParam}"]`);
            if (option) {
                select.value = lessonParam;
                
                // Visual Feedback
                const lessonText = option.text.split('ï¼š')[0]; // Get "ç¬¬ X èª²"
                if (startTitle) {
                    startTitle.innerHTML = `æŒ‘æˆ°ï¼š<span style="color:#E76F51">${lessonText}</span>`;
                }
                
                // Auto Focus Name
                if (playerInput) playerInput.focus();
            }
        }
        
        // Auto-load player name from localStorage
        const savedName = localStorage.getItem('snake_player_name');
        if (savedName) {
            playerInput.value = savedName;
        }
    })();

    // --- Share Function ---
    window.shareLesson = function() {
        const lessonVal = document.getElementById('lesson-select').value;
        const url = new URL(window.location.href);
        url.searchParams.set('lesson', lessonVal);
        
        const tempInput = document.createElement("textarea");
        tempInput.style.position = "absolute";
        tempInput.style.left = "-9999px";
        tempInput.value = url.toString();
        document.body.appendChild(tempInput);
        tempInput.select();
        document.execCommand("copy");
        document.body.removeChild(tempInput);

        showToast("å·²è¤‡è£½èª²ç¨‹é€£çµï¼å‚³çµ¦å­¸ç”Ÿå§ ğŸ“");
    }

    function showToast(msg) {
        const toast = document.getElementById("toast");
        toast.innerText = msg;
        toast.className = "show";
        setTimeout(function(){ toast.className = toast.className.replace("show", ""); }, 3000);
    }

    // --- Modal Functions ---
    window.showLeaderboardModal = function() {
        modalBackdrop.classList.remove('hidden');
        leaderboardModal.classList.remove('hidden');
    }
    
    window.hideLeaderboardModal = function() {
        modalBackdrop.classList.add('hidden');
        leaderboardModal.classList.add('hidden');
    }

    // --- Helper Function isPunctuation ---
    function isPunctuation(char) {
        return /[ï¼Œã€‚ã€ï¼Ÿï¼ï¼šï¼›ã€Œã€ã€ã€\s,.?!:;"'()ï¼ˆï¼‰]/.test(char);
    }

    // --- Helper for Pronunciation Fixes ---
    function getCorrectAudioText(char, index, sentence) {
        if (char === 'è¡Œ') {
            const prev = index > 0 ? sentence[index - 1] : '';
            const next = index < sentence.length - 1 ? sentence[index + 1] : '';
            if (prev === 'éŠ€' || next === 'æ¥­') return 'èˆª'; 
            return 'å½¢';
        }
        if (char === 'è¦º') {
            const prev = index > 0 ? sentence[index - 1] : '';
            if (prev === 'ç¡' || prev === 'åˆ') return 'å«'; 
            return 'çµ•';
        }
        if (char === 'æ¨‚') {
            const prev = index > 0 ? sentence[index - 1] : '';
            const next = index < sentence.length - 1 ? sentence[index + 1] : '';
            if (prev === 'éŸ³' || prev === 'åœ‹' || next === 'éšŠ') return 'æœˆ'; 
            return 'å‹’'; 
        }
        if (char === 'é•·') {
            const next = index < sentence.length - 1 ? sentence[index + 1] : '';
            const prev = index > 0 ? sentence[index - 1] : '';
            if (next === 'é«˜' || next === 'å¤§' || prev === 'å®¶' || prev === 'å¸«') return 'æŒ'; 
            return 'å¸¸'; 
        }
        if (char === 'å‡') {
            const prev = index > 0 ? sentence[index - 1] : '';
            if (prev === 'æš‘' || prev === 'å¯’' || prev === 'æ”¾') return 'æ¶';
            return 'ç”²'; 
        }
        if (char === 'å¾—') {
            const prev = index > 0 ? sentence[index - 1] : '';
            const next = index < sentence.length - 1 ? sentence[index + 1] : '';
            if (next === 'åˆ°' || next === 'åˆ†') return 'å¾·';
            return 'å¾·';
        }
        if (char === 'æ•™') {
            const next = index < sentence.length - 1 ? sentence[index + 1] : '';
            if (next === 'å®¤' || next === 'è‚²' || next === 'ç·´') return 'å«';
            return 'äº¤';
        }
        if (char === 'ä»€') {
            const next = index < sentence.length - 1 ? sentence[index + 1] : '';
            if (next === 'éº¼') return 'ç¥';
            return 'å';
        }
        if (char === 'éƒ½') {
            return 'å…œ';
        }
        return char;
    }

    // --- Logic ---
    function initGame() {
        resetSnakePos();
        score = 0;
        lives = 5;
        eatenSentenceChars = []; 
        particles = [];
        popups = [];
        bonusItem = { x: -1, y: -1, active: false, timer: 0, icon: '' };
        bombItem = { x: -1, y: -1, active: false, timer: 0 };
        
        scoreElement.innerText = score;
        levelElement.innerText = 1;
        levelElement.style.color = "";
        updateLivesDisplay();
        
        speed = initialSpeed;
        isTransitioning = false;
        
        loadSentences();
        startNewSentence();
        
        // Reset combo
        comboCount = 0;
        comboTimer = 0;
    }
    
    function resetSnakePos() {
        snake = [
            { x: 10, y: 10 },
            { x: 9, y: 10 },
            { x: 8, y: 10 }
        ];
        dx = 1;
        dy = 0;
    }

    function updateLivesDisplay() {
        let hearts = "";
        for(let i=0; i<lives; i++) hearts += "â¤ï¸";
        for(let i=lives; i<5; i++) hearts += "ğŸ–¤";
        livesElement.innerText = hearts;
    }

    window.toggleSound = function() {
        isSoundOn = !isSoundOn;
        if (isSoundOn) {
            soundBtn.innerText = "ğŸ”Š";
            soundBtn.style.opacity = "1";
            if(audioCtx && audioCtx.state === 'suspended') audioCtx.resume();
        } else {
            soundBtn.innerText = "ğŸ”‡";
            soundBtn.style.opacity = "0.5";
            if ('speechSynthesis' in window) {
                window.speechSynthesis.cancel();
            }
        }
    }

    window.toggleFullscreen = function() {
        if (!document.fullscreenElement) {
            document.documentElement.requestFullscreen().catch(err => {
                console.log(`Error attempting to enable full-screen mode: ${err.message}`);
            });
            document.body.classList.add('fullscreen-mode');
        } else {
            if (document.exitFullscreen) {
                document.exitFullscreen();
                document.body.classList.remove('fullscreen-mode');
            }
        }
    }

    // Listener for fullscreen change (ESC key etc)
    document.addEventListener('fullscreenchange', (event) => {
        if (!document.fullscreenElement) {
            document.body.classList.remove('fullscreen-mode');
        } else {
            document.body.classList.add('fullscreen-mode');
        }
    });

    window.togglePause = function() {
        if (!isGameRunning) return;
        
        isPaused = !isPaused;
        if (isPaused) {
            pauseBtn.innerText = "â–¶ï¸";
            pauseOverlay.classList.remove('hidden');
        } else {
            pauseBtn.innerText = "â¸ï¸";
            pauseOverlay.classList.add('hidden');
        }
    }

    window.triggerQuit = function() {
        if (!isGameRunning && startScreen.classList.contains('hidden') === false) return; 
        if (isGameRunning && !isPaused) togglePause(); 
        quitModal.classList.remove('hidden');
    }

    window.confirmQuit = function() {
        quitModal.classList.add('hidden');
        isGameRunning = false;
        clearInterval(gameLoop);
        clearInterval(heartbeatInterval);
        isPaused = false;
        pauseOverlay.classList.add('hidden');
        pauseBtn.innerText = "â¸ï¸"; 
        if ('speechSynthesis' in window) window.speechSynthesis.cancel();
        gameOverScreen.classList.add('hidden');
        lessonCompleteScreen.classList.add('hidden');
        startScreen.classList.remove('hidden');
    }

    window.cancelQuit = function() {
        quitModal.classList.add('hidden');
    }

    // --- Enhanced Voice Logic for Cross-Platform Support ---
    let targetVoice = null;

    function initVoices() {
        if (!('speechSynthesis' in window)) return;
        
        const voices = window.speechSynthesis.getVoices();
        
        // Priority: zh-TW -> zh-HK -> zh-CN -> any 'zh'
        // This ensures Chinese pronunciation even on English OS
        targetVoice = voices.find(v => v.lang.replace('_', '-').toLowerCase() === 'zh-tw') ||
                      voices.find(v => v.lang.includes('zh-TW') || v.lang.includes('zh_TW')) ||
                      voices.find(v => v.lang.includes('zh-HK') || v.lang.includes('zh_HK')) ||
                      voices.find(v => v.lang.includes('zh-CN') || v.lang.includes('zh_CN')) ||
                      voices.find(v => v.lang.toLowerCase().includes('zh'));
    }

    // Chrome loads voices asynchronously, so we listen for the event
    if ('speechSynthesis' in window) {
        window.speechSynthesis.onvoiceschanged = initVoices;
        initVoices(); // Try immediately in case they are ready
    }

    function speakText(text) {
        if (!isSoundOn) return;
        if ('speechSynthesis' in window) {
            // Try to init voices again if not found yet (sometimes needed for mobile)
            if (!targetVoice) initVoices();

            window.speechSynthesis.cancel();
            const utterance = new SpeechSynthesisUtterance(text);
            
            // Explicitly set the Chinese voice object
            // This is the key fix for English OS environments
            if (targetVoice) {
                utterance.voice = targetVoice;
            }
            
            // Fallback language setting
            utterance.lang = 'zh-TW'; 
            utterance.rate = 0.85; 
            window.speechSynthesis.speak(utterance);
        }
    }
    
    window.replayCurrentAudio = function() {
        if (currentSentence) speakText(currentSentence);
    }

    function advanceToNextChar() {
        while (charIndex < currentSentence.length && isPunctuation(currentSentence[charIndex])) {
            charIndex++;
        }
    }

    function loadSentences() {
        activeLesson = lessonSelect.value;
        currentLessonSentences = [];
        if (activeLesson === "all") {
            for (let key in lessonData) {
                currentLessonSentences = currentLessonSentences.concat(lessonData[key]);
            }
        } else {
            currentLessonSentences = lessonData[activeLesson];
        }
        availableIndices = currentLessonSentences.map((_, index) => index);
        sentencesCompleted = 0;
        totalSentencesCount = currentLessonSentences.length;
        updateProgressDisplay();
    }

    function updateProgressDisplay() {
        progressCurrentElement.innerText = sentencesCompleted;
        progressTotalElement.innerText = totalSentencesCount;
    }

    function startNewSentence() {
        eatenSentenceChars = [];
        if (availableIndices.length === 0) {
            showLessonComplete();
            return;
        }
        const poolIndex = Math.floor(Math.random() * availableIndices.length);
        const sentenceIndex = availableIndices[poolIndex];
        availableIndices.splice(poolIndex, 1);
        currentSentence = currentLessonSentences[sentenceIndex];
        charIndex = 0;
        isTransitioning = false;
        advanceToNextChar();
        updateSentenceDisplay();
        speakText(currentSentence);
        createFood();
        bonusItem.active = false;
        bombItem.active = false;
        
        // Reset Combo on new sentence? Maybe not, keep flow
    }
    
    function showLessonComplete() {
        isGameRunning = false;
        clearInterval(gameLoop);
        clearInterval(heartbeatInterval);
        playLevelUpSound(); 
        const lessonName = lessonSelect.options[lessonSelect.selectedIndex].text;
        completeLessonName.innerText = lessonName;
        completeScore.innerText = score;
        
        if(window.saveScoreToCloud) {
            window.saveScoreToCloud(playerName, score, lessonName);
        }

        const currentVal = lessonSelect.value;
        const btnPrev = document.getElementById('btn-prev-lesson');
        const btnNext = document.getElementById('btn-next-lesson');
        const navContainer = document.getElementById('lesson-nav-buttons');

        if (currentVal === 'all') {
            navContainer.classList.add('hidden');
        } else {
            navContainer.classList.remove('hidden');
            const currentNum = parseInt(currentVal);
            if (currentNum > 1) {
                btnPrev.classList.remove('hidden');
                btnPrev.onclick = () => changeLesson(currentNum - 1);
            } else {
                btnPrev.classList.add('hidden');
            }
            if (currentNum < 12) {
                btnNext.classList.remove('hidden');
                btnNext.onclick = () => changeLesson(currentNum + 1);
            } else {
                btnNext.classList.add('hidden');
            }
        }
        lessonCompleteScreen.classList.remove('hidden');
        if ('speechSynthesis' in window) window.speechSynthesis.cancel();
    }

    function changeLesson(lessonNum) {
        lessonSelect.value = lessonNum.toString();
        startGame(); 
    }

    function updateSentenceDisplay() {
        let html = '';
        for (let i = 0; i < currentSentence.length; i++) {
            let char = currentSentence[i];
            if (i < charIndex) {
                html += `<span class="char-eaten">${char}</span>`;
            } else if (i === charIndex) {
                html += `<span class="char-current">${char}</span>`;
            } else {
                html += `<span class="char-pending">${char}</span>`;
            }
        }
        html += `<button id="replay-btn" onclick="replayCurrentAudio()" title="é‡è½ä¸€æ¬¡">ğŸ”Š</button>`;
        sentenceDisplay.innerHTML = html;
    }
    
    window.startGame = function() {
        playerName = playerInput.value.trim();
        if (!playerName) playerName = "å°å‹‡å£«";
        
        // Save Name
        localStorage.setItem('snake_player_name', playerName);

        // Get Current Lesson Text
        let currentLessonVal = document.getElementById('lesson-select').value;
        let lessonText = currentLessonVal === 'all' ? 'å…¨å†Š' : `ç¬¬${currentLessonVal}èª²`;
        
        if(window.sendHeartbeat) {
            window.sendHeartbeat(playerName, lessonText);
            if (heartbeatInterval) clearInterval(heartbeatInterval);
            heartbeatInterval = setInterval(() => window.sendHeartbeat(playerName, lessonText), 30000);
        }

        startScreen.classList.add('hidden');
        gameOverScreen.classList.add('hidden');
        lessonCompleteScreen.classList.add('hidden');
        isPaused = false;
        pauseOverlay.classList.add('hidden');
        pauseBtn.innerText = "â¸ï¸";
        isTransitioning = false;
        
        // Resume audio context
        if(audioCtx && audioCtx.state === 'suspended') {
            audioCtx.resume();
        }

        initGame();
        isGameRunning = true;
        clearInterval(gameLoop);
        gameLoop = setInterval(drawGame, 1000 / speed);
    }

    window.showStartScreen = function() {
        gameOverScreen.classList.add('hidden');
        lessonCompleteScreen.classList.add('hidden');
        startScreen.classList.remove('hidden');
        isGameRunning = false;
        clearInterval(heartbeatInterval);
        if ('speechSynthesis' in window) window.speechSynthesis.cancel();
    }

    window.resetGame = function() {
        startGame();
    }

    function createFood() {
        if (charIndex < currentSentence.length) {
            food.char = currentSentence[charIndex];
            let valid = false;
            let attempts = 0;
            while (!valid && attempts < 100) {
                valid = true;
                food.x = Math.floor(Math.random() * tileCount);
                food.y = Math.floor(Math.random() * tileCount);
                snake.forEach(part => {
                    if (part.x === food.x && part.y === food.y) valid = false;
                });
                attempts++;
            }
        } else {
            food.x = -1; 
            food.y = -1;
        }
    }

    function manageBonus() {
        if (!bonusItem.active && !isTransitioning) {
            if (Math.random() < 0.02) { 
                let valid = false;
                let attempts = 0;
                while (!valid && attempts < 50) {
                    valid = true;
                    bonusItem.x = Math.floor(Math.random() * tileCount);
                    bonusItem.y = Math.floor(Math.random() * tileCount);
                    snake.forEach(part => { if (part.x === bonusItem.x && part.y === bonusItem.y) valid = false; });
                    if (bonusItem.x === food.x && bonusItem.y === food.y) valid = false;
                    if (bombItem.active && bonusItem.x === bombItem.x && bonusItem.y === bombItem.y) valid = false;
                    attempts++;
                }
                if (valid) {
                    bonusItem.active = true;
                    bonusItem.timer = 100; 
                    bonusItem.icon = fruitIcons[Math.floor(Math.random() * fruitIcons.length)]; 
                }
            }
        } else if (bonusItem.active) {
            bonusItem.timer--;
            if (bonusItem.timer <= 0) {
                bonusItem.active = false;
            }
        }

        if (!bombItem.active && !isTransitioning) {
            if (Math.random() < 0.015) {
                let valid = false;
                let attempts = 0;
                while (!valid && attempts < 50) {
                    valid = true;
                    bombItem.x = Math.floor(Math.random() * tileCount);
                    bombItem.y = Math.floor(Math.random() * tileCount);
                    snake.forEach(part => { if (part.x === bombItem.x && part.y === bombItem.y) valid = false; });
                    if (bombItem.x === food.x && bombItem.y === food.y) valid = false;
                    if (bonusItem.active && bombItem.x === bonusItem.x && bombItem.y === bonusItem.y) valid = false;
                    attempts++;
                }
                if (valid) {
                    bombItem.active = true;
                    bombItem.timer = 150; 
                }
            }
        } else if (bombItem.active) {
            bombItem.timer--;
            if (bombItem.timer <= 0) {
                bombItem.active = false;
            }
        }
    }

    function spawnParticles(x, y, color) {
        for (let i = 0; i < 12; i++) {
            particles.push({
                x: x * gridSize + gridSize/2,
                y: y * gridSize + gridSize/2,
                vx: (Math.random() - 0.5) * 8,
                vy: (Math.random() - 0.5) * 8,
                life: 1.0,
                color: color
            });
        }
    }

    function updateAndDrawParticles() {
        for (let i = particles.length - 1; i >= 0; i--) {
            let p = particles[i];
            p.x += p.vx;
            p.y += p.vy;
            p.life -= 0.05;
            
            if (p.life <= 0) {
                particles.splice(i, 1);
            } else {
                ctx.globalAlpha = p.life;
                ctx.fillStyle = p.color;
                ctx.beginPath();
                ctx.arc(p.x, p.y, 4, 0, Math.PI * 2);
                ctx.fill();
                ctx.globalAlpha = 1.0;
            }
        }
    }

    function spawnPopup(x, y, text, color) {
        popups.push({
            x: x * gridSize + gridSize/2,
            y: y * gridSize,
            text: text,
            life: 1.0,
            color: color
        });
    }

    function updateAndDrawPopups() {
        ctx.font = "bold 16px 'Noto Sans TC'";
        ctx.textAlign = "center";
        
        for (let i = popups.length - 1; i >= 0; i--) {
            let p = popups[i];
            p.y -= 1.0; 
            p.life -= 0.02; 
            
            if (p.life <= 0) {
                popups.splice(i, 1);
            } else {
                ctx.globalAlpha = p.life;
                ctx.fillStyle = p.color;
                ctx.shadowColor = "rgba(255, 255, 255, 0.8)";
                ctx.shadowBlur = 4;
                ctx.fillText(p.text, p.x, p.y);
                ctx.shadowBlur = 0; 
                ctx.globalAlpha = 1.0;
            }
        }
    }

    // Combo Variables
    let comboCount = 0;
    let comboTimer = 0;

    function drawGame() {
        if (!isGameRunning || isPaused) return;

        moveSnake();
        manageBonus();
        
        // Update combo timer
        if (comboTimer > 0) comboTimer--;
        else comboCount = 0; // Reset combo if time runs out

        if (checkCollision()) {
            handleCollision();
            return;
        }

        clearCanvas();
        // Draw grid lines
        ctx.lineWidth = 0.5;
        ctx.strokeStyle = "rgba(42, 157, 143, 0.2)"; // Light teal
        for(let i=0; i<tileCount; i++) {
             ctx.beginPath();
             ctx.moveTo(i*gridSize, 0);
             ctx.lineTo(i*gridSize, canvas.height);
             ctx.stroke();
             ctx.beginPath();
             ctx.moveTo(0, i*gridSize);
             ctx.lineTo(canvas.width, i*gridSize);
             ctx.stroke();
        }
        
        drawBonus(); 
        drawBomb(); 
        drawFood();
        drawSnake();
        updateAndDrawParticles(); 
        updateAndDrawPopups(); 
    }

    function clearCanvas() {
        ctx.fillStyle = "#FFFFFF"; 
        ctx.fillRect(0, 0, canvas.width, canvas.height);
    }

    function drawFood() {
        if (food.x < 0 || food.y < 0) return;

        // Bubble background
        ctx.fillStyle = "#FFE8D6"; // Very light orange/skin tone
        ctx.beginPath();
        ctx.arc(food.x * gridSize + gridSize/2, food.y * gridSize + gridSize/2, gridSize/1.5, 0, Math.PI*2);
        ctx.fill();

        ctx.fillStyle = "#E76F51"; // Accent Color (Muted Red)
        ctx.font = "bold 24px 'Noto Sans TC'"; // Increased font size here
        ctx.textAlign = "center";
        ctx.textBaseline = "middle";
        ctx.fillText(food.char, food.x * gridSize + gridSize/2, food.y * gridSize + gridSize/2 + 2);
    }

    function drawBonus() {
        if (bonusItem.active) {
            if (bonusItem.timer < 30 && bonusItem.timer % 6 < 3) return; 
            
            ctx.font = "26px Arial";
            ctx.textAlign = "center";
            ctx.textBaseline = "middle";
            ctx.fillText(bonusItem.icon, bonusItem.x * gridSize + gridSize/2, bonusItem.y * gridSize + gridSize/2 + 2);
        }
    }

    function drawBomb() {
        if (bombItem.active) {
            if (bombItem.timer < 30 && bombItem.timer % 6 < 3) return;
            ctx.font = "26px Arial";
            ctx.textAlign = "center";
            ctx.textBaseline = "middle";
            ctx.fillText("ğŸ’£", bombItem.x * gridSize + gridSize/2, bombItem.y * gridSize + gridSize/2 + 2);
        }
    }

    function moveSnake() {
        let newX = snake[0].x + dx;
        let newY = snake[0].y + dy;

        if (newX < 0) newX = tileCount - 1;
        else if (newX >= tileCount) newX = 0;

        if (newY < 0) newY = tileCount - 1;
        else if (newY >= tileCount) newY = 0;

        const head = { x: newX, y: newY };
        snake.unshift(head);

        if (bonusItem.active && head.x === bonusItem.x && head.y === bonusItem.y) {
            score += 100;
            scoreElement.innerText = score;
            bonusItem.active = false;
            playBonusSound();
            spawnParticles(head.x, head.y, "#FFD166");
            spawnPopup(head.x, head.y, "+100", "#E76F51"); 
        }

        if (bombItem.active && head.x === bombItem.x && head.y === bombItem.y) {
            score = Math.max(0, score - 50); 
            scoreElement.innerText = score;
            bombItem.active = false;
            comboCount = 0; // Reset combo on hit
            playBombSound();
            spawnParticles(head.x, head.y, "#555");
            spawnPopup(head.x, head.y, "-50", "#555");
            
            canvas.style.transform = "translateX(5px)";
            setTimeout(() => canvas.style.transform = "translateX(-5px)", 50);
            setTimeout(() => canvas.style.transform = "none", 100);
        }

        if (head.x === food.x && head.y === food.y && !isTransitioning) {
            // Combo Logic
            let points = 10;
            if (comboTimer > 0) {
                comboCount++;
                points += comboCount * 5; // Extra points for combo
                spawnPopup(head.x, head.y, `Combo x${comboCount}`, "#2A9D8F");
            } else {
                comboCount = 1;
            }
            comboTimer = 30; // Reset timer (approx 3-5s depending on speed)

            score += points;
            scoreElement.innerText = score;
            
            eatenSentenceChars.push(food.char);
            const audioText = getCorrectAudioText(food.char, charIndex, currentSentence);
            speakText(audioText);
            playEatSound();
            spawnParticles(head.x, head.y, "#E76F51");
            
            charIndex++;
            advanceToNextChar();
            updateSentenceDisplay();

            if (charIndex >= currentSentence.length) {
                score += 50; 
                isTransitioning = true;
                food.x = -1; 
                food.y = -1;
                sentencesCompleted++;
                updateProgressDisplay();
                playLevelUpSound();
                
                if (speed < 20) {
                    speed++;
                    levelElement.innerText = Math.floor((speed - initialSpeed) + 1);
                    levelElement.style.color = "#E76F51"; 
                    levelElement.style.transform = "scale(1.5)";
                    setTimeout(() => {
                        levelElement.style.color = "";
                        levelElement.style.transform = "scale(1)";
                    }, 500);
                    clearInterval(gameLoop);
                    gameLoop = setInterval(drawGame, 1000 / speed);
                }
                setTimeout(() => { if (isGameRunning) startNewSentence(); }, 1200); 
            } else {
                createFood();
            }
        } else {
            snake.pop(); 
        }
    }

    function drawSnake() {
        snake.forEach((part, index) => {
            if (index === 0) {
                ctx.fillStyle = "#2A9D8F"; 
            } else {
                ctx.fillStyle = "#F4A261"; 
            }
            
            let size = gridSize - 2;
            let radius = 6;
            let x = part.x * gridSize + 1;
            let y = part.y * gridSize + 1;
            
            ctx.beginPath();
            ctx.roundRect(x, y, size, size, radius);
            ctx.fill();

            if (index === 0) {
                ctx.fillStyle = "white";
                ctx.beginPath();
                let ex1, ey1, ex2, ey2;
                if (dx === 1) { 
                    ex1 = x + 20; ey1 = y + 8; ex2 = x + 20; ey2 = y + 20;
                } else if (dx === -1) { 
                    ex1 = x + 8; ey1 = y + 8; ex2 = x + 8; ey2 = y + 20;
                } else if (dy === 1) { 
                    ex1 = x + 8; ey1 = y + 20; ex2 = x + 20; ey2 = y + 20;
                } else { 
                    ex1 = x + 8; ey1 = y + 8; ex2 = x + 20; ey2 = y + 8;
                }
                ctx.arc(ex1, ey1, 4, 0, Math.PI * 2);
                ctx.arc(ex2, ey2, 4, 0, Math.PI * 2);
                ctx.fill();
            }
            else {
                let charIndexToDraw = -1;
                if (eatenSentenceChars.length <= snake.length - 1) {
                    charIndexToDraw = index - 1;
                } else {
                    let hiddenChars = eatenSentenceChars.length - (snake.length - 1);
                    charIndexToDraw = (index - 1) + hiddenChars;
                }

                if (charIndexToDraw >= 0 && charIndexToDraw < eatenSentenceChars.length) {
                    ctx.fillStyle = "#FFF";
                    ctx.font = "bold 18px 'Noto Sans TC'";
                    ctx.textAlign = "center";
                    ctx.textBaseline = "middle";
                    ctx.fillText(eatenSentenceChars[charIndexToDraw], x + size/2, y + size/2 + 2);
                }
            }
        });
    }

    function checkCollision() {
        const head = snake[0];
        for (let i = 1; i < snake.length; i++) {
            if (head.x === snake[i].x && head.y === snake[i].y) {
                return true;
            }
        }
        return false;
    }

    function handleCollision() {
        playCrashSound();
        lives--;
        updateLivesDisplay();
        comboCount = 0; // Reset combo
        
        canvas.style.transform = "translateX(5px)";
        setTimeout(() => canvas.style.transform = "translateX(-5px)", 50);
        setTimeout(() => canvas.style.transform = "none", 100);

        if (lives <= 0) {
            gameOver();
        } else {
            resetSnakePos();
            createFood(); 
            isPaused = true;
            setTimeout(() => {
                isPaused = false;
            }, 500);
        }
    }

    function gameOver() {
        isGameRunning = false;
        clearInterval(gameLoop);
        clearInterval(heartbeatInterval);
        gameOverTitle.innerText = `ğŸ˜² ${playerName}ï¼ŒéŠæˆ²çµæŸï¼`;
        gameOverName.innerText = playerName;
        finalScoreElement.innerText = score;
        const lessonName = lessonSelect.options[lessonSelect.selectedIndex].text;
        gameOverLesson.innerText = `ç·´ç¿’èª²ç¨‹ï¼š${lessonName}`;
        
        if(window.saveScoreToCloud) {
            window.saveScoreToCloud(playerName, score, lessonName);
        }

        gameOverScreen.classList.remove('hidden');
        if ('speechSynthesis' in window) window.speechSynthesis.cancel();
    }

    document.addEventListener('keydown', changeDirection);
    document.addEventListener('keydown', (e) => {
        if (e.code === 'KeyP') togglePause();
    });

    function changeDirection(event) {
        if (isPaused) return; 
        handleMove(event.keyCode);
    }
    
    function handleMove(key) {
        const goingUp = dy === -1;
        const goingDown = dy === 1;
        const goingRight = dx === 1;
        const goingLeft = dx === -1;

        if (key === 37 && !goingRight) { dx = -1; dy = 0; } 
        if (key === 38 && !goingDown) { dx = 0; dy = -1; } 
        if (key === 39 && !goingLeft) { dx = 1; dy = 0; }  
        if (key === 40 && !goingUp) { dx = 0; dy = 1; }    
    }

    let touchStartX = 0;
    let touchStartY = 0;
    document.addEventListener('touchstart', function(event) {
        if (event.target.tagName !== 'BUTTON' && event.target.tagName !== 'INPUT' && event.target.tagName !== 'SELECT') {
            event.preventDefault(); 
        }
        touchStartX = event.changedTouches[0].screenX;
        touchStartY = event.changedTouches[0].screenY;
    }, {passive: false});

    document.addEventListener('touchend', function(event) {
        if (isPaused || !isGameRunning) return;
        let touchEndX = event.changedTouches[0].screenX;
        let touchEndY = event.changedTouches[0].screenY;
        handleSwipeGesture(touchStartX, touchStartY, touchEndX, touchEndY);
    }, false);

    function handleSwipeGesture(startX, startY, endX, endY) {
        let xDiff = endX - startX;
        let yDiff = endY - startY;
        if (Math.abs(xDiff) > Math.abs(yDiff)) {
            if (Math.abs(xDiff) > 20) { 
                if (xDiff > 0) handleMove(39); 
                else handleMove(37); 
            }
        } else {
            if (Math.abs(yDiff) > 20) {
                if (yDiff > 0) handleMove(40); 
                else handleMove(38); 
            }
        }
    }

    window.addEventListener("keydown", function(e) {
        if(["Space","ArrowUp","ArrowDown","ArrowLeft","ArrowRight"].indexOf(e.code) > -1) {
            e.preventDefault();
        }
    }, false);

</script>
</body>
</html>